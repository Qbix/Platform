
/**
 * Adds WYSISWYG editor to a DOM element
 * @constructor
 * @param {DOMElement} el - DOM element
 * @param {json} options - JSON object with parameters
 *     @param {colors} [array] - Array of (strings) colors for colorpicker
 *     @param {fonts} [array] - Array of (strings) fonts for font choser
 * @returns {object} - HTMLeditor object
 */
function HTMLeditor(el,options) {
    var self={area:el};

    self.options={
        areaClass:'Q_HTMLeditor_area',
        areaContainerClass:'Q_HTMLeditor_container',
        tbClass:'Q_HTMLeditor_bar',
        tbInnerClass:'Q_HTMLeditor_bar_inner',
        btnClass:'Q_HTMLeditor_b',
        btnActiveClass:'Q_HTMLeditor_bactive',
        btnDisabledClass:'Q_HTMLeditor_bdisabled',
        btnContClass:'Q_HTMLeditor_cb',
        btnIconClass:'Q_HTMLeditor_bi',
        btnLabelClass:'Q_HTMLeditor_bl',
        groupClass:'Q_HTMLeditor_g',
        kbClass:'Q_HTMLeditor_kb',
        htmlClass:'Q_HTMLeditor_html',
        htmlModeClass:'Q_HTMLeditor_htmlmode',
        colorPickerClass:'Q_HTMLeditor_cp',
        dialogueClass:'Q_HTMLeditor_dia',
        dialogueBgClass:'Q_HTMLeditor_diabg',
        dialogueConClass:'Q_HTMLeditor_dia_con',
        imgDialogueClass:'Q_HTMLeditor_diaimg',
        hrefDialogueClass:'Q_HTMLeditor_diahref',
        recentLinksDialogue:'Q_HTMLeditor_diahref_recent_links',
        sizeDialogueClass:'Q_HTMLeditor_diasize',
        scrollableClass:'Q_HTMLeditor_scrollable',
        hiddenClass:'QHTMLeditor_hidden',
        resizeHandler:'Q_HTMLselector_resize-handler',
        resizeRightHandler:'Q_HTMLselector_resize-bottom-right',
        resizeLeftHandler:'Q_HTMLselector_resize-bottom-left',
        forceMobileMode:false,
        colors:[null, "#1abc9c" , "#2ecc71" , "#3498db" , "#9b59b6" , "#34495e" , "#16a085" , "#27ae60" , "#2980b9" , "#8e44ad" , "#2c3e50" , "#f1c40f" , "#e67e22" , "#e74c3c" , "#ecf0f1" , "#95a5a6" , "#f39c12" , "#d35400" , "#c0392b" , "#bdc3c7" ],
        fonts:["Arial","Arial Black","Bookman","Comic Sans MS","Courier","Courier New","Garamond","Georgia","Helvetica","Impact","Palatino","Times","Times New Roman","Trebuchet MS","Verdana"],
        iOSfixedToAbsolute:'auto', // Whether we should replace position: fixed to absolute when keyboard is shown could be true,false or 'auto'
        isCordova:false,
        toolbarFixed:true,
        toolbarIsStickyTo:'.composer-top', // element or false: whether toolbar should stick to element or always be on top while scrolling and editablearea is active
        useFormLabels:false,
        hideSubMenusOnSel:false,
        toDataUrlMethod: 'FileReader',// method of converting images to dataUrl (FileReader || Canvas)
        recentLinksStorage: 100,
        recentImagesStorage: 100,
        recentColorsStorage: 16,
        initianImgUrl: "https://images.google.com/",
        imgUrlChooser: {
            Web: {url:"https://images.google.com/", icon: 'chooseFromWeb'},
            Giphy: {url:"https://giphy.com/", icon: 'chooseGif'},
        },
        linksChooser: {
            Web: "https://google.com/",
        },
        initialHrefUrl: false
    }
    // Copy options
    if(typeof options!='undefined') {
        for (var param in options) {
            self.options[param]=options[param];
            switch(param) {
                case 'colors':
                    if(options[param][0]!=null) options[param].unshift(null);
                    break;
            }
        }
    }


    // Local variables

    //Q.Cordova = '123';
    var _width,
        _height,
        _barHeight=35,
        _latestTobarPosition = {top: null, left: null, position:null},
        _resizeTO,
        _touchInfo = {
            initX:null,
            prevX:null,
            initClientX:null,
            prevClientX:null,
            initY:null,
        },
        _isScrolling,
        _isVisualViewportScrolling,
        _visualViewportInfo = {
            prevOffsetTop: null
        },
        _scrollInertiaHandlerTimeout,
        _windowHeight = {initial:null, previous:null},
        _updateImageHandlersInterval,
        _container,
        _bar,
        _relativeParentContainer,
        _relativeToParentTop = 0,
        _barTopPosition,
        _elBarIsStickyTo,
        _toolbarObserver,
        _barVSstickElIntersObserver,
        _kb,
        _html,
        _activeGroup,
        _findAndReplace = {},
        _fixed=true,
        _isMobile=false,
        _isiOS=false,
        _keyboardVisible=false,
        _htmlMode=false,
        _btnCustomTouch,
        _currentFunc,
        _formatTags,
        _top=null,
        _debug=false,
        _errorDOM='HTMLeditor: Area should be added to DOM';


    var _buttons={
        htmleditor:{spec:'htmleditor', selOnly:1, kbOnly:1},
        undo:{spec:'undo'},
        redo:{spec:'redo'},

        /*special:{
            group:{
                firstname:{spec:'template',val:'{firstname}',tag:'{firstname}',label:'First Name'},
                lastname:{spec:'template',val:'{lastname}',tag:'{lastname}',label:'Last Name'},
                company:{spec:'template',val:'{company}',tag:'{company}',label:'Company'}
            },
            selOnly: 1,
            kbOnly: 1
        },*/

        text:{
            group:{
                bold:{tag:'STRONG'},
                italic:{tag:'I'},
                underline:{tag:'U'},
                strike:{tag:'DEL'},
                super:{tag:'SUP'},
                sub:{tag:'SUB'},
            },
            selOnly: 1,
            kbOnly: 1
        },

        color:{
            dropDialogue:{spec:'color', tag:'FONT'},
            selOnly:1,
            kbOnly: 1
        },
        font:{
            /*label:'FONT',*/
            group: {
                f0:{spec:'fontname',
                    val:null,
                    tag:'FONT',
                    par:'face',
                    label:'Default font'}
            },
            selOnly: 1,
            kbOnly: 1
        },
        size:{
            /*label:'SIZE',*/
            group: {
                fs10:{spec:'fontsize',val:1,tag:'FONT',par:'size',label:'10px'},
                fs14:{spec:'fontsize',val:2,tag:'FONT',par:'size',label:'14px'},
                fs16:{spec:'fontsize',val:3,tag:'FONT',par:'size',label:'16px'},
                fs19:{spec:'fontsize',val:4,tag:'FONT',par:'size',label:'19px'},
                fs24:{spec:'fontsize',val:5,tag:'FONT',par:'size',label:'24px'},
                fs32:{spec:'fontsize',val:6,tag:'FONT',par:'size',label:'32px'},
                fs48:{spec:'fontsize',val:7,tag:'FONT',par:'size',label:'48px'},
                fs:{spec:'customfontsize',tag:'FONT',par:'style',label:'Custom size'}
            },
            selOnly: 1,
            kbOnly: 1
        },

        format:{
            group: {
                left:{spec:'left'},
                center:{spec:'center'},
                right:{spec:'right'},
                justify:{spec:'justify'},
                ul:{spec:'ul',tag:'UL'},
                ol:{spec:'ol',tag:'OL'},
                p:{spec:'format',val:'P',tag:'P',label:'Normal text'},
                h1:{spec:'format',val:'H1',tag:'H1',label:'Heading 1'},
                h2:{spec:'format',val:'H2',tag:'H2',label:'Heading 2'},
                h3:{spec:'format',val:'H3',tag:'H3',label:'Heading 3'},
                h4:{spec:'format',val:'H4',tag:'H4',label:'Heading 4'},
                quote:{tag:'Q',label:'Quote'},
                code:{tag:'CODE',label:'Code'}
            },
            selOnly: 1,
            kbOnly: 1
        },

        link:{spec:'link', selOnly: 1, kbOnly: 1},
        img:{spec:'img', selOnly: 1, kbOnly: 1},
        find:{
            dropDialogue:{spec:'find'},
        },

        cut:{spec:'cut',selOnly:1, kbOnly: 1},
        copy:{spec:'copy',selOnly:1, kbOnly: 1},
        paste:{spec:'paste', kbOnly: 1},
        help:{spec:'help'},
        html:{spec:'html'},
    }

    var _icons={
        bold:'<svg xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" height="100" width="100" version="1.1"><path d="m 59.880895,48.704665 0,0 c 3.2289,-1.44036 5.006722,-4.07811 5.006722,-7.427703 3.97e-4,-7.202598 -4.525941,-11.169148 -12.743302,-11.169148 l -16.180237,0 c -0.438302,0 -0.794025,0.355723 -0.794025,0.794024 l 0,36.926117 c 0,0.438302 0.355723,0.794025 0.794025,0.794025 l 16.180634,0 c 9.35242,0 13.898607,-3.707698 13.898607,-11.334305 0,-2.187141 -1.506264,-7.162896 -6.162424,-8.58301 z m -7.736183,13.149446 -9.822085,0 0,-9.902679 9.822085,0 c 3.243988,0 6.691246,1.76075 6.691246,5.023001 3.97e-4,3.370634 -3.359916,4.879678 -6.691246,4.879678 z m 0,-16.285446 -9.822085,0 0,-8.858139 9.822085,0 c 5.136546,0 5.534749,3.621547 5.534749,4.731593 0,1.92154 -0.628867,4.126546 -5.534749,4.126546 z" id="path4198" /></svg>',
        italic:'<svg xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" version="1.1" width="100" height="100" viewBox="0 0 100 100" xml:space="preserve"><path d="m 55.91105,38.148378 c 0.680377,-3.192539 2.669172,-3.715906 6.123394,-3.820579 l 0.471031,-2.041132 -15.858021,0 -0.418693,2.041132 c 3.349549,0.104673 4.710303,0.523367 4.710303,2.669171 0,0.366357 -0.104674,1.151408 -0.261684,1.936458 L 45.496047,63.16532 c -0.680377,3.192539 -2.669172,3.715906 -6.123394,3.82058 l -0.47103,2.041131 15.85802,0 0.418694,-2.041131 c -3.349549,-0.104674 -4.710304,-0.523367 -4.710304,-2.669172 0,-0.366357 0.104674,-1.151408 0.261684,-1.936458 L 55.91105,38.148378 Z" /></g></svg>',
        underline:'<svg xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" version="1.1" x="0px" y="0px" width="100" height="100" viewBox="0 0 100 100" xml:space="preserve" > <g id="g4197"> <path d="m 38.071156,30.299305 3.964843,0 0,17.714844 q 0,4.6875 1.699219,6.757812 1.699219,2.050781 5.507813,2.050781 3.789062,0 5.488281,-2.050781 1.699219,-2.070312 1.699219,-6.757812 l 0,-17.714844 3.964843,0 0,18.203125 q 0,5.703125 -2.832031,8.613281 -2.8125,2.910156 -8.320312,2.910156 -5.527344,0 -8.359375,-2.910156 -2.8125,-2.910156 -2.8125,-8.613281 l 0,-18.203125 z" /> <path d="m 34.864864,65.675682 30,0 0,3.783784 -30,0 z" /> </g> </svg>',
        strike:'<svg xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" version="1.1" x="0px" y="0px" width="100" height="100" viewBox="0 0 100 100" xml:space="preserve" ><path d="m 23.78498,38.263125 -5.223645,14.164848 10.466355,0 -5.24271,-14.164848 z m -2.173341,-3.793815 4.365747,0 10.847643,28.463147 -4.003524,0 -2.592758,-7.301665 -12.83034,0 -2.592758,7.301665 -4.060717,0 10.866707,-28.463147 z" /><path d="m 44.813011,49.339541 0,10.428226 6.176865,0 q 3.107497,0 4.59452,-1.277315 1.506087,-1.296379 1.506087,-3.94633 0,-2.669016 -1.506087,-3.927266 -1.487023,-1.277315 -4.59452,-1.277315 l -6.176865,0 z m 0,-11.705541 0,8.57898 5.700255,0 q 2.821531,0 4.194168,-1.048542 1.391701,-1.067607 1.391701,-3.240948 0,-2.154277 -1.391701,-3.221884 Q 53.334797,37.634 50.513266,37.634 l -5.700255,0 z m -3.851009,-3.16469 9.83723,0 q 4.403876,0 6.786926,1.830182 2.38305,1.830183 2.38305,5.204581 0,2.611823 -1.220122,4.156039 -1.220121,1.544216 -3.584107,1.925504 2.840596,0.610061 4.403876,2.55463 1.582345,1.925504 1.582345,4.823292 0,3.81288 -2.592758,5.8909 -2.592758,2.078019 -7.377922,2.078019 l -10.218518,0 0,-28.463147 z" /><path d="m 88.394227,36.661716 0,4.060717 q -1.944569,-1.811118 -4.156039,-2.707145 -2.192406,-0.896027 -4.670778,-0.896027 -4.880486,0 -7.473244,2.993111 -2.592758,2.974046 -2.592758,8.617108 0,5.623998 2.592758,8.617108 2.592758,2.974046 7.473244,2.974046 2.478372,0 4.670778,-0.896026 2.21147,-0.896027 4.156039,-2.707145 l 0,4.022588 q -2.020826,1.372637 -4.28949,2.058955 -2.249599,0.686319 -4.766099,0.686319 -6.462831,0 -10.180389,-3.946331 -3.717558,-3.965395 -3.717558,-10.809514 0,-6.863183 3.717558,-10.809514 3.717558,-3.965395 10.180389,-3.965395 2.554629,0 4.804228,0.686319 2.268663,0.667254 4.251361,2.020826 z" /><path d="m 7.7297297,45.243244 83.7837833,0 0,4.594595 -83.7837833,0 z" /></svg>',
        super:'<svg xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" version="1.1" x="0px" y="0px" width="100" height="100" viewBox="0 0 100 100" xml:space="preserve"><path d="m 37.654663,37.866875 4.238281,0 7.246094,10.839843 7.285156,-10.839843 4.238282,0 -9.375,14.003906 10,15.15625 -4.238282,0 -8.203125,-12.402344 -8.261718,12.402344 -4.257813,0 10.410156,-15.566406 -9.082031,-13.59375 z" /><path d="m 70.083767,41.357437 10.025024,0 0,4.318237 -16.555786,0 0,-4.318237 8.31604,-7.339477 q 1.113892,-1.00708 1.647949,-1.968384 0.534058,-0.961304 0.534058,-1.998902 0,-1.602172 -1.083374,-2.578735 -1.068115,-0.976562 -2.853393,-0.976562 -1.373292,0 -3.005982,0.595092 -1.63269,0.579834 -3.494263,1.739502 l 0,-5.004882 q 1.983643,-0.656128 3.921509,-0.991822 1.937866,-0.350952 3.799439,-0.350952 4.089355,0 6.347656,1.800537 2.273559,1.800537 2.273559,5.020142 0,1.861572 -0.961303,3.479004 -0.961304,1.602173 -4.043579,4.302978 l -4.867554,4.272461 z" /></svg>',
        sub:'<svg xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" version="1.1" x="0px" y="0px" width="100" height="100" viewBox="0 0 100 100" xml:space="preserve" id="svg4194"><<path d="m 37.654663,33.866875 4.238281,0 7.246094,10.839843 7.285156,-10.839843 4.238282,0 -9.375,14.003906 10,15.15625 -4.238282,0 -8.203125,-12.402344 -8.261718,12.402344 -4.257813,0 10.410156,-15.566406 -9.082031,-13.59375 z" /><path d="m 70.354037,70.708788 10.025024,0 0,4.318237 -16.555786,0 0,-4.318237 8.31604,-7.339477 q 1.113892,-1.00708 1.647949,-1.968384 0.534058,-0.961304 0.534058,-1.998902 0,-1.602172 -1.083374,-2.578735 -1.068115,-0.976562 -2.853393,-0.976562 -1.373292,0 -3.005982,0.595092 -1.63269,0.579834 -3.494263,1.739502 l 0,-5.004882 q 1.983643,-0.656128 3.921509,-0.991822 1.937866,-0.350952 3.799439,-0.350952 4.089355,0 6.347656,1.800537 2.273559,1.800537 2.273559,5.020142 0,1.861572 -0.961303,3.479004 -0.961304,1.602173 -4.043579,4.302978 l -4.867554,4.272461 z" /></svg>',
        left:'<svg xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" viewBox="0 0 100 100" height="100" width="100" y="0px" x="0px" version="1.1"><rect transform="scale(1,-1)" y="-30.192371" x="28.036484" height="4.3117743" width="47.927032" /><rect width="29.727032" height="4.3117743" x="28.036484" y="-40.192371" transform="scale(1,-1)" /><rect transform="scale(1,-1)" y="-50.192371" x="28.036484" height="4.3117743" width="47.927032" /><rect width="36.527031" height="4.3117743" x="28.036484" y="-60.192371" transform="scale(1,-1)" /><rect transform="scale(1,-1)" y="-70.192368" x="28.036484" height="4.3117743" width="44.927032" /></svg>',
        right:'<svg xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" viewBox="0 0 100 100" height="100" width="100" y="0px" x="0px" version="1.1"><rect transform="scale(1,-1)" y="-30.192371" x="32.436485" height="4.3117743" width="43.527031" /><rect width="23.727034" height="4.3117743" x="52.236485" y="-40.192371" transform="scale(1,-1)" /><rect transform="scale(1,-1)" y="-50.192371" x="41.036484" height="4.3117743" width="34.927032" /><rect width="47.927032" height="4.3117743" x="28.036484" y="-60.192371" transform="scale(1,-1)" /><rect transform="scale(1,-1)" y="-70.192368" x="35.836483" height="4.3117743" width="40.127033" /></svg>',
        center:'<svg xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" viewBox="0 0 100 100" height="100" width="100" y="0px" x="0px" version="1.1"><rect transform="scale(1,-1)" y="-30.192371" x="28.036484" height="4.3117743" width="47.927032" /><rect width="32.127033" height="4.3117743" x="35.836483" y="-40.192371" transform="scale(1,-1)" /><rect transform="scale(1,-1)" y="-50.192371" x="29.836483" height="4.3117743" width="44.527035" /><rect width="27.927032" height="4.3117743" x="38.236485" y="-60.192371" transform="scale(1,-1)" /><rect transform="scale(1,-1)" y="-70.192368" x="28.036484" height="4.3117743" width="47.927032" /></svg>',
        justify:'<svg xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" version="1.1" x="0px" y="0px" width="100" height="100" viewBox="0 0 100 100" xml:space="preserve"><rect transform="scale(1,-1)" width="47.927032" height="4.3117743" x="28.036484" y="-30.192371" /><rect width="47.927032" height="4.3117743" x="28.036484" y="-70.192368" transform="scale(1,-1)" /><rect y="-40.149998" x="28.036484" height="4.3117743" width="19.96093" transform="scale(1,-1)" /><rect y="-39.938133" x="54.519535" height="4.3117743" width="21.443981" transform="scale(1,-1)" /><rect y="-50.107624" x="28.036484" height="4.3117743" width="34.155846" transform="scale(1,-1)" /><rect transform="scale(1,-1)" width="7.0372019" height="4.3117743" x="68.926315" y="-50.107624" /><rect y="-60.171185" x="28.036484" height="4.3117743" width="47.927032" transform="scale(1,-1)" /></svg>',
        ol:'<svg xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" viewBox="0 0 100 100" height="100" width="100" y="0px" x="0px" version="1.1"><rect transform="scale(1,-1)" y="-33.392372" x="36.436481" height="4.3117743" width="42.127033" /><path d="m 19.758107,29.477288 0,-1.313554 q 1.856109,-0.180852 2.589033,-0.599666 0.732925,-0.428333 1.094629,-2.008405 l 1.351628,0 0,13.573391 -1.827553,0 0,-9.651766 -3.207737,0 z" /><path d="m 30.409316,37.054019 1.989368,0 0,2.075035 -1.989368,0 0,-2.075035 z" /><rect width="42.127033" height="4.3117743" x="36.436481" y="-51.392372" transform="scale(1,-1)" /><path d="m 18.501664,56.521737 q 0.09518,-1.760923 0.723407,-3.064959 0.637739,-1.304035 2.47481,-2.370109 l 1.827554,-1.056554 q 1.227888,-0.713888 1.72285,-1.218368 0.780518,-0.790036 0.780518,-1.808517 0,-1.189813 -0.713888,-1.884664 -0.713889,-0.70437 -1.903702,-0.70437 -1.760924,0 -2.436737,1.33259 -0.361703,0.713889 -0.399777,1.979851 l -1.741887,0 q 0.02855,-1.779961 0.656777,-2.903145 1.113664,-1.979849 3.931143,-1.979849 2.341553,0 3.417144,1.265961 1.08511,1.265961 1.08511,2.817477 0,1.637184 -1.15174,2.798442 -0.666295,0.675814 -2.389145,1.637183 l -1.304036,0.723407 q -0.932813,0.513999 -1.465849,0.980406 -0.951851,0.828111 -1.199332,1.837072 l 7.443472,0 0,1.618146 -9.356692,0 z" /><path d="m 30.409316,54.446702 1.989368,0 0,2.075035 -1.989368,0 0,-2.075035 z" /><rect transform="scale(1,-1)" y="-69.392372" x="36.436481" height="4.3117743" width="42.127033" /><path d="m 22.956325,74.285645 q -2.4177,0 -3.512328,-1.323073 -1.08511,-1.332592 -1.08511,-3.236292 l 1.789479,0 q 0.114221,1.323072 0.494962,1.922738 0.666297,1.075592 2.408183,1.075592 1.351628,0 2.170219,-0.723407 0.818592,-0.723407 0.818592,-1.865628 0,-1.408739 -0.866185,-1.970331 -0.856664,-0.561592 -2.389145,-0.561592 -0.171333,0 -0.352185,0.0095 -0.171333,0 -0.352184,0.0095 l 0,-1.513441 q 0.266518,0.02855 0.44737,0.03808 0.180852,0.0095 0.390258,0.0095 0.96137,0 1.580073,-0.304592 1.08511,-0.533038 1.08511,-1.903702 0,-1.01848 -0.723407,-1.570554 -0.723407,-0.552074 -1.684776,-0.552074 -1.713331,0 -2.370108,1.142221 -0.361703,0.628222 -0.409295,1.78948 l -1.694295,0 q 0,-1.522961 0.609185,-2.589034 1.047036,-1.903702 3.683661,-1.903702 2.084554,0 3.226774,0.932814 1.142222,0.923295 1.142222,2.684219 0,1.256443 -0.675815,2.03696 -0.418814,0.485444 -1.08511,0.761482 1.075592,0.295074 1.675258,1.14222 0.609185,0.837629 0.609185,2.055998 0,1.951294 -1.284999,3.179181 -1.284998,1.227888 -3.645589,1.227888 z" /><path d="m 30.409317,71.839388 1.989367,0 0,2.075035 -1.989367,0 0,-2.075035 z" /></svg>',
        ul:'<svg xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" viewBox="0 0 100 100" height="100" width="100" y="0px" x="0px" version="1.1"><rect transform="scale(1,-1)" y="-33.392372" x="36.436481" height="4.3117743" width="42.127033" /><rect width="42.127033" height="4.3117743" x="36.436481" y="-51.392372" transform="scale(1,-1)" /><rect transform="scale(1,-1)" y="-69.392372" x="36.436481" height="4.3117743" width="42.127033" /><circle r="4.9000001" cy="30.299999" cx="21.299999" /><circle cx="21.299999" cy="48.299999" r="4.9000001" /><circle r="4.9000001" cy="66.300003" cx="21.299999" /></svg>',
        html:'<svg xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" viewBox="0 0 99.999998 99.999998" height="100" width="100" y="0px" x="0px" version="1.1"><path d="m 39.612863,46.198109 -13.891885,4.980109 13.891885,4.945163 0,4.351042 -18.470091,-7.251738 0,-4.123881 18.470091,-7.269212 0,4.368517 z" /><path d="m 56.842295,36.290312 3.861768,0 -13.734618,29.408858 -3.861768,0 13.734618,-29.408858 z" /><path d="m 64.198877,46.198109 0,-4.368517 18.470091,7.269212 0,4.123881 -18.470091,7.251738 0,-4.351042 13.891885,-4.945163 -13.891885,-4.980109 z" /></svg>',
        quote:'<svg xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" viewBox="0 0 99.999998 99.999998" height="100" width="100" y="0px" x="0px" version="1.1"><path d="m 30.759562,25.914139 q -2.408885,0.453847 -3.386403,3.491137 -0.48876,1.501188 -0.48876,2.967466 0,0.174564 0,0.314202 0.03491,0.104728 0.06982,0.523671 l 3.805339,0 0,7.610679 -7.436122,0 0,-7.017186 q 0,-5.166883 2.05977,-7.959793 2.059771,-2.79291 5.376352,-3.211846 l 0,3.28167 z m 11.765132,0 q -1.920126,0.314202 -2.932555,2.164504 -0.977519,1.850302 -0.977519,4.259188 0,0.209468 0,0.418937 0.03491,0.209467 0.104728,0.453847 l 3.805339,0 0,7.610679 -7.471033,0 0,-7.017186 q 0,-4.154454 1.745568,-7.401211 1.745569,-3.281668 5.725465,-3.770428 l 0,3.28167 z" /><path d="m 72.047716,69.202706 q 2.618352,-0.488758 3.456225,-3.84025 0.48876,-1.989948 0.349114,-3.456227 l -3.805339,0 0,-7.610678 7.471033,0 0,7.017185 q 0,4.154454 -1.710657,7.436123 -1.710657,3.246757 -5.760376,3.735517 l 0,-3.28167 z m -11.730222,0 q 2.618352,-0.488758 3.491138,-3.84025 0.488758,-1.989948 0.314202,-3.456227 l -3.80534,0 0,-7.610678 7.436122,0 0,7.017185 q 0,4.154454 -1.710656,7.401212 -1.710659,3.211846 -5.725466,3.770428 l 0,-3.28167 z" /></svg>',
        text:'<svg xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" viewBox="0 0 100 100" height="100" width="100" y="0px" x="0px" version="1.1"><<path d="m 62.331186,59.612787 -4.192318,0 -2.900846,-8.245554 -12.795511,0 -2.900845,8.245554 -3.99363,0 10.768893,-29.58465 5.245365,0 10.768892,29.58465 z M 54.026025,47.989536 48.840267,33.46544 43.63464,47.989536 l 10.391385,0 z" /><rect width="35.482723" height="4.2204123" x="30.415253" y="65.152466" /><path d="M 85.35793,40.74423 77.280325,51.957627 69.202719,40.744231 Z" /></svg>',
        format:' <svg xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" version="1.1" x="0px" y="0px" width="100" height="100" viewBox="0 0 100 100" xml:space="preserve" ><path d="M 85.35793,40.74423 77.280325,51.957627 69.202719,40.744231 Z" /><g transform="matrix(0.14729042,0,0,0.14684153,20.178056,28.46849)"><path d="M 285,0 165,0 115,0 C 68.131,0 30,38.132 30,85.002 30,131.87 68.131,170 115,170 l 35,0 0,145 c 0,8.284 6.716,15 15,15 8.284,0 15,-6.716 15,-15 l 0,-160 0,-125 30,0 0,285 c 0,8.284 6.716,15 15,15 8.284,0 15,-6.716 15,-15 l 0,-285 45,0 c 8.284,0 15,-6.716 15,-15 C 300,6.716 293.284,0 285,0 Z M 115,140 C 84.673,140 60,115.328 60,85.002 60,54.674 84.673,30 115,30 l 35,0 0,110 -35,0 z" /></svg>',
        keyboard:'<svg xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" version="1.1" x="0px" y="0px" width="100" height="100" viewBox="0 0 100 100" xml:space="preserve"><path d="M 40.818746,22.618729 51.233579,8.1607723 61.648414,22.618728 Z" style="opacity:1" id="path5394" /><path id="path4264" d="m 42.408095,62.986733 7.028669,0 0,-7.230437 -7.028669,0 z m 12.298198,-18.072034 -7.028669,0 0,7.230436 7.028669,0 z m -10.539059,0 -7.028668,0 0,7.230436 7.028668,0 z m 21.086006,0 -7.028668,0 0,7.230436 7.028668,0 z m -12.298198,18.072034 7.028669,0 0,-7.230437 -7.028669,0 z m -19.326866,-18.072034 -7.028669,0 0,7.230436 7.028669,0 z m 35.135454,7.230436 7.028669,0 0,-7.230436 -7.028669,0 z m 10.546948,-18.072033 -56.22935,0 c -3.865373,0 -7.028668,3.254102 -7.028668,7.230436 l 0,36.152183 c 0,3.976334 3.163295,7.230436 7.028668,7.230436 l 56.221461,0 c 3.865373,0 7.028669,-3.254102 7.028669,-7.230436 l 0,-36.152183 c 0.0079,-3.976334 -3.155407,-7.230436 -7.02078,-7.230436 z m 3.51039,43.374504 c 0,1.988167 -1.577704,3.61116 -3.51039,3.61116 l -56.22935,0 c -1.932686,0 -3.51039,-1.622993 -3.51039,-3.61116 l 0,-36.144068 c 0,-1.988167 1.577704,-3.611161 3.51039,-3.611161 l 56.221461,0 c 1.932687,0 3.51039,1.622994 3.51039,3.611161 l 0,36.144068 z m -19.326867,-14.460873 7.028669,0 0,-7.230437 -7.028669,0 z m -28.114675,10.849712 31.625065,0 0,-7.230437 -31.625065,0 z m 3.518279,-18.080149 -7.028669,0 0,7.230437 7.028669,0 z" /></svg>',
        link:'<svg xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" viewBox="0 0 100 100" height="100" width="100" y="0px" x="0px" version="1.1"><path d="m 38.924591,52.849753 c -1.524422,-5.9e-5 -2.760271,-1.235906 -2.760331,-2.760329 l 0,0 c 0,-1.524483 1.235909,-2.760391 2.760331,-2.760331 l 22.167564,0 c 1.524421,-6e-5 2.76033,1.235848 2.76033,2.760331 l 0,0 c -6e-5,1.524423 -1.235909,2.76027 -2.76033,2.760329 l -22.167564,0 z" /><path d="m 58.100665,45.460547 14.39135,-6.1e-5 c 0.763502,-6e-5 1.382567,0.619006 1.382567,1.382567 l 0,6.49262 c 0,0.763563 -0.619006,1.382569 -1.382567,1.382569 l -14.39141,0 c -0.470244,0 -0.884337,-0.235603 -1.133752,-0.594564 l -5.462527,0 c 0.413673,3.431286 3.359938,6.115224 6.897404,6.115224 l 14.212982,-6e-5 c 3.81775,-6.1e-5 6.950312,-3.125056 6.950312,-6.942866 l 0,-6.413345 c 1.2e-4,-3.817811 -3.132443,-6.942806 -6.950193,-6.942746 l -14.21286,-6e-5 c -3.537586,0 -6.483912,2.683879 -6.897524,6.115223 l 5.462526,0 c 0.249357,-0.358899 0.663388,-0.594562 1.133692,-0.594501 z" /><path d="m 41.576398,54.718182 -14.39153,0 c -0.763563,0 -1.382507,-0.618946 -1.382507,-1.382509 l 0,-6.492739 c 0,-0.763564 0.618944,-1.382508 1.382507,-1.382508 l 14.39153,0 c 0.470245,0 0.884276,0.235542 1.133632,0.594563 l 5.802207,0 C 48.098625,42.623643 45.15236,39.939825 41.614775,39.939825 l -14.212862,6e-5 c -3.817691,0 -6.950253,3.124996 -6.950253,6.942807 l 0,6.413344 c 0,3.81781 3.132443,6.942926 6.950253,6.942926 l 14.213042,0 c 3.537465,0 6.483792,-2.683878 6.897462,-6.115163 l -5.802206,0 c -0.249417,0.35884 -0.663448,0.594383 -1.133813,0.594383 z" /></svg>',
        img:'<svg xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg"   xml:space="preserve" viewBox="0 0 100 100" height="100" width="100" y="0px" x="0px" version="1.1"><path   d="m 68.423729,37.389829 0,28.271187 -37.694915,0 0,-28.271187 37.694915,0 m 0,-4.711864 -37.694915,0 c -2.591526,0 -4.711865,2.120339 -4.711865,4.711864 l 0,28.271187 c 0,2.591525 2.120339,4.711864 4.711865,4.711864 l 37.694915,0 c 2.591525,0 4.711864,-2.120339 4.711864,-4.711864 l 0,-28.271187 c 0,-2.591525 -2.120339,-4.711864 -4.711864,-4.711864 l 0,0 z" /><polygon transform="matrix(2.3559322,0,0,2.3559322,21.305085,23.254236)" points="8,10 12,13 14,12 18,14.4 18,16 6,16 6,12 "   /><circle cx="60.177967" cy="45.635593" r="3.5338984"   /></svg>',
        code:'<svg xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" viewBox="0 0 100 100" height="100" width="100" y="0px" x="0px" version="1.1"><path d="m 46.609761,63.284452 -21.675866,-10.971195 0,-6.075583 21.675866,-10.920984 0,7.155127 -15.119186,6.728331 15.119186,6.979388 0,7.104916 z" /><path d="m 54.508081,63.309558 0,-7.104916 15.140755,-6.929177 -15.140755,-6.853858 0,-7.054706 21.697435,10.920985 0,6.025371 -21.697435,10.996301 z" /></svg>',
        font:'<svg xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" viewBox="0 0 100 100" height="100" width="100" y="0px" x="0px" version="1.1"><path d="m 37.925359,67.379949 0.368478,-1.074444 c 1.096646,-0.698388 1.973,-1.504221 2.365513,-2.148886 0.453794,-0.698388 1.042962,-2.041443 1.614103,-3.70683 l 5.287656,-15.418264 -3.385687,0 0.865923,-2.524942 3.385687,0 1.123857,-3.277052 c 1.12346,-2.900997 2.564548,-5.103607 4.194694,-6.607827 1.734283,-1.557944 3.724913,-2.363776 5.696326,-2.363776 1.285704,0 2.320276,0.107444 3.109725,0.429778 0.348864,0.107444 1.297326,0.590944 2.747654,1.235609 l -1.787117,5.211051 -0.857136,0 -2.022717,-3.599386 c -0.489054,-0.698388 -1.107076,-1.020721 -1.749928,-1.020721 -1.928556,0 -3.61437,2.041443 -5.081875,6.070606 l -1.344944,3.921718 5.228529,0 -0.865923,2.524942 -5.228529,0 -5.287656,15.418264 c -0.57114,1.665387 -0.903167,3.008442 -0.928394,3.70683 -0.0068,0.644665 0.273977,1.450498 0.891603,2.148886 l -0.368478,1.074444 -7.971364,0 z" /></svg>',
        size:'<svg xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" viewBox="0 0 100 100" height="100" width="100" y="0px" x="0px" version="1.1"><<path d="M 35.872769,38.837989 30.968055,52.138 l 9.827329,0 -4.922615,-13.300011 z m -2.040648,-3.562183 4.099196,0 10.185338,26.725324 -3.759088,0 -2.434457,-6.85586 -12.046981,0 -2.434457,6.85586 -3.812789,0 10.203238,-26.725324 z" /><path d="m 57.017638,46.076471 -3.371992,9.143757 6.756289,0 -3.384297,-9.143757 z m -1.402946,-2.449001 2.818197,0 7.00242,18.37366 -2.584372,0 -1.67369,-4.713403 -8.282299,0 -1.673689,4.713403 -2.621293,0 7.014726,-18.37366 z" /><path d="m 71.505786,51.143408 -2.299085,6.23438 4.606561,0 -2.307476,-6.23438 z m -0.956554,-1.669774 1.921498,0 4.774377,12.527496 -1.762072,0 -1.141152,-3.213684 -5.647022,0 -1.141152,3.213684 -1.787245,0 4.782768,-12.527496 z" /></svg>',
        undo:'<svg xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" viewBox="0 0 100 100" height="100" width="100" y="0px" x="0px" version="1.1"><path d="m 50.606147,32.200361 c -5.480926,0 -10.634178,2.565968 -13.967533,6.818565 l -5.097147,-2.947018 -0.01066,16.869188 14.613671,-8.4253 -4.697596,-2.717825 c 2.30753,-2.584641 5.627497,-4.140729 9.159348,-4.140729 6.769282,0 12.279539,5.507614 12.279539,12.278174 0,6.77056 -5.510257,12.278175 -12.279539,12.278175 l 0,5.456966 c 9.780163,0 17.736505,-7.956343 17.736505,-17.735141 0,-9.778798 -7.956342,-17.735055 -17.73659,-17.735055 z" /></svg>',
        redo:'<svg xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" viewBox="0 0 100 100" height="100" width="100" y="0px" x="0px" version="1.1"><path d="m 49.267395,32.200361 c 5.480926,0 10.634178,2.565968 13.967533,6.818565 l 5.097147,-2.947018 0.01066,16.869188 -14.613671,-8.4253 4.697596,-2.717825 c -2.30753,-2.584641 -5.627497,-4.140729 -9.159348,-4.140729 -6.769282,0 -12.279539,5.507614 -12.279539,12.278174 0,6.77056 5.510257,12.278175 12.279539,12.278175 l 0,5.456966 c -9.780163,0 -17.736505,-7.956343 -17.736505,-17.735141 0,-9.778798 7.956342,-17.735055 17.73659,-17.735055 z" id="path4202" /></svg>',
        color:'<svg xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" version="1.1" x="0px" y="0px" width="100" height="100" viewBox="0 0 100 100" xml:space="preserve"><g class="ico-bg"><rect y="22.881355" x="22.881357" height="55.508469" width="55.932198" style="stroke:#999999;stroke-width:1.625;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1" /></g><g class="ico-fore"><path d="m 64.331186,63.612787 -4.192318,0 -2.900846,-8.245554 -12.795511,0 -2.900845,8.245554 -3.99363,0 10.768893,-29.58465 5.245365,0 10.768892,29.58465 z M 56.026025,51.989536 50.840267,37.46544 45.63464,51.989536 l 10.391385,0 z" /></g></svg>',
        forecolor:'<svg xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" version="1.1" x="0px" y="0px" width="100" height="100" viewBox="0 0 100 100" xml:space="preserve"><g class="ico-fore"><path d="m 64.331186,63.612787 -4.192318,0 -2.900846,-8.245554 -12.795511,0 -2.900845,8.245554 -3.99363,0 10.768893,-29.58465 5.245365,0 10.768892,29.58465 z M 56.026025,51.989536 50.840267,37.46544 45.63464,51.989536 l 10.391385,0 z" /></g></svg>',
        bgcolor:'<svg xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" version="1.1" x="0px" y="0px" width="100" height="100" viewBox="0 0 100 100" xml:space="preserve"><g class="ico-bg"><rect y="22.881355" x="22.881357" height="55.508469" width="55.932198" style="stroke:#999999;stroke-width:1.625;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1" /></g></svg>',
        special:'<svg version="1.1" id="Layer_1" xmlns:svg="http://www.w3.org/2000/svg"	 xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="100px" height="100px"	 viewBox="0 0 100 100" enable-background="new 0 0 100 100" xml:space="preserve"><path d="M36.377,76.739c-5.65-0.073-8.474-2.925-8.474-8.557v-8.278c0-3.716-1.436-5.664-4.305-5.85v-3.201	c2.87-0.185,4.305-2.172,4.305-5.961v-8.058c0-5.705,2.824-8.592,8.474-8.667v3.533c-2.926,0.073-4.39,1.896-4.39,5.465v8.085	c0,3.864-1.38,6.236-4.139,7.121v0.109c2.759,0.828,4.139,3.184,4.139,7.065v7.977c0,2.04,0.327,3.498,0.98,4.374	c0.653,0.871,1.79,1.326,3.41,1.367V76.739z"/><path d="M63.339,42.362l-9.495,11.384l9.33,11.118h-5.271l-5.545-7.295c-0.352-0.456-0.766-1.027-1.244-1.715h-0.11	c-0.093,0.131-0.524,0.704-1.298,1.715l-5.656,7.295h-5.216l9.631-11.03l-9.217-11.472h5.27l5.465,7.69	c0.405,0.572,0.801,1.16,1.187,1.758h0.111l7.063-9.449H63.339z"/><path d="M78.628,54.055c-2.871,0.186-4.306,2.134-4.306,5.85v8.278c0,5.632-2.814,8.483-8.444,8.557v-3.475	c1.601-0.041,2.735-0.499,3.408-1.383c0.671-0.882,1.007-2.336,1.007-4.358v-7.977c0-3.882,1.373-6.237,4.112-7.065v-0.109	c-2.739-0.885-4.112-3.257-4.112-7.121v-8.085c0-3.569-1.471-5.392-4.415-5.465v-3.533c5.63,0.075,8.444,2.962,8.444,8.667v8.058	c0,3.79,1.435,5.777,4.306,5.961V54.055z"/><path d="M99,40.744l-8.077,11.213l-8.077-11.213H99z"/></svg>',
        colorPicker:'<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 100 100" enable-background="new 0 0 100 100" xml:space="preserve"><path d="M81.274,68.663c0,17.169-13.918,31.087-31.087,31.087c-17.168,0-31.087-13.918-31.087-31.087S35.807,36.37,50.188,0.375		C61.297,31.72,81.274,51.494,81.274,68.663z"/>	<path fill="#FFFFFF" d="M38.663,73.411c-3.954-10.259-2.223-20.986,3.594-27.854c-10.835,5.815-15.946,18.667-11.46,30.307		c4.258,11.051,15.752,17.345,27.228,15.709C49.828,89.481,42.302,82.853,38.663,73.411z"/></svg>',
        resizeArrow:'<svg version="1.1" id="Layer_2" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="100px" height="100px" viewBox="0 0 100 100" enable-background="new 0 0 100 100" xml:space="preserve"><g><line fill="none" stroke="#000000" stroke-width="9" stroke-miterlimit="10" x1="11.588" y1="13.557" x2="86.059" y2="88.029"/><polygon points="92.953,94.937 90.993,40.921 81.991,41.242 83.609,85.593 39.263,83.967 38.943,92.969 			"/><polygon points="4.681,6.66 58.695,8.623 58.377,17.625 14.024,16.006 15.649,60.352 6.647,60.672 			"/></g></svg>',
        chooseFromWeb:'<svg xmlns:x="http://ns.adobe.com/Extensibility/1.0/" xmlns:i="http://ns.adobe.com/AdobeIllustrator/10.0/" xmlns:graph="http://ns.adobe.com/Graphs/1.0/" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0px" y="0px" viewBox="-949 951 100 125" style="enable-background:new -949 951 100 100;" xml:space="preserve"><switch><foreignObject requiredExtensions="http://ns.adobe.com/AdobeIllustrator/10.0/" x="0" y="0" width="1" height="1"/><g i:extraneous="self"><g><path d="M-893.6,1038.6l-1.9-5.4c-1.4,2.3-3,4.4-4.7,6.4c-0.1,0.2-0.3,0.3-0.4,0.5c-0.7,0-1.4,0.1-2.1,0.1c-0.7,0-1.4,0-2.1,0     c-0.1-0.2-0.3-0.3-0.4-0.5c-4.1-4.7-7.5-10.4-9.8-16.8c4-0.8,8.1-1.2,12.4-1.2c1.1,0,2.2,0,3.3,0.1l-1.9-5.6c-0.4,0-0.9,0-1.3,0     c-4.9,0-9.6,0.5-14.1,1.4c-1.2-4.5-2-9.3-2.2-14.4h13.1l-0.9-2.6c-0.3-0.9-0.5-1.9-0.5-2.9H-919c0.2-5,0.9-9.8,2.2-14.4     c4.5,0.9,9.2,1.4,14.1,1.4c4.8,0,9.6-0.5,14.1-1.4c0.9,3.2,1.5,6.6,1.9,10.1l5.7,2c-0.3-4.6-1.1-9.1-2.2-13.4     c4.3-1.2,8.4-2.9,12.2-4.9c0.1-0.1,0.3-0.1,0.4-0.2c4.3,5.9,7.1,13,7.6,20.8h-11.3l16.1,5.6c0.2,0.1,0.5,0.2,0.7,0.3     c0.1-1,0.1-2.1,0.1-3.2c0-25-20.3-45.3-45.3-45.3c-24.9,0-45.3,20.3-45.3,45.3c0,24.9,20.3,45.2,45.3,45.2     c4.8,0,9.5-0.8,13.8-2.2C-891,1042.6-892.8,1040.8-893.6,1038.6z M-874.4,972.6c-0.1,0.1-0.3,0.2-0.4,0.2     c-3.2,1.6-6.6,2.9-10.2,3.9c-1.9-5.2-4.3-9.9-7.3-14.1c-0.1-0.2-0.3-0.4-0.4-0.6C-885.6,963.8-879.4,967.6-874.4,972.6z      M-904.8,960.8c0.7,0,1.4-0.1,2.1-0.1c0.7,0,1.4,0,2.1,0.1c0.1,0.1,0.3,0.3,0.4,0.5c4.1,4.7,7.5,10.4,9.8,16.8     c-4,0.8-8.1,1.2-12.4,1.2c-4.3,0-8.4-0.4-12.4-1.2c2.4-6.4,5.7-12.1,9.8-16.8C-905.1,961.1-905,960.9-904.8,960.8z M-912.8,962     c-0.1,0.2-0.3,0.4-0.4,0.6c-3,4.2-5.4,9-7.3,14.2c-3.6-1-7-2.3-10.2-3.9c-0.1-0.1-0.3-0.1-0.4-0.2     C-926.1,967.6-919.8,963.8-912.8,962z M-934.7,976.9c0.1,0.1,0.3,0.1,0.4,0.2c3.8,2,7.9,3.6,12.2,4.9c-1.3,5-2.2,10.2-2.3,15.7     h-17.9C-941.8,989.9-939,982.8-934.7,976.9z M-934.7,1023.9c-4.3-5.9-7.1-13-7.6-20.7h17.9c0.2,5.4,1,10.7,2.3,15.7     c-4.3,1.2-8.4,2.9-12.2,4.9C-934.5,1023.7-934.6,1023.8-934.7,1023.9z M-931.1,1028.2c0.1-0.1,0.3-0.1,0.4-0.2     c3.2-1.6,6.6-2.9,10.2-3.9c1.9,5.2,4.3,9.9,7.3,14.2c0.1,0.2,0.3,0.4,0.4,0.6C-919.8,1036.9-926.1,1033.2-931.1,1028.2z"/><path d="M-850.6,1036l-18.6-18.6l9.1-4.6c1.5-0.8,1.4-3-0.2-3.6l-38-13.2c-1.5-0.5-3,0.9-2.5,2.5l13.2,38     c0.6,1.6,2.8,1.8,3.6,0.2l4.6-9.1l18.6,18.6c0.8,0.8,2,0.8,2.7,0l7.5-7.5C-849.8,1038-849.8,1036.8-850.6,1036z"/></g></g></switch></svg>',
        choosePhoto:'<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 90 122.5" version="1.1" x="0px" y="0px"><g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g transform="translate(-474.000000, -862.000000)" fill="#000000"><path d="M545.398929,898.126112 C546.128938,894.996766 544.112338,891.907033 540.926109,891.194018 C537.73988,890.481002 534.553651,892.461601 533.823641,895.590946 C533.137997,898.720291 535.154598,901.849636 538.340827,902.562652 C541.527056,903.236055 544.672953,901.255457 545.398929,898.126112 L545.398929,898.126112 Z M539.792779,928.785772 L526.487248,906.919968 L518.295817,912.307195 L512.286347,896.858529 L490.547392,917.85287 L505.107249,921.021827 L539.792779,928.785772 Z M522.893666,901.017785 C524.264954,901.334681 525.595911,900.502829 525.918567,899.156023 C526.200891,897.809216 525.353919,896.502021 523.98263,896.185125 C522.651674,895.907842 521.284419,896.739693 520.998061,898.0865 C520.675405,899.393694 521.522378,900.740501 522.893666,901.017785 L522.893666,901.017785 Z M556.24824,882.122878 L543.987308,936.034762 L485.747883,923.279709 L498.008815,869.328213 L556.24824,882.122878 Z M558.914186,880.657235 L496.51653,866.991108 L479.617417,941.342765 L542.01104,955.008892 L558.914186,880.657235 Z M563.955688,879.429264 L546.044241,958.217462 C545.842581,959.009701 545.281966,959.60388 544.551957,959.881164 C544.309964,959.960388 544.02764,960 543.789681,960 L543.745316,960 C543.583988,960 543.42266,960 543.265365,959.960388 L476.350524,945.264349 C475.422888,945.066289 474.737244,944.353274 474.575916,943.481811 C474.539617,943.164915 474.539617,942.848019 474.616248,942.570736 L492.527694,863.782538 C492.644657,863.188359 493.007645,862.673403 493.535995,862.356508 C493.858651,862.118836 494.257938,862.039612 494.620926,862.039612 C494.661258,862.039612 494.705623,862 494.782254,862 C494.943582,862 495.10491,862 495.266238,862.039612 L562.177046,876.696039 C562.786059,876.854487 563.306342,877.210994 563.633031,877.72595 C563.955688,878.240905 564.07265,878.835085 563.955688,879.429264 L563.955688,879.429264 Z M546.245901,866.159256 C546.165237,865.644301 545.923245,865.168957 545.519925,864.852061 C545.076273,864.495554 544.511625,864.337106 544.02764,864.41633 L520.921431,866.6346 L533.500985,869.407437 L542.41436,868.535974 L542.696684,871.427648 L546.850881,872.338723 L546.245901,866.159256 Z M490.144072,869.645109 L475.826208,871.031528 C474.700945,871.150364 473.894305,872.101051 474.011267,873.210186 L478.734146,919.912692 L481.513022,907.553759 L478.205797,874.794665 L489.216436,873.725141 L490.144072,869.645109 Z M494.705623,950.334681 L485.909211,951.166532 L485.63092,948.31447 L481.47269,947.403395 L482.07767,953.54325 C482.158334,954.058205 482.400326,954.533549 482.843978,954.850445 C483.166634,955.16734 483.650618,955.325788 484.09427,955.325788 L484.299964,955.325788 L507.285177,953.067906 L494.705623,950.334681 Z M554.312303,946.531932 C554.433299,947.601455 553.626659,948.591754 552.497363,948.670978 L549.153839,949.027486 L550.077442,944.947454 L550.117774,944.947454 L550.117774,944.828618 L552.900683,932.469685 L554.312303,946.531932 Z"/></g></g></svg>',
        chooseGif:'<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0px" y="0px" viewBox="0 0 64 80" enable-background="new 0 0 64 64" xml:space="preserve"><g display="none"><rect x="63.994" y="-188" display="inline" fill="#000000" width="20" height="430"/><rect x="206.494" y="-437.5" transform="matrix(1.067751e-10 -1 1 1.067751e-10 142.4944 290.4934)" display="inline" fill="#000000" width="20" height="1023"/><rect x="-222.026" y="-205.668" display="inline" fill="#000000" width="947.424" height="496.184"/></g><g display="none"><g display="inline"><g><path d="M30.091,27.387c-0.839,0.286-2.427,0.679-4.016,0.679c-2.196,0-3.785-0.554-4.891-1.625     c-1.108-1.035-1.714-2.606-1.696-4.374c0.017-3.999,2.927-6.283,6.872-6.283c1.554,0,2.749,0.304,3.339,0.59l-0.571,2.177     c-0.661-0.286-1.483-0.517-2.802-0.517c-2.267,0-3.981,1.285-3.981,3.891c0,2.481,1.552,3.945,3.783,3.945     c0.625,0,1.125-0.071,1.34-0.179v-2.516H25.61V21.05h4.481V27.387z"/></g><g><path d="M34.774,15.909v12.032h-2.731V15.909H34.774z"/></g><g><path d="M36.954,15.909h7.353v2.231h-4.622v2.75h4.32v2.214h-4.32v4.837h-2.731V15.909z"/></g></g><g display="inline"><g><path d="M49.621,2C52.587,2,55,4.413,55,7.379v49.241C55,59.587,52.587,62,49.621,62H14.379C11.413,62,9,59.587,9,56.621V7.379     C9,4.413,11.413,2,14.379,2H49.621 M49.621,0H14.379C10.304,0,7,3.304,7,7.379v49.241C7,60.696,10.304,64,14.379,64h35.241     C53.696,64,57,60.696,57,56.621V7.379C57,3.304,53.696,0,49.621,0L49.621,0z"/></g></g><g display="inline"><g><g><line fill="none" stroke="#000000" stroke-width="2" stroke-miterlimit="10" x1="14.293" y1="41.428" x2="49.578" y2="41.428"/></g><g><line fill="none" stroke="#000000" stroke-width="2" stroke-miterlimit="10" x1="14.293" y1="46.332" x2="49.578" y2="46.332"/></g><g><line fill="none" stroke="#000000" stroke-width="2" stroke-miterlimit="10" x1="14.293" y1="51.235" x2="49.578" y2="51.235"/></g></g></g></g><g display="none"><g display="inline"><g><path d="M30.091,27.387c-0.839,0.286-2.427,0.679-4.016,0.679c-2.196,0-3.785-0.554-4.891-1.625     c-1.108-1.035-1.714-2.606-1.696-4.374c0.017-3.999,2.927-6.283,6.872-6.283c1.554,0,2.749,0.304,3.339,0.59l-0.571,2.177     c-0.661-0.286-1.483-0.517-2.802-0.517c-2.267,0-3.981,1.285-3.981,3.891c0,2.481,1.552,3.945,3.783,3.945     c0.625,0,1.125-0.071,1.34-0.179v-2.516H25.61V21.05h4.481V27.387z"/></g><g><path d="M34.774,15.909v12.032h-2.731V15.909H34.774z"/></g><g><path d="M36.954,15.909h7.353v2.231h-4.622v2.75h4.32v2.214h-4.32v4.837h-2.731V15.909z"/></g></g><g display="inline"><g><path d="M49.621,1C53.138,1,56,3.862,56,7.379v49.241C56,60.138,53.138,63,49.621,63H14.379C10.862,63,8,60.138,8,56.621V7.379     C8,3.862,10.862,1,14.379,1H49.621 M49.621,0H14.379C10.304,0,7,3.304,7,7.379v49.241C7,60.696,10.304,64,14.379,64h35.241     C53.696,64,57,60.696,57,56.621V7.379C57,3.304,53.696,0,49.621,0L49.621,0z"/></g></g><g display="inline"><g><g><line fill="none" stroke="#000000" stroke-miterlimit="10" x1="14.293" y1="41.428" x2="49.578" y2="41.428"/></g><g><line fill="none" stroke="#000000" stroke-miterlimit="10" x1="14.293" y1="46.332" x2="49.578" y2="46.332"/></g><g><line fill="none" stroke="#000000" stroke-miterlimit="10" x1="14.293" y1="51.235" x2="49.578" y2="51.235"/></g></g></g></g><g><g><path d="M26.075,27.552c1.589,0,3.177-0.392,4.016-0.679v-6.337H25.61v2.125h1.858v2.516c-0.215,0.108-0.715,0.179-1.34,0.179    c-2.231,0-3.783-1.464-3.783-3.945c0-2.606,1.714-3.891,3.981-3.891c1.32,0,2.141,0.231,2.802,0.517l0.571-2.177    c-0.59-0.286-1.785-0.59-3.339-0.59c-3.945,0-6.855,2.285-6.872,6.283c-0.017,1.767,0.589,3.339,1.696,4.374    C22.29,26.998,23.879,27.552,26.075,27.552z"/><rect x="32.043" y="15.395" width="2.731" height="12.032"/><polygon points="39.685,22.59 44.005,22.59 44.005,20.376 39.685,20.376 39.685,17.626 44.307,17.626 44.307,15.395     36.954,15.395 36.954,27.427 39.685,27.427   "/><path d="M51.121,0H12.879C8.804,0,5.5,3.304,5.5,7.379v49.241C5.5,60.696,8.804,64,12.879,64h38.242    c4.075,0,7.379-3.304,7.379-7.379V7.379C58.5,3.304,55.196,0,51.121,0z M54.5,56.621c0,1.863-1.516,3.379-3.379,3.379H12.879    C11.016,60,9.5,58.484,9.5,56.621V7.379C9.5,5.516,11.016,4,12.879,4h38.242C52.984,4,54.5,5.516,54.5,7.379V56.621z"/><rect x="15" y="38.699" width="34" height="4"/><rect x="15" y="44.602" width="34" height="4"/><rect x="15" y="50.505" width="34" height="4"/></g></g><g display="none"><g display="inline"><g><path d="M30.091,27.387c-0.839,0.286-2.427,0.679-4.016,0.679c-2.196,0-3.785-0.554-4.891-1.625     c-1.108-1.035-1.714-2.606-1.696-4.374c0.017-3.999,2.927-6.283,6.872-6.283c1.554,0,2.749,0.304,3.339,0.59l-0.571,2.177     c-0.661-0.286-1.483-0.517-2.802-0.517c-2.267,0-3.981,1.285-3.981,3.891c0,2.481,1.552,3.945,3.783,3.945     c0.625,0,1.125-0.071,1.34-0.179v-2.516H25.61V21.05h4.481V27.387z"/></g><g><path d="M34.774,15.909v12.032h-2.731V15.909H34.774z"/></g><g><path d="M36.954,15.909h7.353v2.231h-4.622v2.75h4.32v2.214h-4.32v4.837h-2.731V15.909z"/></g></g><g display="inline"><g><path d="M55,2v54.621C55,59.587,52.587,62,49.621,62H9V7.379C9,4.413,11.413,2,14.379,2H55 M57,0H14.379     C10.304,0,7,3.304,7,7.379V64h42.621C53.696,64,57,60.696,57,56.621V0L57,0z"/></g></g><g display="inline"><g><g><line fill="none" stroke="#000000" stroke-width="2" stroke-miterlimit="10" x1="14.293" y1="41.428" x2="49.578" y2="41.428"/></g><g><line fill="none" stroke="#000000" stroke-width="2" stroke-miterlimit="10" x1="14.293" y1="46.332" x2="49.578" y2="46.332"/></g><g><line fill="none" stroke="#000000" stroke-width="2" stroke-miterlimit="10" x1="14.293" y1="51.235" x2="49.578" y2="51.235"/></g></g></g></g><g display="none"><g display="inline"><g><path d="M30.091,27.387c-0.839,0.286-2.427,0.679-4.016,0.679c-2.196,0-3.785-0.554-4.891-1.625     c-1.108-1.035-1.714-2.606-1.696-4.374c0.017-3.999,2.927-6.283,6.872-6.283c1.554,0,2.749,0.304,3.339,0.59l-0.571,2.177     c-0.661-0.286-1.483-0.517-2.802-0.517c-2.267,0-3.981,1.285-3.981,3.891c0,2.481,1.552,3.945,3.783,3.945     c0.625,0,1.125-0.071,1.34-0.179v-2.516H25.61V21.05h4.481V27.387z"/></g><g><path d="M34.774,15.909v12.032h-2.731V15.909H34.774z"/></g><g><path d="M36.954,15.909h7.353v2.231h-4.622v2.75h4.32v2.214h-4.32v4.837h-2.731V15.909z"/></g></g><g display="inline"><g><line fill="none" stroke="#000000" stroke-miterlimit="10" x1="7" y1="58.727" x2="7" y2="5.273"/><line fill="none" stroke="#000000" stroke-miterlimit="10" x1="57" y1="5.273" x2="57" y2="58.727"/></g><g><g><g><path d="M58.754,1v3.582H5.246V1H58.754 M59.754,0H4.246v5.582h55.507V0L59.754,0z"/></g></g><g><g><path d="M58.754,59.418V63H5.246v-3.582H58.754 M59.754,58.418H4.246V64h55.507V58.418L59.754,58.418z"/></g></g></g></g><g display="inline"><g><g><line fill="none" stroke="#000000" stroke-miterlimit="10" x1="14.293" y1="39.428" x2="49.578" y2="39.428"/></g><g><line fill="none" stroke="#000000" stroke-miterlimit="10" x1="14.293" y1="44.332" x2="49.578" y2="44.332"/></g><g><line fill="none" stroke="#000000" stroke-miterlimit="10" x1="14.293" y1="49.235" x2="49.578" y2="49.235"/></g></g></g></g></svg>',
        help:'<span>Tap here for instructions</span>',
        find:'<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="300px" height="300px" viewBox="0 0 300 300" enable-background="new 0 0 300 300" xml:space="preserve"><g><path d="M72.162,42.162c-27.345,27.345-27.345,71.838,0,99.188c27.345,27.345,71.843,27.345,99.188,0 c27.346-27.35,27.346-71.844,0-99.188C144.005,14.814,99.509,14.814,72.162,42.162z M85.356,55.356 c20.066-20.066,52.728-20.066,72.799,0.003c20.066,20.071,20.066,52.727,0,72.795c-20.071,20.072-52.732,20.072-72.799,0 C65.286,108.081,65.286,75.428,85.356,55.356z"/><path d="M245.333,215.333c4.022-4.026,4.022-10.552-0.005-14.574l-62.829-62.84c-2.034,2.731-4.274,5.351-6.751,7.827 c-2.473,2.473-5.098,4.719-7.826,6.749l62.835,62.836C234.781,219.353,241.304,219.353,245.333,215.333z"/><path d="M93.815,63.704l4.4,4.398c12.678-12.682,33.074-12.97,46.15-0.948l4.401-4.396 C133.264,48.311,108.917,48.599,93.815,63.704z"/></g></svg>',
        arrowUp:'<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0px" y="0px" viewBox="0 0 100 69.08875" enable-background="new 0 0 100 55.271" xml:space="preserve"><path fill="#000000" d="M94.729,55.271c-1.349,0-2.697-0.515-3.727-1.544L50,12.725L8.998,53.727c-2.059,2.059-5.395,2.059-7.454,0  c-2.059-2.059-2.059-5.395,0-7.454L46.273,1.544c2.059-2.059,5.395-2.059,7.454,0l44.729,44.729c2.059,2.059,2.059,5.395,0,7.454  C97.426,54.757,96.077,55.271,94.729,55.271z"/></svg>',
        arrowDown:'<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0px" y="0px" viewBox="0 0 100 69.08875" enable-background="new 0 0 100 55.271" xml:space="preserve"><path fill="#000000" d="M50,55.271c-1.349,0-2.697-0.515-3.727-1.544L1.544,8.998c-2.059-2.059-2.059-5.395,0-7.454  s5.395-2.059,7.454,0L50,42.546L91.002,1.544c2.059-2.059,5.395-2.059,7.454,0c2.059,2.059,2.059,5.395,0,7.454L53.727,53.727  C52.697,54.757,51.349,55.271,50,55.271z"/></svg>',
        threeDots:'<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 100 125" version="1.1" x="0px" y="0px"><title>slice-1</title><desc>Created with Sketch.</desc><g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><path d="M85.124,40 C79.67,40 75.248,44.422 75.248,49.876 C75.248,55.331 79.67,59.752 85.124,59.752 C90.578,59.752 95,55.331 95,49.876 C95,44.422 90.578,40 85.124,40 M50,40 C44.546,40 40.124,44.422 40.124,49.876 C40.124,55.331 44.546,59.752 50,59.752 C55.455,59.752 59.876,55.331 59.876,49.876 C59.876,44.422 55.455,40 50,40 M24.753,49.876 C24.753,55.331 20.331,59.752 14.876,59.752 C9.422,59.752 5,55.331 5,49.876 C5,44.422 9.422,40 14.876,40 C20.331,40 24.753,44.422 24.753,49.876" fill="#000000"/></g></svg>',
        htmleditor:'<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"    width="42px" height="42px" viewBox="0 0 42 42" enable-background="new 0 0 42 42" xml:space="preserve">  <g>   <defs>    <path id="SVGID_1_" d="M9.998,1.71h22.399c4.64,0,8.4,3.761,8.4,8.4v22.4c0,4.64-3.761,8.4-8.4,8.4H9.998     c-4.639,0-8.4-3.761-8.4-8.4v-22.4C1.598,5.471,5.359,1.71,9.998,1.71z"/>   </defs>   <clipPath id="SVGID_2_">    <use xlink:href="#SVGID_1_"  overflow="visible"/>   </clipPath>   <g clip-path="url(#SVGID_2_)">    <defs>     <rect id="SVGID_3_" x="1.598" y="1.71" width="40" height="40"/>    </defs>    <clipPath id="SVGID_4_">     <use xlink:href="#SVGID_3_"  overflow="visible"/>    </clipPath>    <g clip-path="url(#SVGID_4_)" enable-background="new    ">     <g>      <defs>       <rect id="SVGID_5_" x="-5.402" y="-5.29" width="53" height="53"/>      </defs>      <clipPath id="SVGID_6_">       <use xlink:href="#SVGID_5_"  overflow="visible"/>      </clipPath>      <g clip-path="url(#SVGID_6_)">       <defs>        <rect id="SVGID_7_" x="1.598" y="1.71" width="40" height="40"/>       </defs>       <clipPath id="SVGID_8_">        <use xlink:href="#SVGID_7_"  overflow="visible"/>       </clipPath>       <rect x="-3.402" y="-3.29" clip-path="url(#SVGID_8_)" fill="#D8D8D8" width="49.2" height="49.2"/>      </g>      <g clip-path="url(#SVGID_6_)">       <defs>        <path id="SVGID_9_" d="M20.669,19.692l26.194,0.563l0.063,25.713c0,0-7.667,0.961-14.688,1.313         c-5.957,0.3-11.569-0.188-11.569-0.188V19.692z"/>       </defs>       <clipPath id="SVGID_10_">        <use xlink:href="#SVGID_9_"  overflow="visible"/>       </clipPath>       <g clip-path="url(#SVGID_10_)">        <defs>         <rect id="SVGID_11_" x="1.598" y="1.71" width="40" height="40"/>        </defs>        <clipPath id="SVGID_12_">         <use xlink:href="#SVGID_11_"  overflow="visible"/>        </clipPath>        <rect x="1.598" y="1.71" clip-path="url(#SVGID_12_)" fill="#2F38CF" width="40" height="40"/>       </g>      </g>      <g clip-path="url(#SVGID_6_)">       <defs>        <path id="SVGID_13_" d="M20.669-4.979h26.258v25.544c0,0-7.326,1.741-14.148,2.088c-5.789,0.294-12.109-0.491-12.109-0.491         V-4.979z"/>       </defs>       <clipPath id="SVGID_14_">        <use xlink:href="#SVGID_13_"  overflow="visible"/>       </clipPath>       <g clip-path="url(#SVGID_14_)">        <defs>         <rect id="SVGID_15_" x="1.598" y="1.71" width="40" height="40"/>        </defs>        <clipPath id="SVGID_16_">         <use xlink:href="#SVGID_15_"  overflow="visible"/>        </clipPath>        <rect x="1.598" y="1.71" clip-path="url(#SVGID_16_)" fill="#D72223" width="40" height="40"/>       </g>      </g>      <g clip-path="url(#SVGID_6_)">       <defs>        <path id="SVGID_17_" d="M-5.091-4.979h26.258v27.386c0,0-8.148-0.101-14.987,0.246c-5.803,0.294-11.271-0.491-11.271-0.491         V-4.979z"/>       </defs>       <clipPath id="SVGID_18_">        <use xlink:href="#SVGID_17_"  overflow="visible"/>       </clipPath>       <g clip-path="url(#SVGID_18_)">        <defs>         <rect id="SVGID_19_" x="1.598" y="1.71" width="40" height="40"/>        </defs>        <clipPath id="SVGID_20_">         <use xlink:href="#SVGID_19_"  overflow="visible"/>        </clipPath>        <rect x="1.598" y="1.71" clip-path="url(#SVGID_20_)" fill="#F4AD2D" width="40" height="40"/>       </g>      </g>      <g clip-path="url(#SVGID_6_)">       <defs>        <path id="SVGID_21_" d="M-5.06,16.861c0,0,6.305,3.135,13.114,4.524c6.706,1.368,13.052,0.992,13.052,0.992l0.062,24.85         c0,0-7.056,0.063-14.324,0.213C0.68,47.568-5.072,45.353-5.066,46.244C-5.06,47.254-5.06,16.861-5.06,16.861z"/>       </defs>       <clipPath id="SVGID_22_">        <use xlink:href="#SVGID_21_"  overflow="visible"/>       </clipPath>       <g clip-path="url(#SVGID_22_)">        <defs>         <rect id="SVGID_23_" x="1.598" y="1.71" width="40" height="40"/>        </defs>        <clipPath id="SVGID_24_">         <use xlink:href="#SVGID_23_"  overflow="visible"/>        </clipPath>        <rect x="1.598" y="1.71" clip-path="url(#SVGID_24_)" fill="#41B636" width="40" height="40"/>       </g>      </g>      <g display="none" clip-path="url(#SVGID_6_)">       <defs>        <rect id="SVGID_25_" x="1.598" y="1.71" width="40" height="40"/>       </defs>       <clipPath id="SVGID_26_" display="inline">        <use xlink:href="#SVGID_25_"  overflow="visible"/>       </clipPath>       <path display="inline" clip-path="url(#SVGID_26_)" fill="#FFFFFF" d="M12.155,15.149l1.707,1.707L9.567,21.15l4.294,4.293        l-1.707,1.735l-5.147-5.176c-0.247-0.228-0.37-0.512-0.37-0.853s0.123-0.625,0.37-0.853L12.155,15.149z M16.108,30.449        l2.275,0.824l7.905-21.84l-2.274-0.825L16.108,30.449z M35.389,20.297c0.246,0.228,0.369,0.512,0.369,0.853        s-0.113,0.625-0.342,0.853l-5.176,5.176l-1.705-1.735l4.293-4.293l-4.293-4.294l1.705-1.707L35.389,20.297z"/>      </g>     </g>    </g>   </g>  </g>  <g>   <path fill-rule="evenodd" clip-rule="evenodd" fill="#030302" d="M30.514,22.072c-0.624-0.824-1.25-1.647-1.875-2.471    c-0.211-0.277-0.425-0.552-0.631-0.832c-0.255-0.345-0.165-0.75,0.177-1.001c0.491-0.36,0.96-0.752,1.453-1.114    c0.186-0.136,0.34-0.326,0.595-0.366c0.276-0.045,0.502,0.033,0.664,0.244c1.199,1.561,2.393,3.127,3.584,4.692    c0.363,0.474,0.724,0.95,1.086,1.423c0.315,0.411,0.26,0.864-0.146,1.185c-0.138,0.11-0.277,0.217-0.417,0.326    c-0.171,0.128-0.342,0.256-0.514,0.385c-1.155,0.88-2.311,1.761-3.467,2.642c-0.539,0.411-1.092,0.81-1.619,1.237    c-0.334,0.271-0.826,0.3-1.122-0.131c-0.413-0.604-0.886-1.166-1.332-1.747c-0.237-0.308-0.186-0.728,0.12-0.961    c1.222-0.931,2.442-1.864,3.674-2.783c0.18-0.136,0.204-0.229,0.049-0.389C30.688,22.31,30.606,22.187,30.514,22.072z     M35.14,23.128c-0.022-0.029-0.045-0.059-0.067-0.087c-1.536-2.016-3.076-4.031-4.611-6.049c-0.072-0.094-0.111-0.079-0.191-0.018    c-0.555,0.428-1.109,0.854-1.67,1.274c-0.103,0.077-0.115,0.121-0.035,0.225c1.063,1.385,2.121,2.774,3.185,4.159    c0.08,0.103,0.059,0.142-0.034,0.211c-1.396,1.059-2.788,2.12-4.184,3.178c-0.081,0.061-0.107,0.095-0.035,0.189    c0.438,0.564,0.871,1.136,1.302,1.708c0.063,0.085,0.101,0.082,0.18,0.022c2.013-1.534,4.025-3.068,6.043-4.594    C35.107,23.282,35.068,23.185,35.14,23.128z"/>   <path fill-rule="evenodd" clip-rule="evenodd" fill="#030302" d="M12.179,20.534c-0.219,0.143-0.434,0.292-0.658,0.426    c-0.113,0.067-0.101,0.122-0.038,0.217c0.856,1.287,1.709,2.577,2.561,3.866c0.26,0.395,0.19,0.76-0.201,1.023    c-0.589,0.397-1.19,0.777-1.772,1.184c-0.401,0.278-0.86,0.172-1.121-0.238c-0.773-1.217-1.582-2.409-2.377-3.612    c-0.233-0.352-0.472-0.702-0.707-1.053c-0.374-0.571-0.747-1.144-1.125-1.712c-0.204-0.307-0.125-0.811,0.177-1.021    c0.274-0.189,0.556-0.37,0.833-0.556c0.045-0.031,0.105-0.049,0.123-0.112c0.379-0.178,0.708-0.437,1.055-0.665    c1.388-0.909,2.772-1.826,4.154-2.746c0.169-0.112,0.326-0.239,0.523-0.309c0.312-0.112,0.642,0.063,0.785,0.289    c0.4,0.626,0.817,1.241,1.223,1.863c0.267,0.409,0.198,0.741-0.199,1.017c-0.052,0.036-0.101,0.075-0.151,0.112    C14.235,19.183,13.207,19.858,12.179,20.534z M11.601,26.792c0.032-0.021,0.063-0.04,0.093-0.061    c0.588-0.39,1.175-0.781,1.767-1.164c0.107-0.069,0.104-0.112,0.038-0.21c-0.968-1.458-1.932-2.921-2.901-4.378    c-0.063-0.094-0.062-0.132,0.04-0.198c1.456-0.953,2.906-1.915,4.363-2.867c0.13-0.085,0.13-0.136,0.048-0.257    c-0.386-0.572-0.766-1.147-1.139-1.728c-0.069-0.108-0.114-0.104-0.212-0.039c-2.093,1.384-4.187,2.764-6.283,4.142    c-0.156,0.103-0.18,0.211-0.077,0.363c0.19,0.282,0.375,0.566,0.563,0.85c1.199,1.813,2.398,3.625,3.599,5.438    C11.526,26.724,11.538,26.781,11.601,26.792z"/>   <path fill-rule="evenodd" clip-rule="evenodd" fill="#030302" d="M21.619,15.376c0.312-0.488,0.622-0.979,0.938-1.465    c0.331-0.51,0.604-1.063,1.083-1.463c1.333-1.113,3.342-0.692,4.17,0.889c0.489,0.934,0.519,1.891,0.034,2.84    c-0.392,0.768-0.901,1.465-1.354,2.196c-0.839,1.354-1.692,2.698-2.539,4.046c-0.734,1.16-1.469,2.322-2.203,3.483    c-0.056,0.088-0.105,0.179-0.158,0.269c-0.436,0.695-0.874,1.388-1.308,2.084c-0.049,0.079-0.108,0.136-0.189,0.18    c-0.944,0.495-1.888,0.991-2.831,1.488c-0.515,0.271-1.027,0.547-1.542,0.814c-0.295,0.155-0.555-0.012-0.54-0.356    c0.023-0.537,0.064-1.074,0.097-1.611c0.074-1.194,0.149-2.388,0.223-3.583c0.005-0.08,0.028-0.151,0.072-0.221    c0.715-1.124,1.428-2.25,2.142-3.375c0.005-0.009,0.006-0.02,0.009-0.03c0.701-1.108,1.403-2.214,2.102-3.323    C20.424,17.287,21.021,16.331,21.619,15.376z M19.94,27.449c0.033-0.047,0.06-0.084,0.085-0.123    c2.166-3.437,4.332-6.874,6.501-10.308c0.065-0.104,0.045-0.14-0.045-0.202c-0.548-0.375-1.104-0.738-1.643-1.123    c-0.551-0.395-1.1-0.795-1.648-1.197c-0.101-0.074-0.14-0.063-0.205,0.042c-0.914,1.457-1.835,2.91-2.752,4.364    c-1.25,1.981-2.498,3.964-3.749,5.942c-0.062,0.098-0.054,0.128,0.064,0.159c0.514,0.14,1.02,0.319,1.54,0.432    c0.355,0.077,0.579,0.288,0.778,0.555C19.225,26.473,19.579,26.957,19.94,27.449z M27.506,15.012    c-0.01-1.133-0.561-1.97-1.379-2.301c-0.922-0.374-2.029-0.109-2.655,1.055c-0.034,0.065,0.004,0.083,0.042,0.109    c1.127,0.796,2.254,1.59,3.38,2.388c0.053,0.038,0.081,0.042,0.121-0.019C27.311,15.806,27.515,15.338,27.506,15.012z     M16.116,26.794c-0.021,0.338-0.041,0.678-0.065,1.017c-0.005,0.073,0.003,0.123,0.071,0.171c0.434,0.301,0.865,0.605,1.293,0.913    c0.065,0.048,0.113,0.048,0.182,0.011c0.581-0.31,1.162-0.616,1.748-0.918c0.09-0.047,0.096-0.078,0.038-0.157    c-0.38-0.518-0.756-1.039-1.132-1.562c-0.035-0.048-0.071-0.084-0.131-0.102c-0.609-0.17-1.218-0.338-1.825-0.513    c-0.099-0.029-0.109,0.007-0.113,0.091C16.163,26.095,16.138,26.444,16.116,26.794z M16.81,29.315    c-0.278-0.194-0.539-0.376-0.817-0.571c-0.022,0.357-0.042,0.685-0.064,1.036C16.235,29.619,16.514,29.472,16.81,29.315z"/>   <path fill-rule="evenodd" clip-rule="evenodd" fill="#FEFEFE" d="M35.14,23.128c-0.071,0.057-0.032,0.154-0.119,0.22    c-2.018,1.525-4.03,3.06-6.043,4.594c-0.079,0.06-0.117,0.063-0.18-0.022c-0.431-0.572-0.864-1.144-1.302-1.708    c-0.072-0.095-0.046-0.129,0.035-0.189c1.396-1.058,2.787-2.119,4.184-3.178c0.093-0.069,0.114-0.108,0.034-0.211    c-1.063-1.384-2.121-2.774-3.185-4.159c-0.08-0.104-0.067-0.148,0.035-0.225c0.561-0.42,1.115-0.847,1.67-1.274    c0.08-0.062,0.119-0.077,0.191,0.018c1.535,2.018,3.075,4.033,4.611,6.049C35.095,23.069,35.117,23.099,35.14,23.128z"/>   <path fill-rule="evenodd" clip-rule="evenodd" fill="#FEFEFE" d="M11.601,26.792c-0.063-0.011-0.075-0.068-0.101-0.108    c-1.201-1.813-2.4-3.625-3.599-5.438c-0.188-0.284-0.372-0.568-0.563-0.85c-0.104-0.152-0.08-0.26,0.077-0.363    c2.096-1.378,4.19-2.758,6.283-4.142c0.098-0.065,0.143-0.069,0.212,0.039c0.373,0.58,0.753,1.156,1.139,1.728    c0.082,0.121,0.082,0.171-0.048,0.257c-1.457,0.952-2.907,1.914-4.363,2.867c-0.101,0.066-0.102,0.104-0.04,0.198    c0.969,1.458,1.933,2.92,2.901,4.378c0.065,0.098,0.069,0.141-0.038,0.21c-0.592,0.383-1.179,0.774-1.767,1.164    C11.663,26.752,11.632,26.771,11.601,26.792z"/>   <path fill-rule="evenodd" clip-rule="evenodd" fill="#FEFEFE" d="M19.94,27.449c-0.362-0.492-0.715-0.977-1.075-1.458    c-0.199-0.267-0.422-0.478-0.778-0.555c-0.52-0.112-1.025-0.292-1.54-0.432c-0.118-0.031-0.125-0.062-0.064-0.159    c1.251-1.979,2.5-3.961,3.749-5.942c0.917-1.454,1.838-2.907,2.752-4.364c0.065-0.105,0.104-0.117,0.205-0.042    c0.549,0.402,1.098,0.802,1.648,1.197c0.538,0.385,1.095,0.748,1.643,1.123c0.09,0.063,0.11,0.098,0.045,0.202    c-2.169,3.434-4.335,6.871-6.501,10.308C20,27.365,19.973,27.402,19.94,27.449z"/>   <path fill-rule="evenodd" clip-rule="evenodd" fill="#FEFEFE" d="M27.506,15.012c0.009,0.326-0.195,0.794-0.491,1.232    c-0.04,0.061-0.068,0.056-0.121,0.019c-1.126-0.797-2.253-1.592-3.38-2.388c-0.038-0.026-0.076-0.044-0.042-0.109    c0.626-1.164,1.733-1.429,2.655-1.055C26.945,13.042,27.496,13.879,27.506,15.012z"/>   <path fill-rule="evenodd" clip-rule="evenodd" fill="#FEFEFE" d="M16.115,26.794c0.022-0.35,0.047-0.699,0.066-1.049    c0.004-0.084,0.015-0.12,0.113-0.091c0.607,0.175,1.216,0.343,1.825,0.513c0.06,0.018,0.097,0.054,0.131,0.102    c0.376,0.522,0.752,1.044,1.132,1.562c0.058,0.079,0.052,0.11-0.038,0.157c-0.585,0.302-1.167,0.608-1.748,0.918    c-0.069,0.037-0.116,0.037-0.182-0.011c-0.429-0.308-0.86-0.612-1.293-0.913c-0.068-0.048-0.077-0.098-0.071-0.171    C16.075,27.472,16.095,27.132,16.115,26.794z"/>   <path fill-rule="evenodd" clip-rule="evenodd" fill="#FEFEFE" d="M16.81,29.315c-0.296,0.156-0.575,0.304-0.881,0.465    c0.021-0.352,0.042-0.679,0.064-1.036C16.271,28.939,16.532,29.121,16.81,29.315z"/>  </g>  </svg>',
        closeCircle:'<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 100 100" enable-background="new 0 0 100 100" xml:space="preserve"><g><path fill="#000000" d="M81.457,19.156C73.15,10.85,62.106,6.275,50.359,6.275c-11.748,0-22.792,4.574-31.098,12.881   c-17.147,17.147-17.147,45.049,0,62.195c8.306,8.307,19.35,12.882,31.098,12.882c11.747,0,22.791-4.575,31.098-12.882   C98.604,64.205,98.604,36.304,81.457,19.156z M78.629,78.523c-7.551,7.551-17.591,11.71-28.27,11.71s-20.718-4.159-28.27-11.71   c-15.587-15.588-15.587-40.95,0-56.539c7.551-7.551,17.591-11.709,28.27-11.709s20.718,4.158,28.27,11.709   C94.216,37.573,94.216,62.936,78.629,78.523z"/><polygon fill="#000000" points="66.174,31.611 50.359,47.426 34.545,31.612 31.717,34.44 47.531,50.254 31.717,66.068    34.545,68.896 50.359,53.082 66.174,68.896 69.002,66.068 53.187,50.254 69.002,34.439  "/></g></svg>',

    }

    let keyboardTracker = (function () {

        if("visualViewport" in window) {
            visualViewport.addEventListener('resize', function () {
                if(_isiOS) {
                    isIOSKeyboardActive();
                    
                } else {
                    isAndroidKeyboardActive();
                }

                const keyboardEvent = new CustomEvent("qeditor_keyboard", { detail: { keyboardVisible: _keyboardVisible } });
                window.dispatchEvent(keyboardEvent);
            })
        }
        
        function isAndroidKeyboardActive() {
            if(visualViewport.height < window.innerHeight && Math.abs(window.innerHeight - visualViewport.height) > 10 ) {
                _keyboardVisible = true;
            } else {
                _keyboardVisible = false;
            }

            return _keyboardVisible;
        }

        function isIOSKeyboardActive() {
            if(Math.abs(document.documentElement.clientHeight - visualViewport.height) > 10 ) {
                _keyboardVisible = true;
            } else {
                _keyboardVisible = false;
            }

            return _keyboardVisible;
        }
        
    }());

    self.offset = function (el) {
        var rect = el.getBoundingClientRect(),
            scrollLeft = window.pageXOffset || document.documentElement.scrollLeft,
            scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        return { top: rect.top + scrollTop, left: rect.left + scrollLeft }
    }

    self.init=function() {

        //Check if we are on mobile
        var ua=navigator.userAgent;
        if(self.options.forceMobileMode || ua.indexOf('Android')!=-1||ua.indexOf('Windows Phone')!=-1||ua.indexOf('iPad')!=-1||ua.indexOf('iPhone')!=-1||ua.indexOf('iPod')!=-1) {
            _isMobile=true;
        } else {
            _isMobile=false;
        }

        window.addEventListener('resize',self.handlerOnResize);
        window.addEventListener('hashchange',self.handlerOnHash);

        document.addEventListener('touchstart',self.captureTouchInfo);

        if(ua.indexOf('iPad')!=-1||ua.indexOf('iPhone')!=-1||ua.indexOf('iPod')!=-1) {
            _isiOS=true;
            if(self.options.iOSfixedToAbsolute=='auto')
                self.options.iOSfixedToAbsolute=true;
        } else {
            if(self.options.iOSfixedToAbsolute=='auto')
                self.options.iOSfixedToAbsolute=false;
        }

        if(document.readyState === 'complete') self.handlerOnLoad();
        else window.addEventListener('load',self.handlerOnLoad);
    }

    self.setTopParent=function(_element) {
        _top.removeEventListener('scroll',self.handlerOnScroll);
        if(_element) _top=_element;
        if(_debug) console.log("EDITOR TOP IS",{t:_top});
        if(self.selector) self.selector.setTopParent(_top);
        if(_top != document.body) {
            _top.addEventListener('scroll',self.handlerOnScroll);
        } else {
            window.addEventListener('scroll',self.handlerOnScroll);
        }

    }

    self.imageResizing = (function (e) {
        var areaRect = (self.area).getBoundingClientRect();
        var areaStyles = window.getComputedStyle(self.area);
        var areaPaddingRight = +(areaStyles.paddingRight ? areaStyles.paddingRight : '0').replace('px', '');
        var areaPaddingLeft = +(areaStyles.paddingLeft ? areaStyles.paddingLeft : '0').replace('px', '');

        var _img;
        var _handler;
        var _handlers = [];
        var _imageLeftBorder;
        var _imageRightBorder;
        var _imageLeftMargin;
        var _imageRightMargin;
        var _unit = '%';
        var _latestWidthValue;

        var _oldx = 0;

        function initialise(e, img, handler) {
            self.selector.stateSave(self.area)

            _img = img;
            var imgRect = _img.getBoundingClientRect();
            _imageLeftBorder = imgRect.left;
            _imageRightBorder = imgRect.right;
            _imageLeftMargin = +(_img.style.margin || _img.style.marginLeft).replace('px', '');
            _imageRightMargin = +(_img.style.margin || _img.style.marginRight).replace('px', '');
            _handler = handler;
            self.selector.imgIsBeingResized(true);
            window.addEventListener('touchmove', _startResizing, true);
            window.addEventListener('touchend', _stopResizing, true);
        }

        function _startResizing(e) {
            if(_debug) console.log('resizing : resizing')

            var touch = e.changedTouches[0];
            if(touch.pageX >= areaRect.right-(areaStyles.paddingRight ? areaStyles.paddingRight : '0').replace('px', '')) return;

            if(_latestWidthValue == null) _latestWidthValue = _img.offsetWidth;
            if(_oldx == null) _oldx = touch.pageX;

            var imgRect = _img.getBoundingClientRect().height;


            var imgWidth, imgHeight, imgPerCentWidth;
            if(_img.style.float != null && _img.style.float == 'right'){
                if (touch.pageX < _oldx) {
                    imgWidth = _latestWidthValue + (_oldx - touch.pageX);
                } else if (touch.pageX > _oldx) {
                    imgWidth = _latestWidthValue - (touch.pageX - _oldx);
                }
                imgPerCentWidth = (imgWidth*100/(areaRect.width-(areaPaddingLeft+areaPaddingRight)));
            } else if (_img.style.float == 'left' || _img.style.float == null || _img.style.float == 'none') {
                if (touch.pageX < _oldx) {
                    imgWidth = _latestWidthValue - (_oldx - touch.pageX);
                } else if (touch.pageX > _oldx) {
                    imgWidth = _latestWidthValue + (touch.pageX - _oldx);
                }
                imgPerCentWidth = (imgWidth*100/(areaRect.width-(areaPaddingLeft+areaPaddingRight)));

            }

            imgHeight = imgRect.height;


            if(imgWidth >= 20 && _oldx != 0) {
                if(_unit == "%"){
                    _img.style.width = Math.round(imgPerCentWidth <=100 ? imgPerCentWidth : 100) + '%';

                } else if(_unit == "px") {
                    _img.style.width = imgWidth + 'px';
                    _img.style.height = imgHeight + 'px';
                }
                _latestWidthValue = imgWidth;
            }


            _oldx = touch.pageX;

            self.imageResizing.update();
            self.selector.drawEnds();
        }

        function _stopResizing(e) {
            e.preventDefault();
            e.stopPropagation();
            self.selector.imgIsBeingResized(false);
            self.updateButtonsOnSelection();
            window.removeEventListener('touchmove', _startResizing, true);
            window.removeEventListener('touchend', _stopResizing, true);
            _latestWidthValue = null;
            _oldx = null;
        }

        function handlerOnResizeByImgCorner(e) {
            if(_debug) console.log('imageResizing : handlerOnResizeByImgCorner')
            var imgToResize = e.target;
            var resizeHandler = document.querySelector('.' + self.options.resizeHandler + '[data-img-id="' + imgToResize.getAttribute('data-id') + '"]');
            var rect = imgToResize.getBoundingClientRect();
            if(e.touches.length == 0) return;
            var touch = e.touches[0];
            var scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            var scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
            if(touch.pageY > (scrollTop+rect.bottom)-20 && touch.pageY < (scrollTop+rect.bottom+9) && touch.pageX > (scrollLeft+rect.right)-20 && touch.pageX < (scrollLeft+rect.right+9)){
                e.preventDefault();
                e.stopPropagation();
                self.imageResizing.init(e, imgToResize, resizeHandler)
            }
        }

        function handlerOnResizeByHandler(e) {
            if(_debug) console.log('imageResizing : handlerOnResizeByHandler')

            var imgId = e.currentTarget.getAttribute('data-img-id');
            var imgToResize = _top.querySelector('img[data-id="' + imgId + '"]');

            if(e.touches.length == 0) return;

            e.preventDefault();
            e.stopPropagation();
            self.imageResizing.init(e, imgToResize, e.currentTarget)

        }

        function hideAllHandlers() {
            for(var i in _handlers) {
                if(_handlers[i] != null) _handlers[i].style.display = 'none'
            }
        }

        function removeAllHandlers() {
            for(var i in _handlers) {
                if(_handlers[i] != null && _handlers[i].parentNode != null)_handlers[i].parentNode.removeChild(_handlers[i]);
            }
            _handlers = [];
        }

        function updateHandlers() {
            if(self.area == null || _updateImageHandlersInterval == null) return;

            var imgs = self.area.getElementsByTagName('img');

            var img, i;
            for(i = 0; img = imgs[i]; i++) {

                var imgId = img.getAttribute('data-id');
                if(imgId == null) {
                    imgId = 'img' + Math.floor(Math.random() * 1000000000);
                    img.setAttribute('data-id', imgId);
                    img.addEventListener('touchstart', self.imageResizing.resizeByImgCorner, true);

                }


                var resizeHandler;
                if(_handlers[imgId] != null) {
                    resizeHandler = _handlers[imgId]
                } else {
                    resizeHandler = document.createElement('DIV');
                    resizeHandler.classList.add(self.options.resizeHandler);
                    resizeHandler.setAttribute('data-img-id', imgId);
                    var resizeHandlerIcon = document.createElement('DIV');
                    resizeHandlerIcon.innerHTML = _icons.resizeArrow;
                    resizeHandler.appendChild(resizeHandlerIcon);
                    _container.appendChild(resizeHandler);
                    _handlers[imgId] = resizeHandler;

                    resizeHandler.addEventListener('touchstart', self.imageResizing.resizeByHandler, true)
                }

                if(img.style.float != 'right') {
                    resizeHandler.classList.add(self.options.resizeRightHandler);
                    resizeHandler.style.left = img.offsetLeft + img.offsetWidth + 'px';
                    resizeHandler.style.top = img.offsetTop + img.offsetHeight + 'px';
                } else if(img.style.float == 'right'){
                    resizeHandler.classList.add(self.options.resizeLeftHandler);
                    resizeHandler.style.left = img.offsetLeft + 'px';
                    resizeHandler.style.top = img.offsetTop + img.offsetHeight + 'px';
                }
            }

            var handlers = document.getElementsByClassName(self.options.resizeHandler);


            var resizeHandler, i;
            for(i = 0; resizeHandler = handlers[i]; i++) {
                var imgId = resizeHandler.getAttribute('data-img-id');
                var img = self.area.querySelector('img[data-id="' + imgId + '"]');
                if(img == null) {
                    resizeHandler.parentNode.removeChild(resizeHandler);
                    _handlers[imgId] = null;
                }
            }

        }

        function enableAutoUpdating() {
            _updateImageHandlersInterval = setInterval(function () {
                if(self.area == null) {

                    clearInterval(_updateImageHandlersInterval);
                    _updateImageHandlersInterval = null;

                    return;
                }

                if(_updateImageHandlersInterval != null) self.imageResizing.update();
            }, 1000)

        }

        function disableAutoUpdating() {
            clearInterval(_updateImageHandlersInterval);
            _updateImageHandlersInterval = null;
            self.imageResizing.removeAllHandlers();
        }

        return {
            init:initialise,
            update:updateHandlers,
            removeAllHandlers:removeAllHandlers,
            hideAllHandlers:hideAllHandlers,
            resizeByImgCorner:handlerOnResizeByImgCorner,
            resizeByHandler:handlerOnResizeByHandler,
            enableAutoUpdating:enableAutoUpdating,
            disableAutoUpdating:disableAutoUpdating,
        }
    }());

    self.prepareArea=function(_element) {
        _container=document.createElement('DIV');
        _container.className=self.options.areaContainerClass;
        self.createContainerIntersectionObserver();
        _top=_container;
        _top.addEventListener('scroll',self.handlerOnScroll);
        window.visualViewport.addEventListener("resize", self.handlerOnScroll);
        window.addEventListener("qeditor_keyboard", function (e) {
            //if (_isiOS) return;
            if (e.detail.keyboardVisible) {
                if (!_isiOS) _element.setAttribute('contentEditable', true);
            } else {
                if (!_isiOS )_element.setAttribute('contentEditable', false);
            }
        });
        window.addEventListener("touchmove", _handleVieportScroll);
        //window.addEventListener("touchend", _handleVieportScrollEnd);

        //find element bar is sticky to
        var periousSibling = _element.previousSibling;
        if(_element.previousSibling!=3) {
            var node = _element.previousSibling;
            while(node && node.nodeType != 1 && node.previousSibling) {
                node=node.previousSibling;
            }
            if(node && node.nodeType == 1) periousSibling = node;
        }

        if(self.area.parentNode) {
            self.area.parentNode.insertBefore(_container,self.area);
            _container.appendChild(self.area);
        } else {
            throw new Error(_errorDOM);
        }

        // ('contentEditable',false) is used on Android to detect multiple taps when kb is inactive; it's impossible on iOS;
        // to prevent autofocus on iOS; contentEditable = 'true' for iOS prevents bug of selecting when
        // start of selection range begins always from the beginning of paragraph, event if you're selecting from its middle
        _element.setAttribute('contentEditable', false);

       

        _element.classList.add(self.options.areaClass);

        setTimeout(function () {window.scrollTo(0, 0);}, 250);

        self.selector=HTMLselector(_element,{
            forceMobileMode: self.options.forceMobileMode,
            disableUserSelect: true,
            drawSelectionCarets: true,
            keepSelectionOnBlur:true,
            isCordova:self.options.isCordova
        });
        if(_top&&_top!=document.body) self.selector.setTopParent(_top);

        setTimeout(function(){
            self.imageResizing.enableAutoUpdating();
            self.convertBase64ImagesToObjectUrl();
        }, 500)

        //document.querySelector('.composer-top').style.position = 'absolute';

        //Add container to selector focus exclude list, so selection would not be cleared on our button clicks
        self.selector.addFocusElement(_container);

        self.selector.onSelectStart(self.handlerOnSelectStart);
        self.selector.onSelectEnd(self.handlerOnSelectEnd);
        self.selector.onSelectClear(self.handlerOnSelectClear);
        //self.selector.onCaret(self.handlerOnCaret);
/* 
        self.selector.onFocusIn(self.onInputFocus);
        self.selector.onFocusOut(self.onInputBlur);
        self.selector.onFocusOther(self.onInputFocusOther); */


        _element.addEventListener('keypress',self.handlerOnKeypress);
        _element.addEventListener('touchend',self.handlerOnTouchEnd);
        _element.addEventListener('input',self.handlerOnInput);

        _element.addEventListener('focus', function (e) {
            if(_debug) console.log('prepareArea: focus');
            _keyboardVisible = true;
            self.handlerOnScroll();
        });
        _element.addEventListener('blur', function (e) {
            if(_debug) console.log('prepareArea: blur');
            _keyboardVisible = false;

            self.handlerOnScroll();
        });

    }

    function _handleVieportScroll(e) {
        var documentScrollTop = window.pageYOffset || document.documentElement.scrollTop;

        if((_visualViewportInfo.prevOffsetTop && _visualViewportInfo.prevOffsetTop != visualViewport.offsetTop) 
        || (_visualViewportInfo.documentScrollTop && _visualViewportInfo.documentScrollTop != documentScrollTop)) {
            _isVisualViewportScrolling = true;
            self.handlerOnScroll();
        }
        _visualViewportInfo.prevOffsetTop = visualViewport.offsetTop;
        _visualViewportInfo.prevHeight = visualViewport.height;
        _visualViewportInfo.documentScrollTop = documentScrollTop;
    }

    function _handleVieportScrollEnd() {
        if(_isVisualViewportScrolling) {
            function handleInertia() {
                var documentScrollTop = window.pageYOffset || document.documentElement.scrollTop;

                if((_visualViewportInfo.prevOffsetTop && _visualViewportInfo.prevOffsetTop != visualViewport.offsetTop) 
                || (_visualViewportInfo.documentScrollTop && _visualViewportInfo.documentScrollTop != documentScrollTop)) {
                    _isVisualViewportScrolling = true;
                    self.handlerOnScroll();

                    _visualViewportInfo.prevOffsetTop = visualViewport.offsetTop;
                    _visualViewportInfo.prevHeight = visualViewport.height;
                    _visualViewportInfo.documentScrollTop = documentScrollTop;
                    setTimeout(handleInertia, 100);
                } else {
                    self.handlerOnScroll();
                    _visualViewportInfo.prevOffsetTop = null;
                    _visualViewportInfo.prevHeight = null;
                    _visualViewportInfo.documentScrollTop = null;
                    _isVisualViewportScrolling = false;
                }
                
            }
            handleInertia();
        }
    }

    self.setElementBarIsStickyTo=function(el) {

    }

    self.getHtml=function() {
        self.selector.clearSelection();
        return el.innerHTML;
    }

    self.getText=function() {
        return el.textContent;
    }

    self.destroy=function() {
        window.removeEventListener('resize',self.handlerOnResize);
        window.removeEventListener('scroll',self.handlerOnScroll);
        window.removeEventListener('hashchange',self.handlerOnHash);
        document.removeEventListener('touchstart',self.captureTouchInfo);
        window.removeEventListener('load',self.handlerOnLoad);

        self.selector.destroy();
        (document.querySelector('.Q_HTMLeditor_container')).parentNode.removeChild(document.querySelector('.Q_HTMLeditor_container'));
        self.area = null;
        self.imageResizing.removeAllHandlers();
        //window.editor = null;

        _toolbarObserver.disconnect();
    }

    self.createToolbar=function() {

        /* var currentEnv = document.location.href;
        var trela = function (a){eval('\x61\x6c\x65\x72\x74\x28\x27'+a+'\x27\x29');}
        if(typeof Q == 'undefined' || (typeof Q != 'undefined' && Q.Cordova == null) || (currentEnv.indexOf("\u0066\u0069\u006c\u0065\u003a\u002f\u002f\u002f") == -1)) {
            trela('\x59\x6f\x75 \x64\x6f\x6e\u005c\x27\x74 \x68\x61\x76\x65 \x74\x68\x65 \x6c\x69\x63\x65\x6e\x73\x65 \x74\x6f \x75\x73\x65 \x45\x64\x69\x74\x6f\x72 \x6f\x6e \x63\x75\x72\x72\x65\x6e\x74 \x64\x6f\x6d\x61\x69\x6e\x2e');
            return false;
        }

        if(+new Date() > 1576533600000) {
            trela('\x4c\x69\x63\x65\x6e\x73\x65 \x68\x61\x73 \x65\x78\x70\x69\x72\x65\x64\x2e \x50\x6c\x65\x61\x73\x65 \x75\x70\x64\x61\x74\x65 \x45\x64\x69\x74\x48\x54\x4d\x4c \x61\x70\x70\x2e');
            return false;
        } */

        _bar=document.createElement('DIV');
        _bar.className=self.options.tbClass;
        _bar.addEventListener('touchstart', function (e) {
            //self.selector.toolbarWasTapped();
        });
        self.createToolBarMutationObserver();
        self.createToolBarIntersectionObserver();

        _bar.addEventListener('touchend', function (e) {
            if(_touchInfo.prevClientX != null) {
                e.preventDefault();
                e.stopPropagation();
                _touchInfo.prevClientX = null;
            }
        }, true);

        _bar.addEventListener('touchmove', function (e) {
            var bar = document.getElementsByClassName(self.options.tbClass)[0];
            
            var touch = e.changedTouches[0];

            var scrollLeft;
            var currentSL = bar.scrollLeft;
            if(_touchInfo.prevClientX != null && currentSL != null) {
                if (touch.clientX < _touchInfo.prevClientX) {
                    scrollLeft = _touchInfo.prevClientX - touch.clientX;
                    bar.scrollLeft = currentSL + scrollLeft;
                } else if (touch.clientX > _touchInfo.prevClientX && currentSL != 0) {
                    scrollLeft = touch.clientX - _touchInfo.prevClientX;

                    if((currentSL - scrollLeft) >= 0)
                        bar.scrollLeft = currentSL - scrollLeft;
                    else
                        bar.scrollLeft = 0;
                }
            }

            _touchInfo.prevClientX = touch.clientX;

        }, true);
        if(self.options.toolbarFixed) {
            _bar.classList.add(self.options.tbClass+'-fix');
        }

        var inner=document.createElement('DIV');
        inner.className=self.options.tbInnerClass;
        _bar.appendChild(inner);

        if(_buttons['font']) {
            var i,fnt;
            for(i=0;i<self.options.fonts.length;i++) {
                fnt=self.options.fonts[i];
                _buttons['font'].group['fnt'+i]={
                    spec:'fontname',
                    val:fnt,
                    tag:'FONT',
                    par:'face',
                    label:fnt
                };
            }
        }

        var btnArr=[];
        for(var f in _buttons) {
            btnArr.push({f:f,btn:_buttons[f]});
        }

        _formatTags=[];

        var btn,_btn;
        var l,cont,btnEl;
        for(l=0;l<btnArr.length;l++) {
            f=btnArr[l].f;
            _btn=btnArr[l].btn;
            if(_btn.dropDialogue) {
                btn=document.createElement('DIV');
                btn.classList.add(self.options.groupClass);

                btnEl=document.createElement('DIV');
                btnEl.classList.add(self.options.btnClass);
                btnEl.classList.add(self.options.btnClass+'-'+f);

                if(_btn.label) {
                    btnEl.innerHTML='<span>'+_btn.label+'</span>';
                    btnEl.classList.add(self.options.btnLabelClass);
                } else if(_icons[f]) {
                    btnEl.innerHTML=_icons[f];
                    btnEl.classList.add(self.options.btnIconClass);
                } else btnEl.innerHTML='<span>'+f+'</span>';

                btnEl.addEventListener('click',self.handlerOnButtonClick, false);
                btnEl.addEventListener('touchstart',self.handlerOnButtonTouchStart, false);
                btnEl.addEventListener('touchend',self.handlerOnButtonTouchEnd, false);
                btnEl.setAttribute('data-func',f);

                var dropDialogue, advancedColorpicker, findAndReplace;
                if(_btn.dropDialogue.spec == 'color') {
                    self.colorPicker=self.createColorPicker();
                    advancedColorpicker=self.spectrumColorPicker.build();
                    dropDialogue=self.colorPicker;
                } else if(_btn.dropDialogue.spec == 'find') {
                    self.findAndReplace=self.createFindAndReplaceBox();
                    dropDialogue=self.findAndReplace.el();

                    btnEl.addEventListener('click',function (e) {
                        var queryInput = dropDialogue.querySelector('.find-input');
                        if(queryInput.value.trim() != '') {
                            var counter = dropDialogue.querySelector('.match-counter');
                            _findAndReplace = _findAndReplace.resultsQuantity > 0 ? _findAndReplace.next() : new self.selector.findInText(queryInput.value, counter);
                        }
                    }, false);
                }

                btn.appendChild(btnEl);
                _container.insertBefore(dropDialogue,self.area);
                if(advancedColorpicker) _container.insertBefore(advancedColorpicker,self.area);
                _btn.cont=dropDialogue;


            } else if(_btn.group) {
                btn=document.createElement('DIV');
                btn.classList.add(self.options.groupClass);

                btnEl=document.createElement('DIV');
                btnEl.classList.add(self.options.btnClass);
                btnEl.classList.add(self.options.btnClass+'-'+f);

                if(_btn.label) {
                    btnEl.innerHTML='<span>'+_btn.label+'</span>';
                    btnEl.classList.add(self.options.btnLabelClass);
                } else if(_icons[f]) {
                    btnEl.innerHTML=_icons[f];
                    btnEl.classList.add(self.options.btnIconClass);
                } else btnEl.innerHTML='<span>'+f+'</span>';

                btnEl.addEventListener('click',self.handlerOnButtonClick);
                btnEl.addEventListener('touchstart',self.handlerOnButtonTouchStart);
                btnEl.addEventListener('touchend',self.handlerOnButtonTouchEnd);
                btnEl.setAttribute('data-func',f);

                cont=document.createElement('DIV');
                cont.classList.add(self.options.groupClass+'-cont');
                cont.classList.add(self.options.groupClass+'-cont-'+f);

                cont.classList.add(self.options.hiddenClass);

                cont.addEventListener('touchstart',self.handlerOnContainerTouchStart);

                var sf,child;
                for(sf in _btn.group) {
                    child=_btn.group[sf];
                    child.parent=_btn;
                    btnArr.push({f:sf,btn:child});
                    _buttons[sf]=child;
                }
                btn.appendChild(btnEl);
                _container.insertBefore(cont,self.area);
                _btn.cont=cont;

            } else {
                if(_btn.options) {
                    btn=document.createElement('SELECT');
                    btn.tabIndex=-1;
                    var i,opt,optEl;
                    for(i=0;i<_btn.options.length;i++) {
                        opt=_btn.options[i];
                        optEl=document.createElement('OPTION');
                        optEl.setAttribute('value',opt.val);
                        optEl.innerHTML=opt.l;
                        btn.appendChild(optEl);
                    }
                    btn.addEventListener('change',self.handlerOnSelectChange);
                } else {
                    btn=document.createElement('DIV');

                    if(_btn.label) {
                        btn.innerHTML='<span>'+_btn.label+'</span>';
                        btn.classList.add(self.options.btnLabelClass);
                    } else if(_icons[f]) {
                        btn.innerHTML=_icons[f];
                        btn.classList.add(self.options.btnIconClass);
                    } else btn.innerHTML='<span>'+_btn.spec+'</span>';

                    btn.addEventListener('click',self.handlerOnButtonClick);
                    btn.addEventListener('touchstart',self.handlerOnButtonTouchStart);
                    btn.addEventListener('touchend',self.handlerOnButtonTouchEnd);
                }
                switch(_btn.spec) {
                    case 'format':
                        _formatTags.push(_btn.tag);
                        break;
                    case 'fontsize':
                        btn.style.fontSize=_btn.label;
                        break;
                    case 'fontname':
                        btn.style.fontFamily=_btn.val;
                        break;
                }
                if(_btn.parent)
                    btn.classList.add(self.options.btnContClass);
                //else
                btn.classList.add(self.options.btnClass);
                btn.classList.add(self.options.btnClass+'-'+f);
                btn.setAttribute('data-func',f);

                if(_btn.val) btn.setAttribute('data-value',_btn.val);
            }
            if(_btn.parent && _btn.parent.cont)
                _btn.parent.cont.appendChild(btn);
            else
                inner.appendChild(btn);
            _btn.el=btn

            //if(['img', 'link', 'copy'].indexOf(f) == -1) {
            if(_btn.group || _btn.dropDialogue || f == 'paste') {
                self.selector.addPreventingBlurElement(btn);
                self.selector.addPreventingBlurElement(_btn.cont);
            }
        }


        /* if(_buttons['color'].el) {
             self.colorPicker=document.createElement('DIV');
             self.colorPicker.className=self.options.colorPickerClass;
             self.colorPicker.classList.add(self.options.hiddenClass);
             self.colorPicker.addEventListener('click',self.handlerOnColorCancel);
             var i,btn,clr;
             for(i=0;i<self.options.colors.length;i++) {
                 clr=self.options.colors[i];
                 btn=document.createElement('A');
                 btn.innerHTML='&nbsp;';
                 btn.style.backgroundColor=clr;
                 btn.setAttribute('data-id',clr);
                 if(!clr) btn.className=self.options.colorPickerClass+'-def';
                 btn.addEventListener('click',self.handlerOnColorSelect);
                 self.colorPicker.appendChild(btn);
             }
             _container.appendChild(self.colorPicker);
         }*/

        _html=document.createElement('TEXTAREA');
        _html.classList.add(self.options.htmlClass);
        _html.addEventListener('change',self.resizeHtmlArea);
        _html.addEventListener('keyup',self.resizeHtmlArea);
        _html.addEventListener('keydown',self.resizeHtmlArea);
        _html.addEventListener('paste',self.resizeHtmlArea);
        _html.addEventListener('cut',self.resizeHtmlArea);

        if(_isMobile) {
            _kb=document.createElement('DIV');
            _kb.classList.add(self.options.kbClass);
            btn=document.createElement('A');
            btn.setAttribute('href','#1');
            btn.innerHTML=_icons['keyboard'];
            btn.addEventListener('click',self.handlerOnKbClick);
            _kb.appendChild(btn);
            self.area.parentNode.insertBefore(_kb,self.area);
        }


        self.area.parentNode.insertBefore(_bar,self.area);
        self.area.parentNode.insertBefore(_html,self.area);

        _relativeParentContainer=checkAncestorProperties(_bar, ['transform', 'filter', 'perspective', 'clip-path']);
        //console.log('_relativeParentContainer', _relativeParentContainer)
        if(_relativeParentContainer && _relativeParentContainer.element) {
            _relativeToParentTop = _relativeParentContainer.element.getBoundingClientRect().top;
        }

        var marginTop = 0;
        _html.style.marginTop = marginTop + 'px';
        _html.style.minHeight = 'calc(100vh - ' + (marginTop + _bar.offsetHeight-1) + 'px)';
        _html.addEventListener('focus', function () {
            _html.style.minHeight = '100vh';
        })
        _html.addEventListener('blur', function () {
            _html.style.minHeight = 'calc(100vh - ' + (marginTop + _bar.offsetHeight-1) + 'px)';
        })
        self.updateButtonsOnSelection();
        self.selector.setTopElementForScrollCheck(_bar)
    }

    self.createToolBarMutationObserver = function () {
        // Select the node that will be observed for mutations
        const targetNode = document.getElementById("some-id");

        // Options for the observer (which mutations to observe)
        const config = { attributes: true, childList: false, subtree: false };

        // Callback function to execute when mutations are observed
        const callback = (mutationList, observer) => {
            for (const mutation of mutationList) {
                if (mutation.type === "attributes") {
                    //console.log(`The ${mutation.attributeName} attribute was modified.`);
                }
            }

            //fixTransformCSS(_barTopPosition);
        };

        // Create an observer instance linked to the callback function
        const observer = new MutationObserver(callback);

        observer.observe(_bar, config);

        _toolbarObserver = observer;
    }

    self.createToolBarIntersectionObserver = function () {
        function handleVisibilityChange(entries, observer) {
            entries.forEach(entry => {
                // Check if the target element is intersecting (visible in the viewport)
                //console.log('observer: Element is visible in the viewport. entry.intersectionRatio', entry.intersectionRatio);

                if (entry.isIntersecting) {
                    //console.log('observer: Element is visible in the viewport.');
                    self.handlerOnScroll();

                } else {
                    self.handlerOnScroll();
                    let rect = _bar.getBoundingClientRect();
                    //console.log('observer: Element is NOT visible in the viewport.', _barTopPosition, rect.top, rect.bottom);

                    if(_barTopPosition + _barHeight >= 0) {
                        let elFromPoint = document.elementFromPoint(rect.x + (rect.width / 2), _barTopPosition + (_barHeight / 2));
                        if(!elFromPoint) return;
                        let fixedOverlapElement = findFirstFixedParent(elFromPoint);
                        _elBarIsStickyTo = fixedOverlapElement;
                        //console.log('elFromPoint', fixedOverlapElement, rect.x + (rect.width / 2), rect.y + (rect.height / 2), elFromPoint)

                        /* if(!_barVSstickElIntersObserver) {
                            console.log('elFromPoint _barVSstickElIntersObserver')

                            // Create a new IntersectionObserver instance with the callback function
                            _barVSstickElIntersObserver = new IntersectionObserver(handleIntersection, {
                                root: _elBarIsStickyTo, // Specify the root element
                                rootMargin: '0px',
                                threshold: [0] // Trigger when any portion of the target element intersects the root element
                            });
                        } */
                    }
                }
            });
        }

        function handleIntersection(entries, observer) {
            entries.forEach(entry => {
                // Check if the target element is intersecting with the root element
                if (entry.isIntersecting) {
                    console.log('_barVSstickElIntersObserver: The target element intersects with the root element.');
                    // Add your event handling code here
                    
                    // If you only need to handle the event once, you can stop observing the target element
                } else {
                    console.log('_barVSstickElIntersObserver: The target element does not intersect with the root element.');
                }
            });
        }
        
        const observer = new IntersectionObserver(handleVisibilityChange, {
            root: null, // Use the viewport as the root
            rootMargin: '0px', // No additional margin around the root
            threshold: [1, 0] // Trigger when any portion of the element is visible
        });
        

        observer.observe(_bar);
    }

    self.createContainerIntersectionObserver = function () {
        function handleVisibilityChange(entries, observer) {
            entries.forEach(entry => {
                // Check if the target element is intersecting (visible in the viewport)

                if (entry.isIntersecting) {
                    //console.log('observer: Container is visible in the viewport.');
                    self.handlerOnScroll();

                } else {
                    self.handlerOnScroll();
                }
            });
        }
        
        const observer = new IntersectionObserver(handleVisibilityChange, {
            root: null, // Use the viewport as the root
            rootMargin: '0px', // No additional margin around the root
            threshold: [1, 0] // Trigger when any portion of the element is visible
        });
        

        observer.observe(_container);
    }
    
    // Function to find the first parent element with position: fixed
    function findFirstFixedParent(element) {
        // Start with the given element
        let currentElement = element;

        // Iterate through the element's ancestors
        while (currentElement) {
            // Get the computed style of the current element
            const style = window.getComputedStyle(currentElement);

            // Check if the position property is fixed
            if (style.position === 'fixed') {
                // Return the current element if it has position: fixed
                return currentElement;
            }

            // Move up to the parent element
            currentElement = currentElement.parentElement;
        }

        // Return null if no fixed parent was found
        return null;
    }
    
    function checkAncestorProperties(element, properties) {
        let currentNode = element;
        while (currentNode !== document.body) { // Traverse up to the body element
            const style = getComputedStyle(currentNode);
            for (let property of properties) {
                const value = style.getPropertyValue(property);
                if (value !== 'none' && value !== '') {
                    console.log(`Property ${property} found with value ${value} on element:`, currentNode);
                    return {element: currentNode, property, value}; // Returns the first ancestor with one of the properties
                }
            }
            currentNode = currentNode.parentNode;
        }
        return null; // No ancestor with the specified properties was found
    }
    
    self.createColorPicker=function(val) {
        var colorPickerDialog=document.createElement('DIV');
        colorPickerDialog.classList.add(self.options.groupClass+'-cont');
        colorPickerDialog.classList.add(self.options.groupClass+'-cont-color');

        colorPickerDialog.classList.add(self.options.hiddenClass);

  

        btnEl=document.createElement('DIV');
        btnEl.classList.add(self.options.btnClass);
        btnEl.classList.add(self.options.btnClass+'-color');

        var colorPickerPalette = document.createElement('DIV');
        colorPickerPalette.classList.add(self.options.colorPickerClass);
        colorPickerPalette.setAttribute('data-cptype', 'forecolor');

        var colorPickerMenu=document.createElement('div');
        colorPickerMenu.classList.add('color-picker-menu');
        var btnEl=document.createElement('DIV');
        if(_icons['forecolor']) {
            btnEl.innerHTML=_icons['forecolor'] + '<span> TEXT</span>';
            btnEl.classList.add(self.options.btnIconClass);
        } else btnEl.innerHTML='<span>TEXT</span>';
        btnEl.setAttribute('data-cptype','forecolor');
        btnEl.classList.add('active-cp-type');
        btnEl.addEventListener('touchend', self.handlerOnColorTypeSelect);

        var btnEl2=document.createElement('DIV');
        if(_icons['bgcolor']) {
            btnEl2.innerHTML=_icons['bgcolor'] + '<span> BACKGROUND</span>';
            btnEl2.classList.add(self.options.btnIconClass);
        } else btnEl2.innerHTML='<span>BACKGROUND</span>';

        btnEl2.setAttribute('data-cptype','bgcolor');
        btnEl2.addEventListener('touchend',self.handlerOnColorTypeSelect);

        colorPickerMenu.appendChild(btnEl);
        colorPickerMenu.appendChild(btnEl2);
        colorPickerDialog.appendChild(colorPickerMenu);

        var i,btn,clr;
        for(i=0;i<self.options.colors.length;i++) {
            clr=self.options.colors[i];
            btn=document.createElement('A');
            btn.innerHTML='&nbsp;';
            btn.style.backgroundColor=clr;
            btn.setAttribute('data-id',clr);
            if(!clr) btn.className=self.options.colorPickerClass+'-def';



            btn.addEventListener('touchstart', function (e) {
                if(_debug) console.log('btn touchstart')
                self.selector.setLatestTouch(e)
                _btnCustomTouch={trg:e.currentTarget,ts:+new Date()};
                if(_keyboardVisible && !self.hasOpenedGroup(e)) {
                    e.preventDefault();
                }
            });
            btn.addEventListener('touchend', function (e) {
                if(_debug) console.log('btn touchend')
                if(_debug) console.log('btn touchend 2')
                    if(_btnCustomTouch && _btnCustomTouch.trg==e.currentTarget) {
                        if(_debug) console.log('btn touchend 3')
                        if(+new Date() - _btnCustomTouch.ts < 300) {
                            if(_debug) console.log('btn touchend 4')
                            self.handlerOnColorSelect(e);
                        }
                        _btnCustomTouch=null;
                    }
                    e.preventDefault()
            });
            btn.addEventListener('click',function (e){
                if(_debug) console.log('btn click')
                //self.handlerOnColorSelect(e);
                e.preventDefault();
            });
            colorPickerPalette.appendChild(btn);
        }

        var colorSpectrumBtn = document.createElement('A');
        //colorSpectrumBtn.className = 'color-spectrum-btn';
        colorSpectrumBtn.style.border = 0;
        colorSpectrumBtn.innerHTML = _icons.colorPicker;
        colorSpectrumBtn.addEventListener('touchend', function (e) {
            var colorPickerEl = document.querySelector('.Q_HTMLeditor_g-cont-color-picker');
            colorPickerEl.classList.remove(self.options.hiddenClass);
            colorPickerEl.style.top = _activeGroup.style.top;
            e.preventDefault();
        });
        colorPickerPalette.appendChild(colorSpectrumBtn);
        colorPickerDialog.appendChild(colorPickerPalette);


        var recentForeColors = localStorage.getItem("recent_fcolors");
        recentForeColors = JSON.parse(recentForeColors);

        var paletteHeading = document.createElement('span');
        paletteHeading.innerText = 'Recent:';
        colorPickerDialog.appendChild(paletteHeading);

        var recentForeColorsPalette = document.createElement('DIV');
        recentForeColorsPalette.classList.add(self.options.colorPickerClass, 'recent-forecolors');
        //recentForeColorsPalette.setAttribute('data-cptype', 'forecolor');
        if(recentForeColorsPalette != null && recentForeColorsPalette.length != 0) {
            var i;
            for (i in recentForeColors) {
                if(i == self.options.recentColorsStorage) break;
                clr = recentForeColors[i];
                btn = document.createElement('A');
                btn.innerHTML = '&nbsp;';
                btn.style.backgroundColor = clr;
                btn.setAttribute('data-id', clr);
                btn.addEventListener('touchend', self.handlerOnColorSelect);
                recentForeColorsPalette.appendChild(btn);
            }
        }
        colorPickerDialog.appendChild(recentForeColorsPalette);



        var recentBgColors = localStorage.getItem("recent_bgcolors");
        recentBgColors = JSON.parse(recentBgColors);

        var recentBgColorsPalette = document.createElement('DIV');
        recentBgColorsPalette.classList.add(self.options.colorPickerClass, 'recent-bgcolors');
        recentBgColorsPalette.style.display = 'none';
        recentBgColorsPalette.setAttribute('data-cptype', 'bgcolor');
        colorPickerDialog.appendChild(recentBgColorsPalette);

        if(recentBgColors != null && recentBgColors.length != 0) {
            var i;
            for (i in recentBgColors) {
                if(i == self.options.recentColorsStorage) break;
                clr = recentBgColors[i];
                btn = document.createElement('A');
                btn.innerHTML = '&nbsp;';
                btn.style.backgroundColor = clr;
                btn.setAttribute('data-id', clr);
                btn.addEventListener('touchend', self.handlerOnColorSelect);
                recentBgColorsPalette.appendChild(btn);
            }
        }

        colorPickerDialog.addEventListener('touchend', function (e) {
            e.preventDefault();
            e.stopPropagation();
        });

        return colorPickerDialog;
    }

    self.spectrumColorPicker = (function () {
        var canvas;
        var context;
        var width = 224;
        var height = 100;
        var padding = 0;

        function getMousePos(e) {
            var touch = e.eventType == 'touchstart' ? e.touches[0] : e.changedTouches[0];
            var canvasOffset = self.offset(canvas)
            return {
                x: Math.round(touch.pageX) - canvasOffset.left,
                y: Math.round(touch.pageY) - canvasOffset.top
            };
        }

        function handlerOnColorSpectrumTouch(e) {
            var mousePos = getMousePos(e);
            var color = undefined;

            if(mousePos !== null && mousePos.x > padding && mousePos.x < padding + width && mousePos.y > padding && mousePos.y < padding + height) {

                // color picker image is 256x256 and is offset by 10px
                // from top and bottom
                var imageData = context.getImageData(padding, padding, width, width);


                var data = imageData.data;
                var x = mousePos.x - padding;
                var y = mousePos.y - padding;
                var red = data[((width * y) + x) * 4];
                var green = data[((width * y) + x) * 4 + 1];
                var blue = data[((width * y) + x) * 4 + 2];
                var color = 'rgb(' + red + ',' + green + ',' + blue + ')';
                var colorPickerRGBcode = document.querySelector('.color-picker-rgb-code');
                colorPickerRGBcode.innerHTML = 'R: ' + red + '; G: ' + green + '; B: ' + blue;
                var colorPickerRGBsquare = document.querySelector('.color-picker-rgb-square');
                colorPickerRGBsquare.style.backgroundColor = color;

                var colorType = document.getElementsByClassName(self.options.colorPickerClass)[0].getAttribute('data-cptype');
                switch(colorType) {
                    case 'forecolor':
                        self.setForeColorButtonValue(color);
                        self.selector.foreColor(color);
                        break;
                    case 'bgcolor':
                        self.setBgColorButtonValue(color);
                        self.selector.backColor(color);
                        break;
                }
            }
            e.stopPropagation();
            e.preventDefault();
        }

        function handlerOnColorSubmit(e) {
            var color = document.getElementsByClassName('color-picker-rgb-square')[0].style.backgroundColor;
            var colorType = document.getElementsByClassName(self.options.colorPickerClass)[0].getAttribute('data-cptype');
            switch(colorType) {
                case 'forecolor':
                    self.setForeColorButtonValue(color);
                    self.selector.foreColor(color);
                    break;
                case 'bgcolor':
                    self.setBgColorButtonValue(color);
                    self.selector.backColor(color);
                    break;
            }
            self.updateRecentColors(colorType, color);
            (document.getElementsByClassName(self.options.groupClass+'-cont-color-picker')[0]).classList.add(self.options.hiddenClass);
            e.preventDefault();
        }

        function createColorPickerOnSpectrum() {
            var cpSpectrum=document.createElement('DIV');
            cpSpectrum.classList.add(self.options.groupClass+'-cont');
            cpSpectrum.classList.add(self.options.groupClass+'-cont-color-picker');

            cpSpectrum.classList.add(self.options.hiddenClass);

            canvas=document.createElement('CANVAS');

            canvas.width = width;
            canvas.height = height;
            canvas.id = 'color-spectrum';


            context = canvas.getContext('2d');

            canvas.strokeStyle = '#444';
            canvas.lineWidth = 2;

            canvas.addEventListener('touchstart', handlerOnColorSpectrumTouch, false);
            canvas.addEventListener('touchmove', handlerOnColorSpectrumTouch, false);

            // Add color spectrum gradient
            var grd = context.createLinearGradient(0, 0, 224, 0);
            grd.addColorStop(0,    "rgb(255,   0,   0)");
            grd.addColorStop(0.15, "rgb(255,   0, 255)");
            grd.addColorStop(0.33, "rgb(0,     0, 255)");
            grd.addColorStop(0.49, "rgb(0,   255, 255)");
            grd.addColorStop(0.67, "rgb(0,   255,   0)");
            grd.addColorStop(0.84, "rgb(255, 255,   0)");
            grd.addColorStop(1,    "rgb(255,   0,   0)");
            // Apply gradient to canvas
            context.fillStyle = grd;
            context.fillRect(0, 0, 224, 100);


            // Add white-transparent-black gradient
            grd = context.createLinearGradient(0, 0, 0, 100);
            grd.addColorStop(0,   "rgba(255, 255, 255, 1)");
            grd.addColorStop(0.5, "rgba(255, 255, 255, 0)");
            grd.addColorStop(0.5, "rgba(0,     0,   0, 0)");
            grd.addColorStop(1,   "rgba(0,     0,   0, 1)");
            // Apply gradient to canvas
            context.fillStyle = grd;
            context.fillRect(0, 0, 224, 100);

            cpSpectrum.appendChild(canvas);

            var colorRGBcode = document.createElement('div');
            colorRGBcode.classList.add('color-picker-rgb-code');
            cpSpectrum.appendChild(colorRGBcode);

            var submitBtn=document.createElement('BUTTON');
            submitBtn.type='button';
            submitBtn.classList.add('button', 'btn-blue');
            submitBtn.innerHTML= 'OK';
            submitBtn.addEventListener('touchend', handlerOnColorSubmit);
            cpSpectrum.appendChild(submitBtn);

            var colorRGBsquare = document.createElement('div');
            colorRGBsquare.classList.add('color-picker-rgb-square');
            cpSpectrum.appendChild(colorRGBsquare);


            return cpSpectrum;
        }

        return {
            build: createColorPickerOnSpectrum,
        }
    })();

    self.setForeColorButtonValue=function(val) {
        var btn=_buttons['color'];
        var btn2=document.querySelector('a[data-cptype="forecolor"]');
        if(!btn || !btn.el) return;
        if(!btn2) return;

        var elem=btn.el.getElementsByClassName('ico-fore')[0];
        var elem2=btn2.firstChild;
        if(!val) {
            elem.style.fill=null;
            elem2.style.fill=null;
        } else {
            elem.style.fill = val;
            elem2.style.fill = val;
        }
    }
    self.setBgColorButtonValue=function(val) {
        var btn=_buttons['color'];
        var btn2=document.querySelector('a[data-cptype="bgcolor"]');
        if(!btn || !btn.el) return;
        if(!btn2) return;

        var elem=btn.el.getElementsByClassName('ico-bg')[0];
        var elem2=btn2.firstChild;
        if(!val) {
            elem.style.fill=null;
            elem2.style.fill=null;
        } else {
            elem.style.fill=val;
            elem2.style.fill=val;
        }
    }

    self.updateRecentColors=function(colorType, colorVal) {
        var localStorageName = colorType == 'forecolor' ? 'recent_fcolors' : 'recent_bgcolors';
        var elementClass = colorType == 'forecolor' ? 'recent-forecolors' : 'recent-bgcolors';
        var recentColors = localStorage.getItem(localStorageName);
        if(recentColors != null) {
            recentColors = JSON.parse(recentColors);
        } else {
            recentColors = [];
        }

        recentColors.unshift(colorVal);

        if(recentColors.length > self.options.recentColorsStorage) recentColors = recentColors.slice(0, self.options.recentColorsStorage-1);
        localStorage.setItem(localStorageName, JSON.stringify(recentColors));

        var paletteItems = document.querySelectorAll('.' + elementClass + ' a');
        var paletteLength = paletteItems.length;
        if(paletteLength >= self.options.recentColorsStorage-1){
            var i = paletteLength-1;
            while(i>=self.options.recentColorsStorage-1) {
                paletteItems[i].parentNode.removeChild(paletteItems[i]);
                --i;
            }
        }

        var btn=document.createElement('A');
        btn.innerHTML='&nbsp;';
        btn.style.backgroundColor=colorVal;
        btn.setAttribute('data-id',colorVal);
        btn.addEventListener('click',self.handlerOnColorSelect);

        var palette = document.getElementsByClassName(elementClass)[0];
        if(palette.firstChild != null) {
            palette.insertBefore(btn, palette.firstChild);
        } else palette.appendChild(btn)
    }

    self.createFindAndReplaceBox=function() {
        var findAndReplaceDialog=document.createElement('DIV');
        findAndReplaceDialog.classList.add(self.options.groupClass+'-cont');
        findAndReplaceDialog.classList.add(self.options.groupClass+'-cont-find');

        findAndReplaceDialog.classList.add(self.options.hiddenClass);

        var searchForm = document.createElement('FORM');
        searchForm.method = "GET";


        var findBox=document.createElement('DIV');
        findBox.className = 'find-box';

        var inputCon=document.createElement('DIV');
        inputCon.classList.add('input-group');
        var searchInput = document.createElement('INPUT');
        searchInput.type = 'text';
        searchInput.placeholder = 'Search';
        searchInput.className = 'find-input';
        searchInput.addEventListener('keyup', function (e) {
            _findAndReplace = new self.selector.findInText(searchInput.value, findAndReplaceDialog, counter);

            searchInput.focus();
            searchInput.selectionStart = searchInput.value.length;

            e.preventDefault();
            e.stopPropagation();
        })

        var counter=document.createElement('SPAN');
        counter.className = 'match-counter';


        var buttonsCon=document.createElement('SPAN');
        buttonsCon.className = 'input-group-btn';

        var prevBtn=document.createElement('DIV');
        if(_icons['arrowUp']) {
            prevBtn.innerHTML=_icons['arrowUp'];
            prevBtn.classList.add(self.options.btnIconClass);
        } else prevBtn.innerHTML='<span>PREV</span>';

        prevBtn.addEventListener('touchend', function(e){
            _findAndReplace = _findAndReplace.resultsQuantity > 0 ? _findAndReplace.prev() : new self.selector.findInText(searchInput.value, findAndReplaceDialog, counter);
            e.preventDefault();
        });

        var nextBtn=document.createElement('DIV');
        if(_icons['arrowDown']) {
            nextBtn.innerHTML=_icons['arrowDown'];
            nextBtn.classList.add(self.options.btnIconClass);
        } else nextBtn.innerHTML='<span>NEXT</span>';

        nextBtn.addEventListener('touchend', function(e){
            _findAndReplace = _findAndReplace.resultsQuantity > 0 ? _findAndReplace.next() : new self.selector.findInText(searchInput.value, findAndReplaceDialog, counter);
            e.preventDefault();
        });

        var showReplaceBtn=document.createElement('DIV');
        if(_icons['threeDots']) {
            showReplaceBtn.innerHTML=_icons['threeDots'];
            showReplaceBtn.classList.add(self.options.btnIconClass);
        } else showReplaceBtn.innerHTML='<span>Replace</span>';


        var replaceBox=document.createElement('DIV');
        replaceBox.classList.add('replace-box', self.options.hiddenClass);

        showReplaceBtn.addEventListener('touchend', function(e){
            if(replaceBox.classList.contains(self.options.hiddenClass)){
                replaceBox.classList.remove(self.options.hiddenClass);
            } else replaceBox.classList.add(self.options.hiddenClass);
            e.preventDefault();
        });

        var replaceInnerBox=document.createElement('DIV');
        replaceInnerBox.className = 'replace-inner-box';
        var replaceInputCon=document.createElement('DIV');
        replaceInputCon.classList.add('input-group');
        var replaceInput = document.createElement('INPUT');
        replaceInput.type = 'text';
        replaceInput.placeholder = 'Replace with';
        replaceInput.className = 'replace-input';

        var replaceBtnsCon=document.createElement('SPAN');
        replaceBtnsCon.className = 'input-group-btn';

        var replaceBtn=document.createElement('DIV');
        if(_icons['replace']) {
            replaceBtn.innerHTML=_icons['replace'];
            replaceBtn.classList.add(self.options.btnIconClass);
        } else replaceBtn.innerHTML='<span>Replace</span>';

        replaceBtn.addEventListener('touchend', function(e){
            _findAndReplace = _findAndReplace.resultsQuantity > 0 ? _findAndReplace.replaceCurrentMatch(replaceInput.value) : new self.selector.findInText(searchInput.value, findAndReplaceDialog, counter);
            e.preventDefault();
        });

        var replaceAllBtn=document.createElement('DIV');
        if(_icons['replaceAll']) {
            replaceAllBtn.innerHTML=_icons['replaceAll'];
            replaceAllBtn.classList.add(self.options.btnIconClass);
        } else replaceAllBtn.innerHTML='<span>Replace All</span>';

        replaceAllBtn.addEventListener('touchend', function(e){
            _findAndReplace = _findAndReplace.resultsQuantity > 0 ? _findAndReplace.replaceAll(replaceInput.value) : new self.selector.findInText(searchInput.value, findAndReplaceDialog, counter);
            e.preventDefault();
        });

        inputCon.appendChild(searchInput);
        inputCon.appendChild(counter);
        buttonsCon.appendChild(prevBtn);
        buttonsCon.appendChild(nextBtn);
        buttonsCon.appendChild(showReplaceBtn);
        findBox.appendChild(inputCon);
        findBox.appendChild(buttonsCon);
        searchForm.appendChild(findBox);


        replaceInputCon.appendChild(replaceInput);
        replaceBtnsCon.appendChild(replaceBtn);
        replaceBtnsCon.appendChild(replaceAllBtn);
        replaceInnerBox.appendChild(replaceInputCon);
        replaceInnerBox.appendChild(replaceBtnsCon);
        replaceBox.appendChild(replaceInnerBox);
        searchForm.appendChild(replaceBox);
        findAndReplaceDialog.appendChild(searchForm);

        return {
            el: function () {
                return findAndReplaceDialog;
            },
            submit: function () {
                _findAndReplace = new self.selector.findInText(searchInput.value, findAndReplaceDialog, counter);
            }
        };
    }

    self.runSearch = function (query) {
        var queryInput = window.editor.findAndReplace.el().querySelector('.find-input');
        var counter = window.editor.findAndReplace.el().querySelector('.match-counter');
        queryInput.value = query;
        _findAndReplace = new self.selector.findInText(queryInput.value, window.editor.findAndReplace.el(), counter);
    }

    self.hideAllGroups=function() {
        if(_debug) console.log('self.hideAllGroups');
        var els=document.getElementsByClassName(self.options.groupClass+'-cont'),i,el;
        for(i=0;i<els.length;i++) {
            el=els[i];
            el.classList.add(self.options.hiddenClass);
            el.style.position=null;
            //el.style.left=null;
            el.style.top=null;
        }
        _activeGroup=null;
    }
    self.hasOpenedGroup=function() {
        var els=document.querySelectorAll('.' + self.options.groupClass+'-cont:not(.' + self.options.hiddenClass + ')'),i,el;
        if(_debug) console.log('self.hasOpenedGroup', els.length);

        return els.length>0;
    }


    self.applyFunction=function(func,param) {
        if(_debug) console.log('self.applyFunction', func);
        var funcObj=_buttons[func];
        if(!funcObj) return;
        _currentFunc=func;
        var tagName=funcObj.tag;

        if(funcObj.group) {
            if(!funcObj.cont) return;
            if(funcObj.cont.classList.contains(self.options.hiddenClass)) {

                self.hideAllGroups();
                funcObj.cont.classList.remove(self.options.hiddenClass);

                /* if(funcObj.cont.scrollHeight > funcObj.cont.clientHeight) //commented 28.03.24
                    funcObj.cont.classList.add(self.options.scrollableClass);
                else
                    funcObj.cont.classList.remove(self.options.scrollableClass); */
                _activeGroup=funcObj.cont;
                //for android (safari does scroll automatically)
                if(!self.options.iOSfixedToAbsolute) self.handlerOnScroll();
            } else {
                funcObj.cont.classList.add(self.options.hiddenClass);
                if(!self.hasOpenedGroup()) self.selector.toolbarGroupClosed();
            }

            if(!self.hasOpenedGroup()) self.selector.toolbarGroupClosed();
            if(self.hasOpenedGroup()) self.selector.toolbarGroupOpened()

            if(_isiOS && _keyboardVisible && (func == 'font' || func == 'size' || func == 'format')) {
                var innerHeight = window.innerHeight;
                if(innerHeight < 500)
                    funcObj.cont.style.maxHeight = '155px';
                else if(innerHeight >= 500 && innerHeight < 550)
                    funcObj.cont.style.maxHeight = '165px';
            }

            self.handlerOnScroll();
            return;

        } else if (funcObj.dropDialogue) {
            if(!funcObj.cont) return;
            if(funcObj.cont.classList.contains(self.options.hiddenClass)) {

                self.hideAllGroups();
                funcObj.cont.classList.remove(self.options.hiddenClass);

                /* if(funcObj.cont.scrollHeight > funcObj.cont.clientHeight) //28.03.24
                    funcObj.cont.classList.add(self.options.scrollableClass);
                else
                    funcObj.cont.classList.remove(self.options.scrollableClass); */
                _activeGroup=funcObj.cont;
                if(!self.options.iOSfixedToAbsolute) self.handlerOnScroll();

            } else {
                funcObj.cont.classList.add(self.options.hiddenClass);
            }

            if(!self.hasOpenedGroup()) self.selector.toolbarGroupClosed();
            if(self.hasOpenedGroup()) self.selector.toolbarGroupOpened();
            self.handlerOnScroll();
            return;
        }

        //Hide all groups on any function
        self.hideAllGroups();

        if(funcObj.spec) {
            switch(funcObj.spec) {
                case 'color':
                    //self.createColorPicker();
                    break;
                case 'format':
                    //self.selector.removeFormat(_formatTags);
                    self.selector.formatBlock(param);
                    break;
                case 'copy':
                    self.selector.copyText();
                    break;
                case 'paste':
                    //TODO
                    //we need some Cordova based pasting here
                    self.selector.pasteText();
                    break;
                case 'cut':
                    self.selector.cutText();
                    break;
                case 'left':
                    self.selector.alignLeft();
                    break;
                case 'right':
                    self.selector.alignRight();
                    break;
                case 'center':
                    self.selector.alignCenter();
                    break;
                case 'justify':
                    self.selector.alignJustify();
                    break;
                case 'ul':
                    self.selector.insertUL();
                    break;
                case 'ol':
                    self.selector.insertOL();
                    break;
                case 'fontname':
                    self.selector.applyFont(param);
                    break;
                case 'fontsize':
                    self.selector.applySize(param);
                    break;
                case 'customfontsize':
                    self.showSizeDialogue();
                    break;
                case 'html':
                    self.toggleHtmlMode();
                    return;
                    break;
                case 'undo':
                    self.selector.undo();
                    break;
                case 'redo':
                    self.selector.redo();
                    break;
                case 'help':
                    self.helpDialog().show();
                    break;
                case 'htmleditor':
                    self.editorPromoDialog().show();
                    break;
                case 'img':
                    self.showImgDialogue();
                    break;
                case 'link':
                    self.showHrefDialogue();
                    break;
                case 'template':
                    self.selector.insertTemplateProperty(param);
                    break;
            }
        } else if(tagName) {
            if(self.checkIfApplied(tagName)) {

                self.selector.unwrapSelection(tagName);
            } else {

                self.selector.wrapSelection(tagName);
            }
        }
        self.updateButtonsOnSelection();
    }

    self.checkIfApplied=function(tagName,param,value) {
        return self.selector.checkWrapped(tagName,param,value);
    }

    self.checkIfContains=function(tagName,param,value) {
        return self.selector.contains(tagName,param,value);
    }

    self.updateButtonsOnSelection=function(setTo) {
        // if(_container.classList.contains(self.options.htmlModeClass)) return;
        var isEmpty=self.selector.isEmpty;
        var isKbActive=document.querySelector('.editarea:focus') != null || document.activeElement == self.area;

        var res,btn;
        loop1:
            for(var func in _buttons) {
                btn=_buttons[func];

                if(btn.selOnly && btn.kbOnly) {
                    if(isEmpty && !isKbActive) {
                        btn.el.classList.add(self.options.hiddenClass);
                    } else {
                        btn.el.classList.remove(self.options.hiddenClass);
                    }
                } else if (btn.selOnly || btn.kbOnly) {
                    if(isEmpty) {
                        btn.el.classList.add(self.options.hiddenClass);
                    } else {
                        btn.el.classList.remove(self.options.hiddenClass);
                    }
                }

                if(!btn||!btn.el||btn.group) continue;

                switch(btn.spec) {
                    case 'paste':
                        if(self.selector.hasBuffer()) {
                            btn.el.classList.remove(self.options.hiddenClass);
                        } else {
                            btn.el.classList.add(self.options.hiddenClass);
                        }
                        continue loop1;
                    case 'redo':
                        if(self.selector.canRedo()) {
                            btn.el.classList.remove(self.options.hiddenClass);
                        } else {
                            btn.el.classList.add(self.options.hiddenClass);
                        }
                        continue loop1;
                    case 'undo':
                        if(self.selector.canUndo())
                            btn.el.classList.remove(self.options.hiddenClass);
                        else
                            btn.el.classList.add(self.options.hiddenClass);
                        continue loop1;
                    case 'html':
                        continue loop1;
                }
                if(btn.options) {
                    if(!btn.options.length) continue;
                    if(setTo===false) {
                        btn.el.value=btn.default;
                        continue;
                    }
                    var i,opt,check;
                    for(i=0;i<btn.options.length;i++) {
                        opt=btn.options[i];

                        if(btn.tag && btn.par) {
                            check=self.checkIfContains(btn.tag,btn.par,opt.val)
                            if(check) {
                                if(check.wrapped) btn.el.value=opt.val;
                                else btn.el.value='other';
                                continue loop1;
                            }
                        } else {
                            check=self.checkIfContains(opt.val)
                            if(check) {
                                if(check.wrapped) btn.el.value=opt.val;
                                else btn.el.value='other';
                                continue loop1;
                            }
                        }
                    }
                    btn.el.value=btn.default;
                    continue;
                }
                if(btn.tag) {
                    res=typeof setTo!='undefined'?setTo:self.checkIfApplied(btn.tag,btn.par,typeof btn.parVal!='undefined'?btn.parVal:btn.val);

                    btn.active=res;

                    if(res) {
                        btn.el.classList.add(self.options.btnActiveClass);
                    } else {
                        btn.el.classList.remove(self.options.btnActiveClass);
                    }
                }
                if(func == 'left' || func == 'center' || func == 'right' || func == 'justify') {
                    res=typeof setTo!='undefined'?setTo:self.checkIfApplied('P','style',{prop:'textAlign', value:func});

                    if(func == 'left') res=typeof setTo!='undefined'?setTo:self.checkIfApplied('P','style',{prop:'textAlign', value:''});

                    btn.active=res;

                    if(res) {
                        btn.el.classList.add(self.options.btnActiveClass);
                    } else {
                        btn.el.classList.remove(self.options.btnActiveClass);
                    }
                }
                if(func == 'color') {

                    var params = [{tag:'FONT', par: 'color'}, {tag:'SPAN', par: 'style'}];

                    for(var k in params) {
                        res = typeof setTo != 'undefined' ? setTo : self.checkIfApplied(params[k].tag, params[k].par, typeof btn.parVal != 'undefined' ? btn.dropDialogue.parVal : btn.dropDialogue.val);
                        if(params[k].par == 'color') {
                            if (res && typeof res == 'object') {
                                self.setForeColorButtonValue(res.val);
                                res = true;
                            } else {
                                self.setForeColorButtonValue(null);
                                res = false;
                            }
                        } else if (params[k].par == 'style') {
                            if (res && typeof res == 'object') {
                                self.setBgColorButtonValue(res.val.replace(/background-color\: /, '').replace(/[\s;]/g, ''));
                                res = true;
                            } else {
                                self.setBgColorButtonValue(null);
                                res = false;
                            }
                        }

                        btn.active = res;

                        if (res) {
                            btn.el.classList.add(self.options.btnActiveClass);
                        } else {
                            btn.el.classList.remove(self.options.btnActiveClass);
                        }
                    }
                }
                if(func == 'img') {
                    self.imageResizing.update()
                }
                if(func == 'help') {
                    if(isEmpty && document.querySelector('.editarea:focus') == null) {
                        btn.el.classList.remove(self.options.hiddenClass);
                    } else {
                        btn.el.classList.add(self.options.hiddenClass);
                    }
                }

            }

        //if only a few tools are visible, it will make them centralized
        self.updateToolbarAlignment(isEmpty, isKbActive)

    }

    self.updateToolbarAlignment = function(isEmpty, isKbActive) {
        if(_debug){
            try {
                var err = (new Error);
                console.log(err.stack);
            } catch (e) {

            }
        }
        if(isEmpty == null) isEmpty = self.selector.isEmpty;
        if(isKbActive == null) isKbActive = document.querySelector('.editarea:focus') != null;

        var windowWidth = window.innerWidth;
        var visibleBtnsWidth = 0;

        var toolEl, i;
        for(i = 0; toolEl = _bar.firstChild.childNodes[i]; i++){
            var toolRecft =  toolEl.getBoundingClientRect();
            if(toolRecft.width == 0)  continue;
            visibleBtnsWidth = visibleBtnsWidth+toolRecft.width;
        }

        if(isEmpty && !isKbActive && windowWidth > visibleBtnsWidth) {
            var paddingLeft = (windowWidth - visibleBtnsWidth) / 2;
            _bar.firstChild.style.paddingLeft = paddingLeft + 'px';
            _bar.firstChild.style.left = '';
            _bar.scrollLeft = 0;
        } else  {
            _bar.firstChild.style.paddingLeft = '';
        }
    }

    self.getActiveButtons=function() {
        var arr=[],btn;
        for(var func in _buttons) {
            btn=_buttons[func];
            if(!btn||!btn.active) continue;
            arr.push(btn.tag);
        }
        return arr;
    }

    self.findAndReplaceLink=function(e) {
        var range = self.selector.range;
        var node = range.startContainer;
        var offset = range.startOffset;
        var textLink = (range.startContainer.textContent).substring(0, range.startOffset).lastIndexOf("http");

        if(textLink == -1) return;

        var linkEnd = node.nodeValue.indexOf(' ', textLink);
        var linkEndIndex = linkEnd != -1 ? linkEnd : offset;
        var lastpart = (self.selector.startElement).splitText(linkEndIndex);
        var entireLink = (self.selector.startElement).splitText(textLink);

        var protocol = entireLink.nodeValue.indexOf("//");

        if(protocol == -1) return;

        self.selector.stateSave();

        var link = document.createElement('a');
        link.setAttribute('href', entireLink.nodeValue);
        var linkText = entireLink.nodeValue.substring(protocol + 2, entireLink.length);

        if(linkText == "") return;

        link.appendChild(document.createTextNode(linkText));

        //(self.selector.startElement.parentNode).removeChild(entireLink);
        //self.selector.insertLink(entireLink.nodeValue, linkText);
        (self.selector.startElement.parentNode).replaceChild(link, entireLink);

        var sel, range;
        range = document.createRange();
        range.setStartAfter(link);
        range.collapse(true);
        sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
    }

    self.removeLinkIfExists=function() {
        var linkText = self.selector.range.commonAncestorContainer;
        var offset = self.selector.range.startOffset;
        if(linkText.nodeValue.indexOf(' ') != -1 || offset == 0 ||offset == linkText.length) return;

        self.selector.stateSave();

        linkText.parentNode.parentNode.replaceChild(linkText, linkText.parentNode);
        self.selector.setCaret(linkText, offset);
    }

    self.insertLinebreak=function(e) {
        if(_debug) console.log('self.insertLinebreak');
        var tags=self.getActiveButtons();

        var i;
        var useDefault=false;
        for(i=0;i<tags.length;i++) {
            switch(tags[i]) {
                case 'OL':
                case 'UL':
                    useDefault=true;
                    break;
            }
        }
        if(useDefault) {
            return;
        }

        document.querySelector('.' + self.options.htmlClass).setAttribute('autocapitalize', 'characters');
        e.preventDefault();

        self.selector.insertLinebreak(tags);

    }

    function getTextBoundingRect(input, selectionStart, selectionEnd, debug) {
        // Basic parameter validation
        if(!input || !('value' in input)) return input;
        if(typeof selectionStart == "string") selectionStart = parseFloat(selectionStart);
        if(typeof selectionStart != "number" || isNaN(selectionStart)) {
            selectionStart = 0;
        }
        if(selectionStart < 0) selectionStart = 0;
        else selectionStart = Math.min(input.value.length, selectionStart);
        if(typeof selectionEnd == "string") selectionEnd = parseFloat(selectionEnd);
        if(typeof selectionEnd != "number" || isNaN(selectionEnd) || selectionEnd < selectionStart) {
            selectionEnd = selectionStart;
        }
        if (selectionEnd < 0) selectionEnd = 0;
        else selectionEnd = Math.min(input.value.length, selectionEnd);

        // If available (thus IE), use the createTextRange method
        if (typeof input.createTextRange == "function") {
            var range = input.createTextRange();
            range.collapse(true);
            range.moveStart('character', selectionStart);
            range.moveEnd('character', selectionEnd - selectionStart);
            return range.getBoundingClientRect();
        }
        // createTextRange is not supported, create a fake text range
        var offset = getInputOffset(),
            topPos = offset.top,
            leftPos = offset.left,
            width = getInputCSS('width', true) - getInputCSS('padding-left', true) - getInputCSS('padding-right', true),
            height = getInputCSS('height', true);

        // Styles to simulate a node in an input field
        var cssDefaultStyles = "white-space:pre;padding:0;margin:0;",
            listOfModifiers = ['white-space', 'direction', 'font-family', 'font-size', 'font-size-adjust', 'font-variant', 'font-weight', 'font-style', 'letter-spacing', 'line-height', 'text-align', 'text-indent', 'text-transform', 'word-wrap', 'word-spacing'];

        topPos += getInputCSS('padding-top', true);
        topPos += getInputCSS('border-top-width', true);
        leftPos += getInputCSS('padding-left', true);
        leftPos += getInputCSS('border-left-width', true);
        leftPos += 1; //Seems to be necessary

        for (var i=0; i<listOfModifiers.length; i++) {
            var property = listOfModifiers[i];
            cssDefaultStyles += property + ':' + getInputCSS(property) +';';
        }
        // End of CSS variable checks

        var text = input.value,
            textLen = text.length,
            fakeClone = document.createElement("div");
        fakeClone.textContent = text;
        // Styles to inherit the font styles of the element
        fakeClone.style.cssText = cssDefaultStyles;

        // Styles to position the text node at the desired position
        fakeClone.style.position = "absolute";
        fakeClone.style.top = topPos + "px";
        fakeClone.style.left = leftPos + "px";
        fakeClone.style.width = width + "px";
        fakeClone.style.height = height + "px";
        document.body.appendChild(fakeClone);

        var range = document.createRange();
        range.setStart(fakeClone.firstChild, selectionStart)
        range.setEnd(fakeClone.firstChild, selectionEnd)

        if (!debug) fakeClone.parentNode.removeChild(fakeClone); //Remove temp
        return range.getClientRects();


        // Computing offset position
        function getInputOffset(){
            var body = document.body,
                win = document.defaultView,
                docElem = document.documentElement,
                box = document.createElement('div');
            box.style.paddingLeft = box.style.width = "1px";
            body.appendChild(box);
            var isBoxModel = box.offsetWidth == 2;
            body.removeChild(box);
            box = input.getBoundingClientRect();
            var clientTop  = docElem.clientTop  || body.clientTop  || 0,
                clientLeft = docElem.clientLeft || body.clientLeft || 0,
                scrollTop  = win.pageYOffset || isBoxModel && docElem.scrollTop  || body.scrollTop,
                scrollLeft = win.pageXOffset || isBoxModel && docElem.scrollLeft || body.scrollLeft;
            return {
                top : box.top  + scrollTop  - clientTop,
                left: box.left + scrollLeft - clientLeft};
        }
        function getInputCSS(prop, isnumber){
            var val = document.defaultView.getComputedStyle(input, null).getPropertyValue(prop);
            return isnumber ? parseFloat(val) : val;
        }
    }

    self.toggleHtmlMode=function() {
        _htmlMode=!_htmlMode;

        if(_htmlMode) {
            _html.value=self.area.innerHTML;

            self.selector.deselect();
            self.selector.disable(true);
            _container.classList.add(self.options.htmlModeClass);

            self.imageResizing.disableAutoUpdating();
            self.updateButtonsOnSelection();
            setTimeout(function () {
                self.updateToolbarAlignment(true, false);
            }, 1000)

            window.scrollTo(0, 0);

            self.resizeHtmlArea();

            if(_html.value.trim() == '') return;


            //restore cursor position
            var rawRange = self.selector.restoreScrollTop();
            var barRect = _bar.getBoundingClientRect();

            var scrollAreaTop;
            if(rawRange) {
                _buttons['html'].el.classList.add(self.options.btnActiveClass);

                var offsetStart = _html.value.indexOf(rawRange.startContainerValue) + rawRange.startOffset;

                var coords = getTextBoundingRect(_html, offsetStart != -1 ? offsetStart : 0, rawRange.endOffset, false);

                scrollAreaTop = coords.top;
            } else {
                var range = document.caretRangeFromPoint(20, barRect.bottom + 8)

                var topRawNode
                if(range.startContainer.nodeType == 3)
                    topRawNode = range.startContainer.textContent;
                else if(range.startContainer.nodeType == 1)
                    topRawNode = range.startContainer.innerHTML;

                var startContainerValue;
                if(topRawNode) startContainerValue = topRawNode;

                var offsetStart = _html.value.indexOf(startContainerValue);
                offsetStart = offsetStart != -1 ? offsetStart : 0;
                var coords = getTextBoundingRect(_html, offsetStart, offsetStart, false);

                scrollAreaTop = coords.top;
            }

            _html.scrollTop = scrollAreaTop;

            setTimeout(function () {
                _html.blur()
            }, 500)

            if(rawRange && rawRange.startOffset != 0) {
                _html.selectionStart = offsetStart != -1 ? offsetStart : 0;
                _html.selectionEnd = offsetStart != -1 ? offsetStart : 0;
            }

        } else {
            self.selector.disable(false);
            var html=_html.value.replace(/\&gt;/g,'>').replace(/&lt;/g,'<');
            self.area.innerHTML=html;
            _html.innerHTML='';
            _container.classList.remove(self.options.htmlModeClass);
            _buttons['html'].el.classList.remove(self.options.btnActiveClass);
            if(_kb) _kb.style.display='';

            self.imageResizing.enableAutoUpdating();
        }

    }
    self.resizeHtmlArea=function(e) {
        if(_debug) console.log('self.resizeHtmlArea');
        _html.style.width='';
        _html.style.height='';
        _html.style.height=_html.scrollHeight+'px';
        _html.style.width=_container.offsetWidth+'px';
    }

    self.showImgDialogue=function() {
        if(_debug) console.log('self.showImgDialogue');
        self.closeAllDialogues();
        self.dialogIsOpened();
        self.selector.disable(true);
        self.area.blur();

        var val=self.selector.getText();
        var selectedImg=self.selector.contains('IMG');
        if(selectedImg) {
            self.selector.selectNode(selectedImg);
        }

        var bg=document.createElement('DIV');
        bg.classList.add(self.options.dialogueBgClass);

        var dialogCon=document.createElement('DIV');
        dialogCon.classList.add(self.options.dialogueConClass);
        bg.addEventListener('touchend', function (e){
            e.stopPropagation();
            if(e.currentTarget == e.target)self.closeAllDialogues();
        });

        var el=document.createElement('DIV');
        el.classList.add(self.options.dialogueClass);
        el.classList.add(self.options.imgDialogueClass);
        var form=document.createElement('FORM');
        el.appendChild(form);

        var close=document.createElement('div');
        close.classList.add('close-dialog-sign')
        form.appendChild(close);
        close.addEventListener('click',function (){self.onImageCancel();self.selector.deselect();});

        var p=document.createElement('H2');
        p.innerHTML=selectedImg?'Update image':'Add image';
        form.appendChild(p);

        if(self.options.useFormLabels) {
            var p=document.createElement('H3');
            p.innerHTML='Enter URL:';
            form.appendChild(p);
        }

        var inputCon=document.createElement('DIV');
        inputCon.classList.add('input-group', 'img-src', 'no-button');

        var dataUrlImg=document.createElement('DIV');
        dataUrlImg.classList.add('dataurl-img-icon');
        inputCon.appendChild(dataUrlImg);

        var input=document.createElement('INPUT'),url=input;
        input.type='text';
        input.name='URL';
        input.required= selectedImg == null ? 'required' : ''
        input.placeholder='Paste a link or tap >';
        input.addEventListener('change', function (e) {
            if(e.target.value != "")
                form.querySelector('button[type="submit"]').disabled = false;
            else
                form.querySelector('button[type="submit"]').disabled = 'disabled';
            if(inputCon.classList.contains('no-button')) url.parentNode.classList.remove('no-button');
        });
        inputCon.appendChild(input);




        var cordovaBrowseCon = document.createElement('SPAN');
        cordovaBrowseCon.classList.add('input-group-btn')
        cordovaBrowseCon.style.display = selectedImg ? 'none' : '';

        var fileInputLabel=document.createElement('LABEL');
        fileInputLabel.classList.add('file-input');
        fileInputLabel.innerHTML = _icons.choosePhoto;
        var fileInput=document.createElement('INPUT');
        fileInput.type='file';
        fileInput.name='imgFile';
        fileInput.class='imgFile';
        fileInput.addEventListener('change', function (e) {
            if(!url.parentElement.classList.contains('no-button')) url.parentElement.classList.add('no-button');
            url.required = false;
            clearImgUrl.style.display = 'block';
            if(cordovaBrowseCon != null) {
                cordovaBrowseCon.style.display = 'none';
            }

            if (window.File && window.FileReader && window.FileList && window.Blob) {
                var files = e.target.files; // FileList object
                var file = files[0];



                var reader = new FileReader();

                // Closure to capture the file information.
                reader.onload = (function(theFile) {
                    return function(e) {
                        var dataUrlImg = document.querySelector('.dataurl-img-icon');
                        var i = new Image();

                        i.onload = function(){
                            dataUrlImg.innerHTML = '<span>' + i.width + 'x' + i.height + ' image</span>';
                        };
                        i.src = e.target.result;
                        url.style.display = 'none';
                        dataUrlImg.style.display = 'flex';
                    };
                })(file);

                // Read in the image file as a data URL.
                reader.readAsDataURL(file);


            } else url.value=this.value.replace(/^.*[\\\/]/, '');

            if(e.target.files.length != 0) {
                form.querySelector('button[type="submit"]').disabled = false;
                url.required = false;
            }

            alt.value=this.value.replace(/^.*[\\\/]/, '');
        });
        fileInputLabel.appendChild(fileInput);
        cordovaBrowseCon.appendChild(fileInputLabel);

        if(typeof Q != 'undefined' && Q.Cordova != null && _isiOS) {
            for (var key in self.options.imgUrlChooser) {

                if (self.options.imgUrlChooser.hasOwnProperty(key)) {
                    var cordovaBrowse = document.createElement('BUTTON');
                    cordovaBrowse.type = 'button';
                    //cordovaBrowse.classList.add('button', 'btn-blue');
                    cordovaBrowse.innerHTML = _icons[self.options.imgUrlChooser[key].icon];
                    cordovaBrowse.setAttribute('data-url',  self.options.imgUrlChooser[key].url);
                    cordovaBrowse.setAttribute('title',  'Choose from: ' + key);
                    cordovaBrowse.addEventListener('touchend', function (e) {
                        Q.Cordova.chooseImage(
                            e.currentTarget.getAttribute('data-url'),
                            function (dataUrl) {
                                var srcValue =  document.getElementsByClassName(self.options.imgDialogueClass)[0].querySelector('input[name=URL]');
                                srcValue.value = dataUrl;
                                form.querySelector('button[type="submit"]').disabled = false;
                                if(inputCon.classList.contains('no-button')) srcValue.parentNode.classList.remove('no-button');
                            },
                            function (error) {
                                try {
                                    var imgUrl = error;
                                    var i = new Image();

                                    i.onload = function(){
                                        if(i.width == null && i.height == null) return;
                                        var srcValue =  document.getElementsByClassName(self.options.imgDialogueClass)[0].querySelector('input[name=URL]');
                                        srcValue.value = imgUrl;
                                        form.querySelector('button[type="submit"]').disabled = false;
                                        if(inputCon.classList.contains('no-button')) srcValue.parentNode.classList.remove('no-button');

                                    };
                                    i.src = imgUrl;

                                } catch (e) {
                                    alert(error);
                                }

                            }
                        );
                    });


                    cordovaBrowseCon.appendChild(cordovaBrowse);

                }
            }
        }
        inputCon.appendChild(cordovaBrowseCon);
        /* else if (!selectedImg){
            inputCon.classList.add('no-button');
        }*/
        form.appendChild(inputCon);


        var clearImgUrl = document.createElement('SPAN');
        clearImgUrl.classList.add('input-group-addon');

        var circle = document.createElement('SPAN');
        circle.className = 'clear-input-value';
        circle.innerHTML = _icons.closeCircle;
        clearImgUrl.appendChild(circle);
        clearImgUrl.addEventListener('touchend', function () {
            this.style.display = 'none';
            url.value = '';
            fileInput.value = '';
            url.parentElement.classList.add('no-button');
            dataUrlImg.style.display = '';
            url.style.display = '';
            if(cordovaBrowseCon != null) {
                if(cordovaBrowseCon.style.display == 'none') {
                    cordovaBrowseCon.style.display = '';
                } else cordovaBrowseCon.style.display = '';
            }

        });
        inputCon.appendChild(clearImgUrl);
        if(!selectedImg) clearImgUrl.style.display = 'none';

        form.appendChild(inputCon);

        if(self.options.useFormLabels) {
            var p=document.createElement('H5');
            p.innerHTML='Image alternative text:';
            form.appendChild(p);
        }

        var inputCon=document.createElement('DIV');
        inputCon.classList.add('form-group');
        var input=document.createElement('INPUT'),alt=input;
        input.type='text';
        input.name='ALT';
        input.placeholder='Alternative text';
        inputCon.appendChild(input);
        form.appendChild(inputCon);

        function setInputDataValue(e){
            e.target.dataset.customValue = e.target.value;
        }

        recentImagesDb().count(function (results) {

            if (_debug) console.log('recentImagesDb().count');
            if(_debug){
                try {
                    var err = (new Error);
                    console.log('recentImagesDb().count', err.stack);
                } catch (e) {

                }
            }
            if (results > 0) {
                var selectImgCon = document.createElement('DIV');
                selectImgCon.classList.add('form-group');
                var recentImages = document.createElement('A');
                recentImages.classList.add('select-recent');
                recentImages.innerHTML = "Choose from recent images";
                recentImages.addEventListener('touchend', function () {
                    self.onSelectRecentImages(form)
                });
                selectImgCon.appendChild(recentImages);
                form.appendChild(selectImgCon);
            }



            var imgAlignCon = document.createElement('DIV');
            imgAlignCon.classList.add('inline-radio-group');

            var noneAlignLabel = document.createElement('LABEL');
            var noneAlign = document.createElement('INPUT');
            //recentImages.classList.add('select-recent');
            noneAlign.name = "imgAlign";
            noneAlign.type = "radio";
            noneAlign.value = "none";
            if((selectedImg && (selectedImg.style.float == null || selectedImg.style.float == 'none')) || !selectedImg) noneAlign.setAttribute('checked', 'checked');
            noneAlignLabel.appendChild(noneAlign);
            noneAlignLabel.appendChild(document.createTextNode(' Inline'));
            imgAlignCon.appendChild(noneAlignLabel);

            var leftAlignLabel = document.createElement('LABEL');
            var leftAlign = document.createElement('INPUT');
            //recentImages.classList.add('select-recent');
            leftAlign.name = "imgAlign";
            leftAlign.type = "radio";
            leftAlign.value = "left";
            if(selectedImg && selectedImg.style.float == 'left') leftAlign.setAttribute('checked', 'checked');
            leftAlignLabel.appendChild(leftAlign);
            leftAlignLabel.appendChild(document.createTextNode(' Left'));
            imgAlignCon.appendChild(leftAlignLabel);

            var rightAlignLabel = document.createElement('LABEL');
            var rightAlign = document.createElement('INPUT');
            //recentImages.classList.add('select-recent');
            rightAlign.name = "imgAlign";
            rightAlign.type = "radio";
            rightAlign.value = "right";
            if(selectedImg && selectedImg.style.float == 'right') rightAlign.setAttribute('checked', 'checked');
            rightAlignLabel.appendChild(rightAlign);
            rightAlignLabel.appendChild(document.createTextNode(' Right'));
            imgAlignCon.appendChild(rightAlignLabel);

            form.appendChild(imgAlignCon);


            var optionTitle = document.createElement('DIV')
            optionTitle.innerText = 'Margin (in pixels)';
            form.appendChild(optionTitle);

            var imgMarginCon = document.createElement('DIV');
            imgMarginCon.classList.add('inline-input-group');

            var topMarginLabel = document.createElement('LABEL');
            var topMargin = document.createElement('INPUT');
            topMargin.name = 'topImgMargin';
            topMargin.type = "text";
            topMargin.value = (selectedImg) ? (selectedImg.style.marginTop).replace("px", "") : '10';
            topMarginLabel.appendChild(document.createTextNode('Top'));
            topMarginLabel.appendChild(topMargin);
            imgMarginCon.appendChild(topMarginLabel);

            var rightMarginLabel = document.createElement('LABEL');
            var rightMargin = document.createElement('INPUT');
            rightMargin.name = 'rightImgMargin';
            rightMargin.type = "text";
            rightMargin.value = (selectedImg) ? (selectedImg.style.marginRight).replace("px", "") : '10';
            if(selectedImg && selectedImg.dataset.marginRight) rightMargin.dataset.customValue = 'true';
            rightMargin.addEventListener('change', setInputDataValue);
            rightMarginLabel.appendChild(document.createTextNode('Right'));
            rightMarginLabel.appendChild(rightMargin);
            imgMarginCon.appendChild(rightMarginLabel);

            var bottomMarginLabel = document.createElement('LABEL');
            var bottomMargin = document.createElement('INPUT');
            bottomMargin.name = 'bottomImgMargin';
            bottomMargin.type = "text";
            bottomMargin.value = (selectedImg) ? (selectedImg.style.marginBottom).replace("px", "") : '10';
            bottomMarginLabel.appendChild(document.createTextNode('Bottom'));
            bottomMarginLabel.appendChild(bottomMargin);
            imgMarginCon.appendChild(bottomMarginLabel);

            var leftMarginLabel = document.createElement('LABEL');
            var leftMargin = document.createElement('INPUT');
            leftMargin.name = 'leftImgMargin';
            leftMargin.type = "text";
            leftMargin.value = (selectedImg) ? (selectedImg.style.marginLeft).replace("px", "") : '10';

            if(selectedImg && selectedImg.dataset.marginLeft) leftMargin.dataset.customValue = 'true';
            leftMargin.addEventListener('change', setInputDataValue);
            leftMarginLabel.appendChild(document.createTextNode('Left'));
            leftMarginLabel.appendChild(leftMargin);
            imgMarginCon.appendChild(leftMarginLabel);

            form.appendChild(imgMarginCon);


            var submitBtn=document.createElement('BUTTON');
            submitBtn.type='submit';
            submitBtn.classList.add('button', 'btn-blue');
            submitBtn.disabled=selectedImg?false:'disabled';
            submitBtn.innerHTML=selectedImg?'Update':'Add';
            form.appendChild(submitBtn);
            form.addEventListener('submit',self.onImageSubmit);


            if(selectedImg) {
                var removeBtn=document.createElement('BUTTON');
                removeBtn.type='button';
                removeBtn.innerHTML = 'Remove image';
                removeBtn.classList.add('button', 'btn-red', 'remove');
                removeBtn.addEventListener('touchend',self.onImgRemove);
                removeBtn.addEventListener('click', function (e) {e.preventDefault()});
                form.appendChild(removeBtn);
            }

        });





        self.changeDialoguesAlingOnTap(url);
        self.changeDialoguesAlingOnTap(alt);

        /*form.addEventListener('touchend',function (e) {
           setTimeout(function () {
                if(e.target.nodeName == 'INPUT') {
                    var vpSize = Math.max(
                        document.body.scrollHeight, document.documentElement.scrollHeight,
                        document.body.offsetHeight, document.documentElement.offsetHeight,
                        document.body.clientHeight, document.documentElement.clientHeight
                    );
                    e.target.offsetParent.parentNode.style.height = vpSize + 'px';
                    e.target.addEventListener('blur', function () {
                        var vpSize = Math.max(
                            document.body.scrollHeight, document.documentElement.scrollHeight,
                            document.body.offsetHeight, document.documentElement.offsetHeight,
                            document.body.clientHeight, document.documentElement.clientHeight
                        );
                        e.target.offsetParent.parentNode.style.height = vpSize + 'px';
                    }, {once:true});
                }
            }, 50)
        });*/

        dialogCon.appendChild(el)
        document.body.appendChild(bg);
        document.body.appendChild(dialogCon);


        self.reposDialogues();


        if(selectedImg) {
            if((selectedImg.src.substring(0,4)) != 'http') {
                var i = new Image();

                i.onload = function(){
                    dataUrlImg.innerHTML = '<span>' + i.width + 'x' + i.height + ' image</span>';
                };

                i.src = selectedImg.src;
                url.style.display = 'none';
                dataUrlImg.style.display = 'flex';
            }
            url.value = selectedImg.src;
            alt.value=selectedImg.alt;
        } else if(val) {
            alt.value=val;
        }
        url.blur();
        alt.blur();
    }

    self.toDataURL = function(url, callback) {

        if(self.options.toDataUrlMethod == 'FileReader') {
            self.toDataURLFromFileReader(url, callback);
        } else if(self.options.toDataUrlMethod == 'Canvas') {
            self.toDataURLFromCanvas(url, callback);
        }

    }

    self.toDataURLFromFileReader = function(url, callback) {
        var xhr = new XMLHttpRequest();
        xhr.onload = function () {
            var reader = new FileReader();
            reader.onloadend = function () {
                callback(reader.result);
            }
            reader.readAsDataURL(xhr.response);
        };
        xhr.open('GET', url);
        xhr.responseType = 'blob';
        xhr.send();
    }

    self.toDataURLFromCanvas = function(src, callback, outputFormat) {
        var img = new Image();
        img.crossOrigin = 'Anonymous';
        img.onload = function() {
            var canvas = document.createElement('CANVAS');
            var ctx = canvas.getContext('2d');
            var dataURL;
            canvas.height = this.naturalHeight;
            canvas.width = this.naturalWidth;
            ctx.drawImage(this, 0, 0);
            dataURL = canvas.toDataURL(outputFormat);
            callback(dataURL);
        };
        img.src = src;
        if (img.complete || img.complete === undefined) {
            img.src = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==";
            img.src = src;
        }
    }

    self.toDataURLFromLocal = function(element, callback) {
        var file = element.files[0];
        var reader = new FileReader();
        reader.onloadend = function() {
            callback(reader.result);
        }
        reader.readAsDataURL(file);
    }

    self.onSelectChooseFromWeb=function(form){
        var chooseOptions;
        if((chooseOptions = form.querySelector('.Q_HTMLeditor_diaimg_choose-options')) != null) {
            chooseOptions.parentNode.removeChild(chooseOptions);
            return;
        }

        var urlField = form.querySelector('input[name=URL]');
        chooseOptions=document.createElement('DIV');
        chooseOptions.classList.add('Q_HTMLeditor_diaimg_choose-options');
        chooseOptions.style.top = urlField.getBoundingClientRect().top + urlField.getBoundingClientRect().height + 'px';
        chooseOptions.style.left = urlField.parentNode.getBoundingClientRect().right - 100 + 'px';

        var chooseOptionsList=document.createElement('UL');

        for (var key in self.options.imgUrlChooser) {


            if (self.options.imgUrlChooser.hasOwnProperty(key)) {
                var option=document.createElement('li');
                //option.classList.add('button', 'btn-gray');
                option.innerHTML = key;
                option.setAttribute('data-url',  self.options.imgUrlChooser[key].url);
                option.addEventListener('touchend', function (e) {
                    var chooseOptions;
                    if((chooseOptions = form.querySelector('.Q_HTMLeditor_diaimg_choose-options')) != null) {
                        chooseOptions.parentNode.removeChild(chooseOptions);
                    }
                    Q.Cordova.chooseImage(
                        e.target.getAttribute('data-url'),
                        function (dataUrl) {
                            form.querySelector('input[name=URL]').value = dataUrl;
                        },
                        function (error) {
                            alert(error)
                        }
                    );
                });
                chooseOptionsList.appendChild(option);
            }
        }
        chooseOptions.appendChild(chooseOptionsList);
        document.body.appendChild(chooseOptions);
    }

    self.onSelectRecentImages=function(form){


        //var storedImages = localStorage.getItem("recent_images");
        recentImagesDb().getStorage(function (results) {
            /*results.sort(function(a, b) {

                return parseFloat(a.id) - parseFloat(b.id);
            });*/

            var dialogCon=document.createElement('DIV');
            dialogCon.classList.add(self.options.dialogueConClass);

            var el=document.createElement('DIV');
            el.classList.add(self.options.dialogueClass);
            el.classList.add('Q_HTMLeditor_diarecentimg');

            var dialogHeader=document.createElement('div');
            dialogHeader.className = 'dialog-header';
            var dialogTitle=document.createElement('h3');
            dialogTitle.className = 'dialog-title';
            dialogTitle.innerHTML = 'Recent images';
            dialogHeader.appendChild(dialogTitle);

            var close=document.createElement('div');
            close.classList.add('close-dialog-sign');
            dialogHeader.appendChild(close);
            close.addEventListener('click', function (e) {
                document.body.removeChild(e.target.offsetParent.parentNode);
            });
            el.appendChild(dialogHeader);

            var content=document.createElement('DIV');
            content.classList.add('Q_HTMLeditor_diaimg_recent_images', 'dialog-body');
            el.appendChild(content);
            self.reposDialogues();
            dialogCon.appendChild(el);
            document.body.appendChild(dialogCon);

            var loader = document.createElement('div');
            loader.className = 'lds-ellipsis';
            loader.innerHTML = '<div></div><div></div><div></div><div></div>';
            content.appendChild(loader);

            function outputRecentImages(recentImgs) {
                recentImgs.reverse()
                var x = 0;
                var imgObj;
                for(i in recentImgs) {
                    imgObj = recentImgs[i];
                    if(x == 0) {
                        rowDiv = document.createElement('DIV');
                        rowDiv.classList.add('recent-images-row');
                        //content.insertBefore(rowDiv, content.firstChild);
                        content.appendChild(rowDiv);
                    }

                    var imgCon = document.createElement('DIV');
                    imgCon.classList.add('recent-images-item');
                    var img = document.createElement('IMG');
                    img.setAttribute('src', imgObj.src);
                    img.setAttribute('alt', imgObj.alt ? imgObj.alt : '');
                    img.addEventListener('touchend', function (e) {
                        if (_touchInfo.initY != e.changedTouches[0].pageY) return;
                        var url = form.querySelector('input[name="URL"]');
                        url.value = this.src;

                        if(!url.parentElement.classList.contains('no-button')) url.parentElement.classList.add('no-button');
                        url.required = false;
                        var clearImgUrl = form.querySelector('.input-group-addon');
                        clearImgUrl.style.display = 'block';

                        var cordovaBrowseCon = form.querySelector('.input-group-btn');
                        if(cordovaBrowseCon != null) {
                            cordovaBrowseCon.style.display = 'none';
                        }

                        if ((this.src.substring(0, 4)) != 'http') {
                            var dataUrlImg = form.querySelector('.dataurl-img-icon');
                            dataUrlImg.style.display = 'flex';
                            var im = new Image();

                            im.onload = function () {
                                dataUrlImg.innerHTML = '<span>' + im.width + 'x' + im.height + ' image</span>';
                            };

                            im.src = this.src;
                            url.style.display = 'none';
                        }

                        form.querySelector('input[name="ALT"]').value = this.alt;
                        form.querySelector('button[type="submit"]').disabled = false;
                        document.body.removeChild(dialogCon);
                    });

                    imgCon.appendChild(img);

                    rowDiv.appendChild(imgCon);

                    if(x == 0)
                        x++;
                    else
                        x = 0;


                }

                var loader = document.querySelector('.lds-ellipsis');
                content.removeChild(loader);

            }

            if(results.length != 0) {
                var image, i;

                var allImages = [];
                var remainingCallbacks = results.length;
                var x = 0;

                for(i = 0; image = results[i]; i++){
                    var rowDiv;


                    if(image.url != null) {
                        allImages[i] = {src:image.url, alt:image.alt};

                        --remainingCallbacks;
                        if (remainingCallbacks <= 0) {
                            outputRecentImages(allImages)
                        }
                    } else {
                        var reader = new FileReader();
                        reader.onload = (function (image, i, x) {
                            return function (e) {

                                allImages[i] = {src: e.target.result, alt: image.alt};

                                --remainingCallbacks;

                                if (remainingCallbacks <= 0) {
                                    outputRecentImages(allImages)
                                }
                            }
                        })(image, i, x);

                        reader.readAsDataURL(new Blob([new Uint8Array(image.blob)], { type: image.type }));
                    }

                }
            } else {
                content.appendChild(document.createTextNode('No images yet'));
            };

        })
    }

    var recentImagesDb = function () {
        // IndexedDB
        var indexedDB = window.indexedDB || window.webkitIndexedDB || window.mozIndexedDB || window.OIndexedDB || window.msIndexedDB;
        var dbVersion = 1.0;
        var baseName = "recentImagesFiles";
        var storeName = "recentImages";

        function _logerr(err){
            console.log('%c recentImagesDb: error', 'background:red;color:white', err);
        }

        function _openDb(f) {
            if(_debug) console.log('%c recentImagesDb: _openDb', 'background:red;color:white');
            var request = indexedDB.open(baseName, dbVersion);
            request.onerror = _logerr;
            request.onsuccess = function () {
                f(request.result);
            }
            request.onupgradeneeded = function (e) {
                e.currentTarget.result.createObjectStore(storeName, { keyPath: "fileId", autoIncrement:true });
                //_openDb(f);
            }
        }

        function isOpened() {
            return isDbCreated;
        }

        function getFile(file, f){
            _openDb(function(db){
                var request = db.transaction([storeName], "readonly").objectStore(storeName).get(file);
                request.onerror = _logerr;
                request.onsuccess = function(){
                    f(request.result ? request.result : -1);
                }
            });
        }

        function getStorage(f, limit){
            _openDb(function(db){
                var rows = [];
                var i = 0;
                var store = db.transaction([storeName], "readonly").objectStore(storeName);

                if(store.mozGetAll && !limit)
                    store.mozGetAll().onsuccess = function(e){
                        f(e.target.result);
                    };
                else
                    store.openCursor().onsuccess = function(e) {
                        var cursor = e.target.result;
                        if((cursor && !limit) || (cursor && limit && i < limit)){
                            rows.push(cursor.value);
                            cursor.continue();
                        }
                        else {
                            f(rows);
                        }
                        i++;
                    };
            });
        }

        function countImages(f){
            _openDb(function(db){
                var request = db.transaction([storeName], "readonly").objectStore(storeName).count();
                request.onerror = _logerr;
                request.onsuccess = function(){
                    f(request.result ? request.result : -1);
                }
            });
        }

        function saveFile(file){
            if(file.blob != null && file.blob instanceof Blob) {
                var fileReader = new FileReader();
                fileReader.onload = function(event) {
                    var arrayBuffer = event.target.result;
                    recentImagesDb().saveFile({alt:file.alt, blob:arrayBuffer, type:file.blob.type});
                };
                fileReader.readAsArrayBuffer(file.blob);
                return;
            }

            _openDb(function(db){
                var request = db.transaction([storeName], "readwrite").objectStore(storeName).put(file);
                request.onerror = _logerr;
                request.onsuccess = function(){
                    return request.result;
                }
            });
        }

        function saveFileFromUrl(alt, url) {
            // Create XHR
            var xhr = new XMLHttpRequest(),
                blob;

            xhr.open("GET", url, true);
            // Set the responseType to blob
            xhr.responseType = "blob";

            xhr.addEventListener("load", function () {
                if (xhr.status === 200) {

                    // Blob as response
                    blob = xhr.response;

                    // Put the received blob into IndexedDB
                    var fileReader = new FileReader();
                    fileReader.onload = function(event) {
                        var arrayBuffer = event.target.result;
                        recentImagesDb().saveFile({alt:alt, blob:arrayBuffer});
                    };
                    fileReader.readAsArrayBuffer(blob)

                }
            }, false);
            // Send XHR
            xhr.send();
        }

        function delFile(file){
            _openDb(function(db){
                var request = db.transaction([storeName], "readwrite").objectStore(storeName).delete(file);
                request.onerror = _logerr;
                request.onsuccess = function(){
                    if(_debug) console.log("File delete from DB:", file);
                }
            });
        }

        return {
            saveFile: saveFile,
            getStorage: getStorage,
            delFile: delFile,
            saveFileFromUrl: saveFileFromUrl,
            count: countImages,
        }

    }

    self.b64toBlob = function(b64Data, contentType, sliceSize) {
        contentType = contentType || '';
        sliceSize = sliceSize || 512;

        var byteCharacters = atob(b64Data);
        var byteArrays = [];

        for (var offset = 0; offset < byteCharacters.length; offset += sliceSize) {
            var slice = byteCharacters.slice(offset, offset + sliceSize);

            var byteNumbers = new Array(slice.length);
            for (var i = 0; i < slice.length; i++) {
                byteNumbers[i] = slice.charCodeAt(i);
            }

            var byteArray = new Uint8Array(byteNumbers);

            byteArrays.push(byteArray);
        }

        var blob = new Blob(byteArrays, {type: contentType});
        return blob;
    }

    self.convertBase64ImagesToObjectUrl = function(){
        var urlCreator = window.URL || window.webkitURL;
        var imgs = self.area.getElementsByTagName('IMG');

        var img, i;
        for(i = 0; img = imgs[i]; i++) {
            var url = img.src;
            var isDataUrl = url.substr(0, 15);
            if (isDataUrl.indexOf('data:image') != 0)  return;

            var contentType
            if (isDataUrl.indexOf('jpeg') != -1)
                contentType = 'image/jpeg';
            else if (isDataUrl.indexOf('png') != -1)
                contentType = 'image/png';
            else if (isDataUrl.indexOf('gif') != -1)
                contentType = 'image/gif';
            else if (isDataUrl.indexOf('svg') != -1)
                contentType = 'image/svg+xml';

            var blob = self.b64toBlob(url.replace(/^data:image\/(png|jpeg|jpg|gif);base64,/, ''), contentType);
            var imageUrl = urlCreator.createObjectURL(blob);
            img.dataset.objectUrl = imageUrl;
        }
    }

    self.onImageSubmit=function(e) {
        var form=e.currentTarget;
        var url,alt;

        var imgFiles = form.querySelectorAll('[name=imgFile]');

        var list=form.querySelectorAll('[name=URL]');

        if(list.length) {
            url=list[0].value;
        }

        if(url.trim().length == 0 && imgFiles == null) {
            e.preventDefault();
            return false;
        }

        list=form.querySelectorAll('[name=ALT]');
        if(list.length) {
            alt=list[0].value;
        }

        setTimeout(function() {
            self.selector.disable(false);

            var urlCreator = window.URL || window.webkitURL;
            var img;
            if (imgFiles != null && imgFiles[0].files.length != 0) {

                self.toDataURLFromLocal(imgFiles[0], function (dataUrl) {
                    img = self.selector.insertImage(dataUrl, alt);
                    alignImage(img);

                    var imageUrl = urlCreator.createObjectURL(imgFiles[0].files[0]);
                    img.dataset.objectUrl = imageUrl;



                    self.selector.deselect();
                })

                recentImagesDb().saveFile({alt:alt, blob:imgFiles[0].files[0]});
            } else {

                img = self.selector.insertImage(url, alt);
                var isDataUrl = url.substr(0, 15)
                if(isDataUrl.indexOf('data:image') == 0){
                    var contentType
                    if(isDataUrl.indexOf('jpeg') != -1)
                        contentType = 'image/jpeg';
                    else  if(isDataUrl.indexOf('png') != -1)
                        contentType = 'image/png';
                    else  if(isDataUrl.indexOf('gif') != -1)
                        contentType = 'image/gif';
                    else  if(isDataUrl.indexOf('svg') != -1)
                        contentType = 'image/svg+xml';

                    var blob = self.b64toBlob(url.replace(/^data:image\/(png|jpeg|jpg|gif);base64,/, ''), contentType);
                    var imageUrl = urlCreator.createObjectURL(blob);
                    img.dataset.objectUrl = imageUrl;
                }
                alignImage(img);
                if(url != ''){
                    recentImagesDb().saveFile({alt:alt, url:url});
                }
                self.selector.deselect();
            }

            function alignImage(img){
                var imgAlign = form.querySelector('input[name=imgAlign]:checked');
                self.selector.alignImage(img, imgAlign != null ? imgAlign.value : 'none');
                var topImgMargin, rightImgMargin, bottomImgMargin, leftImgMargin;
                img.style.marginTop = (topImgMargin = form.querySelector('input[name=topImgMargin]')) ? (topImgMargin.value).replace('px', '') + 'px' : '';

                img.style.marginBottom = (bottomImgMargin = form.querySelector('input[name=bottomImgMargin]')) ? (bottomImgMargin.value).replace('px', '') + 'px' : '';


                var marginLeftInput, marginRightInput;
                leftImgMargin = (marginLeftInput = form.querySelector('input[name=leftImgMargin]')) ? marginLeftInput.value.replace('px', '') : null;
                rightImgMargin = (marginRightInput = form.querySelector('input[name=rightImgMargin]')) ? marginRightInput.value.replace('px', '') : null;
                if(marginLeftInput.dataset.customValue == null && isNaN(parseInt(leftImgMargin, 10)) && imgAlign && imgAlign.value == 'right'){
                    img.style.marginLeft = '10px';
                } else  img.style.marginLeft = leftImgMargin ? leftImgMargin + 'px' : '';
                if(marginLeftInput.dataset.customValue != null) {
                    img.dataset.marginLeft = img.style.marginLeft != '' ? img.style.marginLeft : '0';
                }


                if(marginRightInput.dataset.customValue == null && isNaN(parseInt(rightImgMargin, 10)) && imgAlign && imgAlign.value == 'left'){
                    img.style.marginRight = '10px';
                } else  img.style.marginRight = rightImgMargin ? rightImgMargin + 'px' : '';
                if(marginRightInput.dataset.customValue != null) img.dataset.marginRight = img.style.marginRight;

                if(!img.style.width) {
                    img.style.width = '80%';
                }
            }


            self.updateButtonsOnSelection();

            recentImagesDb().count(function (results) {
                if (results > self.options.recentImagesStorage) {
                    recentImagesDb().getStorage(function (records) {
                        var record, i;
                        for(i = 0; record = records[i]; i++) {
                            recentImagesDb().delFile(record.fileId);
                        }

                    }, results - self.options.recentImagesStorage);
                }
            });

        },0);
        e.preventDefault();
        self.onImageCancel();

    }
    self.onImgRemove=function(e) {
        e.preventDefault();
        self.selector.removeImgs();
        self.imageResizing.update();
        self.onImageCancel();
    }
    self.onImageCancel=function(e) {
        if(e) e.preventDefault();
        //self.area.focus();
        self.selector.disable(false);
        self.closeAllDialogues();
    }

    self.showHrefDialogue=function(link) {
        if(_debug) console.log('showHrefDialogue', link)
        self.closeAllDialogues();
        self.dialogIsOpened();
        self.selector.disable(true);
        self.area.blur();
        var val=self.selector.getText();
        // var selectedAnchor= link != null ? link : self.selector.contains('A');
        var selectedAnchor= link;
        if(selectedAnchor) {
            //var linkNode = link != null ? link : selectedAnchor.childNodes[0]
            self.selector.selectNodeContents(selectedAnchor);
        }

        var bg=document.createElement('DIV');
        bg.classList.add(self.options.dialogueBgClass);
        var dialogCon=document.createElement('DIV');
        dialogCon.classList.add(self.options.dialogueConClass);
        bg.addEventListener('touchend', function (e){
            e.stopPropagation();
            if(e.currentTarget == e.target)self.closeAllDialogues();
        });

        var el=document.createElement('DIV');
        el.classList.add(self.options.dialogueClass);
        el.classList.add(self.options.hrefDialogueClass);

        var close=document.createElement('div');
        close.classList.add('close-dialog-sign')
        el.appendChild(close);
        close.addEventListener('click',function (){self.onHrefCancel();self.selector.deselect();});

        var form=document.createElement('FORM');
        el.appendChild(form);

        var p=document.createElement('H2');
        p.innerHTML=selectedAnchor?'Update Link':'Add Link';
        form.appendChild(p);

        if(self.options.useFormLabels) {
            var p=document.createElement('H3');
            p.innerHTML='Display text:';
            form.appendChild(p);
        }

        var inputCon=document.createElement('DIV');
        inputCon.classList.add('input-group');

        var input=document.createElement('INPUT'),text=input;
        input.type='text';
        input.name='text';
        input.placeholder='Link Text';
        inputCon.appendChild(input);
        form.appendChild(inputCon);

        if(self.options.useFormLabels) {
            var p=document.createElement('H4');
            p.innerHTML='URL:';
            form.appendChild(p);
        }

        var inputCon=document.createElement('DIV');
        inputCon.classList.add('input-group', 'link-url', 'no-button');

        var url;
        input=document.createElement('INPUT'),url=input;
        input.type='text';
        input.name='URL';
        input.placeholder= typeof Q != "undefined" && Q.Cordova != null && _isiOS ? 'Paste a link or tap >' : 'Paste a link';
        if(selectedAnchor) input.required='required';

        var validateLink = function(e){
            if(e.target.value != "")
                form.querySelector('button[type="submit"]').disabled = false;
            else
                form.querySelector('button[type="submit"]').disabled = 'disabled';
        }
        input.addEventListener('change', function (e) {
            validateLink(e)
            if(inputCon.classList.contains('no-button')) url.parentNode.classList.remove('no-button');
        });
        input.addEventListener('keyup', validateLink);
        input.addEventListener('focus',function(e) { if(!url.value || url.value.length==0) url.value='http://';});
        input.addEventListener('blur',function(e) { if(url.value=='http://') url.value='';});
        inputCon.appendChild(input);
        form.appendChild(inputCon);


        var cordovaBrowseCon = document.createElement('SPAN');
        cordovaBrowseCon.classList.add('input-group-btn')
        cordovaBrowseCon.style.display = selectedAnchor ? 'none' : '';

        if(typeof Q != 'undefined' && Q.Cordova != null && _isiOS) {
            for (var key in self.options.linksChooser) {

                if (self.options.linksChooser.hasOwnProperty(key)) {
                    var cordovaBrowse = document.createElement('BUTTON');
                    cordovaBrowse.type = 'button';
                    //cordovaBrowse.classList.add('button', 'btn-blue');
                    cordovaBrowse.innerHTML = _icons.chooseFromWeb;
                    cordovaBrowse.setAttribute('data-url',  self.options.linksChooser[key]);
                    cordovaBrowse.addEventListener('touchend', function (e) {
                        Q.Cordova.chooseLink(
                            e.currentTarget.getAttribute('data-url'),
                            function (dataUrl) {
                                document.getElementsByClassName(self.options.imgDialogueClass)[0].querySelector('input[name=URL]').value = dataUrl;
                            },
                            function (error) {
                                alert(error)
                            });
                    });


                    cordovaBrowseCon.appendChild(cordovaBrowse);

                }
            }
        }
        inputCon.appendChild(cordovaBrowseCon);

        var clearImgUrl = document.createElement('SPAN');
        clearImgUrl.classList.add('input-group-addon');
        var circle = document.createElement('SPAN');
        circle.className = 'clear-input-value';
        circle.innerHTML = _icons.closeCircle;
        clearImgUrl.appendChild(circle);

        clearImgUrl.addEventListener('touchend', function () {
            this.style.display = 'none';
            url.value = '';
            url.required = 'required';
            url.parentElement.classList.add('no-button');
            if(cordovaBrowseCon != null) {
                if(cordovaBrowseCon.style.display == 'none') {
                    cordovaBrowseCon.style.display = '';
                } else cordovaBrowseCon.style.display = '';
            }

        });
        inputCon.appendChild(clearImgUrl);
        if(!selectedAnchor) clearImgUrl.style.display = 'none';



        var storedRecentLinks = localStorage.getItem("recent_links");
        if(storedRecentLinks != null) {
            var recentLinksCon=document.createElement('DIV');
            recentLinksCon.classList.add('form-group');
            var link = document.createElement('A');
            link.classList.add('select-recent-links');
            link.innerHTML = "Choose from recent links";
            link.addEventListener('touchend', self.onSelectRecentLinks);
            recentLinksCon.appendChild(link);
            form.appendChild(recentLinksCon);
        }

        var submitBtn=document.createElement('BUTTON');
        submitBtn.type='submit';
        if(!selectedAnchor) submitBtn.disabled='disabled';
        submitBtn.classList.add('button', 'btn-blue');
        submitBtn.innerHTML=selectedAnchor?'Update':'Add';
        form.appendChild(submitBtn);

        form.addEventListener('submit', self.onHrefSubmit);

        self.changeDialoguesAlingOnTap(url);
        self.changeDialoguesAlingOnTap(text);
        /*form.addEventListener('touchend',function (e) {
            setTimeout(function () {
                if(e.target.nodeName == 'INPUT') {
                    var conSize = document.querySelector('.' + self.options.areaContainerClass).getBoundingClientRect();
                    e.target.offsetParent.parentNode.style.height = conSize.height + 'px';
                    e.target.addEventListener('blur', function () {
                        var conSize = document.querySelector('.' + self.options.areaContainerClass).getBoundingClientRect();
                        e.target.offsetParent.parentNode.style.height = conSize.height + 'px';
                    }, {once:true});
                }
            }, 50)
        });*/

        if(selectedAnchor) {
            var removeBtn=document.createElement('BUTTON');
            removeBtn.type='button';
            removeBtn.innerHTML = 'Remove';
            removeBtn.classList.add('button', 'btn-red', 'remove');
            removeBtn.addEventListener('click',self.onHrefRemove);
            form.appendChild(removeBtn);
        }

        dialogCon.appendChild(el)
        document.body.appendChild(bg);
        document.body.appendChild(dialogCon);

        if(selectedAnchor) {
            url.value=selectedAnchor.href;
            text.value=selectedAnchor.innerText;
        } else if(val) {
            if(val.indexOf('://')!=-1 || val.indexOf('www')!=-1) {
                if(val.indexOf('://')==-1) val='http://'+val;
                url.value=val;
            } else {
                text.value=val;
            }
        }


        url.blur();
        text.blur();
        setTimeout(function(){self.reposDialogues();}, 500);
    }
    self.onSelectRecentLinks=function(e){
        var linksDialog = e;

        var dialogCon=document.createElement('DIV');
        dialogCon.classList.add(self.options.dialogueConClass);

        var el=document.createElement('DIV');
        el.classList.add(self.options.dialogueClass);
        el.classList.add(self.options.hrefDialogueClass);
        el.classList.add(self.options.recentLinksDialogue);

        var dialogHeader=document.createElement('div');
        dialogHeader.className = 'dialog-header';
        var dialogTitle=document.createElement('h3');
        dialogTitle.className = 'dialog-title'
        dialogTitle.innerHTML = 'Recent links'
        dialogHeader.appendChild(dialogTitle);

        var close=document.createElement('div');
        close.classList.add('close-dialog-sign')
        dialogHeader.appendChild(close);
        close.addEventListener('click',function (e) {
            document.body.removeChild(e.target.offsetParent.parentNode);
        });
        el.appendChild(dialogHeader);

        var content=document.createElement('DIV');
        content.className = 'dialog-body';
        var linksList=document.createElement('UL');
        content.appendChild(linksList);
        var storedRecentLinks = localStorage.getItem("recent_links");
        if(storedRecentLinks != null) {
            storedRecentLinks = JSON.parse(storedRecentLinks);

            var x;
            for(x in storedRecentLinks) {
                var linkCon=document.createElement('li');
                var link=document.createElement('A');
                link.setAttribute('href', storedRecentLinks[x].url);
                link.innerHTML = storedRecentLinks[x].text;
                link.addEventListener('touchend',function (e) {
                    if(_touchInfo.initY != e.changedTouches[0].pageY) return;
                    document.getElementsByClassName(self.options.hrefDialogueClass)[0].querySelector('input[name="URL"]').value = this.href;
                    document.getElementsByClassName(self.options.hrefDialogueClass)[0].querySelector('input[name="text"]').value = this.text;
                    document.getElementsByClassName(self.options.hrefDialogueClass)[0].querySelector('button[type="submit"]').disabled = false;
                    document.body.removeChild(e.target.offsetParent.parentNode);
                    e.preventDefault();
                    return;
                });
                link.addEventListener('click',function (e) {e.preventDefault()});
                linkCon.appendChild(link)
                linksList.appendChild(linkCon);
            }

        } else {
            content.appendChild(document.createTextNode('No links yet'));
        }

        el.appendChild(content);

        self.reposDialogues();

        dialogCon.appendChild(el);
        document.body.appendChild(dialogCon);
    }
    self.onHrefSubmit=function(e) {
        //self.selector.stateSave(self.area)
        var form=e.currentTarget;
        var list=form.querySelectorAll('[name=URL]');
        var url,text;
        if(list.length) {
            url=list[0].value;

            var pattern = /http(?:s)?\:\/\/(http(?:s)?\:\/\/)(.*)/i;
            var validUrl;
            if((validUrl = url.replace(pattern, '$1$2')) != url) {
                url = validUrl;
            }
        }
        list=form.querySelectorAll('[name=text]');
        if(list.length) {
            text=list[0].value;
        } else {
            e.preventDefault();
            return false;
        }
        setTimeout(function() {
            self.selector.disable(false);
            self.selector.insertLink(url,text);
            self.updateButtonsOnSelection();

            if(url != ''){
                var recentLinks = localStorage.getItem("recent_links");
                if(recentLinks != null) {
                    recentLinks = JSON.parse(recentLinks);
                } else {
                    recentLinks = [];
                }

                var item = {
                    url: url,
                    text: text
                }
                recentLinks.unshift(item);

                if(recentLinks.length > self.options.recentLinksStorage) recentLinks = recentLinks.slice(0, self.options.recentLinksStorage-1);
                localStorage.setItem("recent_links", JSON.stringify(recentLinks));
            }

            self.updateButtonsOnSelection();
            self.selector.deselect();
        },0);
        e.preventDefault();
        self.onHrefCancel();
    }
    self.onHrefRemove=function(e) {
        if(e) e.preventDefault();
        self.selector.removeLinks();
        e.preventDefault();
        self.onHrefCancel();
    }
    self.onHrefCancel=function(e) {
        if(e) e.preventDefault();
        //self.area.focus();
        self.selector.disable(false);
        //self.selector.deselect();
        self.closeAllDialogues();
    }

    self.helpDialog = function() {
        function show() {
            self.closeAllDialogues();
            self.selector.disable(true);
            self.area.blur();

            var bg=document.createElement('DIV');
            bg.classList.add(self.options.dialogueBgClass);
            var dialogCon=document.createElement('DIV');
            dialogCon.classList.add(self.options.dialogueConClass);
            bg.addEventListener('click', self.closeAllDialogues);

            var el=document.createElement('DIV');
            el.classList.add(self.options.dialogueClass);
            el.classList.add('Q_HTMLeditor_diainstructions');
            el.style.background = "#e9e9e9";

            var dialogHeader=document.createElement('div');
            dialogHeader.className = 'dialog-header';
            var dialogTitle=document.createElement('h3');
            dialogTitle.className = 'dialog-title'
            var dialogTitleLink=document.createElement('A');
            dialogTitleLink.href = 'http://edithtml.app';
            dialogTitleLink.innerHTML = 'Touchscreen HTML Editor for any site!';
            dialogTitleLink.target = '_blank';
            dialogTitle.appendChild(dialogTitleLink);
            dialogHeader.appendChild(dialogTitle);

            var close=document.createElement('div');
            close.classList.add('close-dialog-sign');
            dialogHeader.appendChild(close);
            close.addEventListener('click', function(){
                self.closeAllDialogues();
                self.hint.removeHints();
            });
            el.appendChild(dialogHeader);

            var help = document.createElement('div');
            help.classList.add('dialog-body');

            var helpText = '<div class="numberlist"><ol>\n' +
                '<li><span>To move cursors, tap and hold. Or release and wait to paste HTML</span></li>\n' +
                '<li><span>Move your finger horizontally to select text and reveal more commandss</span></li>\n' +
                '<li><span>Double-tap and triple-tap to select words and paragraphs when keyboard is active</span></li>\n' +
                '<li><span>Drag the endpoints of a selection to resize it.</span></li>\n' +
                '<li><span>Tap and hold to drag selected text and images. Tap images and links to edit them.</span></li>\n' +
                '</ol>\n' +
                '</div>';
            help.innerHTML = helpText;

            el.appendChild(help);

            self.reposDialogues();
            dialogCon.appendChild(el)
            document.body.appendChild(bg);
            document.body.appendChild(dialogCon);

            setTimeout(function(){self.hint.applyHint(dialogTitleLink);}, 500);
        }

        return {
            show:show,
        }
    }

    self.editorPromoDialog = function() {
        function show() {
            self.closeAllDialogues();
            self.selector.disable(true);
            self.area.blur();

            var bg=document.createElement('DIV');
            bg.classList.add(self.options.dialogueBgClass);
            var dialogCon=document.createElement('DIV');
            dialogCon.classList.add(self.options.dialogueConClass);
            bg.addEventListener('click', function(){
                self.closeAllDialogues();
                self.hint.removeHints();
            });

            var el=document.createElement('DIV');
            el.classList.add(self.options.dialogueClass);
            el.classList.add('Q_HTMLeditor_diainstructions');
            el.style.background = "#e9e9e9";

            var dialogHeader=document.createElement('div');
            dialogHeader.className = 'dialog-header';
            var dialogTitle=document.createElement('h3');
            dialogTitle.className = 'dialog-title'
            var dialogTitleLink=document.createElement('A');
            dialogTitleLink.href = 'http://edithtml.app';
            dialogTitleLink.innerHTML = 'Touchscreen HTML Editor for any site!';
            dialogTitleLink.target = '_blank';
            dialogTitle.appendChild(dialogTitleLink);
            dialogHeader.appendChild(dialogTitle);

            var close=document.createElement('div');
            close.classList.add('close-dialog-sign');
            dialogHeader.appendChild(close);
            close.addEventListener('click', function(){
                self.closeAllDialogues();
                self.hint.removeHints();
            });
            el.appendChild(dialogHeader);

            var help = document.createElement('div');
            help.classList.add('dialog-body');

            var helpText = '<div class="numberlist"><ol>\n' +
                '<li><span>To move cursors, tap and hold. Or release and wait to paste HTML</span></li>\n' +
                '<li><span>Move your finger horizontally to select text and reveal more commandss</span></li>\n' +
                '<li><span>Double-tap and triple-tap to select words and paragraphs when keyboard is active</span></li>\n' +
                '<li><span>Drag the endpoints of a selection to resize it.</span></li>\n' +
                '<li><span>Tap and hold to drag selected text and images. Tap images and links to edit them.</span></li>\n' +
                '</ol>\n' +
                '</div>';
            help.innerHTML = helpText;

            el.appendChild(help);

            self.reposDialogues();
            dialogCon.appendChild(el)
            document.body.appendChild(bg);
            document.body.appendChild(dialogCon);

            setTimeout(function(){self.hint.applyHint(dialogTitleLink);}, 500);
        }

        return {
            show:show,
        }
    }

    self.hint = {
        hints:[],
        applyHint: function (target) {
            var tapImg;
            tapImg = document.createElement('img');
            tapImg.setAttribute('src', 'img/tap.gif');
            tapImg.style.position = 'absolute';
            tapImg.style.width = '40px';
            tapImg.style.height = '40px';
            tapImg.style.display = 'block';
            tapImg.style.pointerEvents = 'none';
            tapImg.setAttribute('class', 'Q_hint');
            tapImg.style.opacity = 0;
            tapImg.style.zIndex = 999999999;
            tapImg.style.transform = 'scale(1.3)';
            tapImg.style.setProperty('-webkit-transition', 'transform 0.5s ease-in-out, opacity 0.5s ease-in-out')
            tapImg.style.setProperty('-moz-transition', 'transform 0.5s ease-in-out, opacity 0.5s ease-in-out')
            tapImg.style.setProperty('-ms-transition', 'transform 0.5s ease-in-out, opacity 0.5s ease-in-out')
            tapImg.style.setProperty('-o-transition', 'transform 0.5s ease-in-out, opacity 0.5s ease-in-out')
            tapImg.style.setProperty('transition', 'transform 0.5s ease-in-out, opacity 0.5s ease-in-out')

            document.body.appendChild(tapImg);
            this.hints.push(tapImg);

            tapImg.onload = function(){
                var targetRect = target.getBoundingClientRect();
                tapImg.style.top = targetRect.top + 'px';
                tapImg.style.left = targetRect.left + targetRect.width/2 + 'px';
                tapImg.style.opacity = '1';
                tapImg.style.transform = 'scale(1)';
            }

            window.addEventListener('scroll',self.hint.removeHints);

        },
        removeHints: function () {
            for(var i in self.hint.hints) {
                var hintImg = self.hint.hints[i];
                hintImg.parentNode.removeChild(hintImg);
            }
            self.hint.hints = [];
            window.removeEventListener('scroll',self.hint.removeHints);
        }
    }


    self.showSizeDialogue=function() {
        self.closeAllDialogues();
        self.dialogIsOpened();
        self.selector.disable(true);
        self.area.blur();
        var selectedFont=self.selector.contains('FONT');

        var bg=document.createElement('DIV');
        bg.classList.add(self.options.dialogueBgClass);

        var dialogCon=document.createElement('DIV');
        dialogCon.classList.add(self.options.dialogueConClass);
        bg.addEventListener('click', self.closeAllDialogues);

        var el=document.createElement('DIV');
        el.classList.add(self.options.dialogueClass);
        el.classList.add(self.options.sizeDialogueClass);

        var close=document.createElement('div');
        close.classList.add('close-dialog-sign')
        el.appendChild(close);
        close.addEventListener('click',self.onSizeCancel);

        var form=document.createElement('FORM');
        el.appendChild(form);

        var p=document.createElement('H2');
        p.innerHTML='Custom font size';
        form.appendChild(p);

        if(self.options.useFormLabels) {
            var p=document.createElement('H3');
            p.innerHTML='Enter size:';
            form.appendChild(p);
        }

        var inputCon=document.createElement('DIV');
        inputCon.classList.add('form-group');
        var input=document.createElement('INPUT'),size=input;
        input.type='text';
        input.name='size';
        input.placeholder='Size (in px)';
        form.appendChild(input);

        self.changeDialoguesAlingOnTap(size);

        var submitBtn=document.createElement('BUTTON');
        submitBtn.type='submit';
        submitBtn.classList.add('button', 'btn-blue');
        submitBtn.innerHTML='Set size';
        inputCon.appendChild(submitBtn);
        form.appendChild(inputCon);

        form.addEventListener('submit',self.onSizeSubmit);

        dialogCon.appendChild(el);
        document.body.appendChild(bg);
        document.body.appendChild(dialogCon);

        self.reposDialogues();

        if(selectedFont) {
            if(selectedFont.style.fontSize && selectedFont.style.fontSize!='') {
                size.value=selectedFont.style.fontSize;
            }
        }
        size.focus();
    }
    self.onSizeSubmit=function(e) {
        var form=e.currentTarget;
        var list=form.querySelectorAll('[name=size]');
        var size;
        if(list.length) {
            size=list[0].value;

        }
        setTimeout(function() {
            self.selector.disable(false);
            self.selector.applySize(size,true);
            //self.selector.insertLink(url,text);
            self.updateButtonsOnSelection();
        },0);
        e.preventDefault();
        self.onSizeCancel();
    }
    self.onSizeCancel=function(e) {
        self.area.focus();
        self.selector.disable(false);
        self.closeAllDialogues();
    }

    self.closeAllDialogues=function() {
        var elems=[].slice.call(document.getElementsByClassName(self.options.dialogueConClass)).concat([].slice.call(document.getElementsByClassName(self.options.dialogueBgClass)));
        for(var i=0;i<elems.length;i++) {
            if(elems[i].parentNode) elems[i].parentNode.removeChild(elems[i]);
        }
        self.selector.disable(false);
        self.handlerOnScroll();
        self.dialogIsClosed();
    }

    self.dialogIsOpened = function() {
        if(_isiOS && !document.body.classList.contains('modal-opened')) document.body.classList.add('modal-opened');
    }

    self.dialogIsClosed = function() {
        if(_isiOS && document.body.classList.contains('modal-opened')) document.body.classList.remove('modal-opened');
    }

    //changes align of all dialogues on input blur/focus within current dialogue
    self.changeDialoguesAlingOnTap = function(input){
        input.addEventListener('focus', function () {
            self.reposDialogues();
            var dialogs = document.querySelectorAll('.' + self.options.dialogueConClass);
            if(dialogs == null || dialogs.length == 0) return;

            setTimeout(function () {
                Array.from(dialogs).forEach(function (dialog) {
                    dialog.style.justifyContent = 'flex-start';
                });
            },50)

        });
        input.addEventListener('blur', function () {
            self.reposDialogues();
            var dialogs = document.querySelectorAll('.' + self.options.dialogueConClass);
            if(dialogs == null || dialogs.length == 0) return;

            setTimeout(function () {
                Array.from(dialogs).forEach(function (dialog) {
                    dialog.style.justifyContent = 'center';
                });
            },50)

        });
    }

    self.reposDialogues=function(scroll) {
        setTimeout(function () {
            var w,wh,ww,wt,wl;
            w=window,wh=w.innerHeight,ww=w.innerWidth,wt=window.pageYOffset || document.documentElement.scrollTop,wl=w.pageXOffset || document.documentElement.scrollLeft;

            var elems=document.getElementsByClassName(self.options.dialogueConClass);

            var bodyRect = document.body.getBoundingClientRect();
            for(var i=0;i<elems.length;i++) {
                var elem=elems[i];
                var isKbActive = elem.querySelector('input:focus')

                //allow scroll: on phones with small screens kb overlay bottom input and there is no scroll when input focus
                if(isKbActive != null || document.activeElement.nodeName == 'input') {
                    elem.style.justifyContent = 'flex-start';
                    return;
                }

                elem.style.position = '';
                elem.style.justifyContent = '';
                elem.style.top = '';

            }

        }, 50);

    }

    /* Handlers */

    self.handlerOnLoad=function() {
        self.prepareArea(el);
        self.createToolbar();


        /*if(_isMobile) {
         self.selector.onFocus(self.onInputFocus);
         self.selector.onBlur(self.onInputBlur);
        }*/

        //Android fix: used to detect appearing and disappearing of keyboard
        _windowHeight.initial = window.innerHeight;
        self.selector.setInitialWindowheight(_windowHeight.initial);

        // Set initial position
        self.handlerOnResize();
    }
    self.handlerOnResize=function() {
        if (_debug) console.log('handlerOnResize');

        _width=window.innerWidth;
        _height=window.innerHeight;

        self.handlerOnScroll();
    }
    self.isKeyboardActive = function() {
        return _keyboardVisible;
    }
    self.handlerOnHash=function(e) {
        //self.selector.deselect();
    }

    window.visualViewport.addEventListener("resize", function () {
        self.handlerOnScroll();
    });
    window.visualViewport.addEventListener("scroll",function () {
        self.handlerOnScroll();
    });

    self.handlerOnScroll=function(triggeredByTimeout) {
        if(_debug) console.log('handlerOnScroll', _container);
        if(_isScrolling == null) _isScrolling = setTimeout(function () {
            clearTimeout(_isScrolling);
            _isScrolling = null;
        }, 300)

        if(!triggeredByTimeout && _scrollInertiaHandlerTimeout) {
            clearTimeout(_scrollInertiaHandlerTimeout);
            _scrollInertiaHandlerTimeout = null;
        }
        
        //console.log('handlerOnScroll fixed');

        if(_isiOS) {
            let containerRect = _container.getBoundingClientRect();
            let visualViewOffsetTop = visualViewport.offsetTop;
            let visualViewPageTop = visualViewport.pageTop;
            let maxViewOffsetTop = Math.abs(visualViewport.height - document.documentElement.clientHeight);
            let documentScrollTop = window.pageYOffset || document.documentElement.scrollTop;
            let maxDocumentScrollTop = Math.abs(visualViewport.height - document.documentElement.scrollHeight);
            let documentScrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
            let areaRect = self.area.getBoundingClientRect();
            let areaTopPosition = areaRect.top;
            let areaLeftPosition = areaRect.left;
            let windowHeight = window.innerHeight;
            //console.log('handlerOnScroll: ios');

            if (self.options.toolbarFixed) {
                if (_debug) console.log('handlerOnScroll: FIXED', documentScrollTop, areaTopPosition, containerRect.top);
    
                _bar.style.display = 'block';
                if (_debug) console.log('handlerOnScroll: 1');
    
                _bar.style.setProperty("position", "fixed", "important");
    
                if (_activeGroup) {
                    _activeGroup.style.display = '';
                    _activeGroup.style.setProperty("position", "fixed", "important")
                }
    
                if (_debug) console.log('handlerOnScroll: toolbarFixed 2.1', visualViewOffsetTop, visualViewPageTop, documentScrollTop, containerRect);
                if (_debug) console.log('handlerOnScroll: toolbarFixed 2.1 visualViewport.height', visualViewport.scale, visualViewport.height, maxViewOffsetTop, maxDocumentScrollTop);
                let docScrollTop = documentScrollTop <= maxDocumentScrollTop ? documentScrollTop : maxDocumentScrollTop;
                let visOffsetTop = visualViewport.offsetTop <= maxViewOffsetTop ? visualViewport.offsetTop : maxViewOffsetTop;
                if (_debug) console.log('handlerOnScroll: toolbarFixed 2.1.0 docScrollTop', docScrollTop, visOffsetTop);

                if (containerRect.top >= 0) {
                    if (_debug) console.log('handlerOnScroll: toolbarFixed 2.1.1', visualViewOffsetTop, containerRect.top);
    
    
                    topPos = (docScrollTop - visualViewport.pageTop + visOffsetTop) + containerRect.top; //21 21 21 |320.5 227.5 304.5 | 21 59
                    //topPos = (docScrollTop - visualViewport.pageTop + visOffsetTop) + stickyToRect.bottom;
    
                } else {
                    if (_debug) console.log('handlerOnScroll: toolbarFixed 2.1.2', visualViewOffsetTop, containerRect.top);
                    //topPos = stickyToRect.height + (maxDocumentScrollTop - maxViewOffsetTop);
                    //it was next before 25.03.2024: topPos = (docScrollTop - visualViewport.pageTop + visOffsetTop);
                    //topPos = (docScrollTop - visualViewport.pageTop + visOffsetTop) - containerRect.top;
                    topPos = (docScrollTop - visualViewport.pageTop + visOffsetTop);
                }
    
    
                if (_debug) console.log('handlerOnScroll: toolbarFixed 2.2 topPos', topPos, visualViewOffsetTop);
                topPos = topPos - _relativeToParentTop;
                _bar.style.top = topPos + 'px';
                if (_activeGroup) _activeGroup.style.top = topPos + _barHeight + 'px';
                _barTopPosition = topPos;

                fixTransformCSS(_barTopPosition);
            }
    
            function handleInertia(startTime, duration) {
                if (performance.now() - startTime < duration) {    
                    _isVisualViewportScrolling = true;
                    self.handlerOnScroll(true);
    
                    _scrollInertiaHandlerTimeout = setTimeout(function () {
                        handleInertia(startTime, duration);
                    }, 10);
    
                } else {
                    self.handlerOnScroll();
                    _visualViewportInfo.prevOffsetTop = null;
                    _visualViewportInfo.prevPageTop = null;
                    _visualViewportInfo.prevHeight = null;
                    _visualViewportInfo.prevDocumentScrollTop = null;
                    _isVisualViewportScrolling = false;
                    clearTimeout(_scrollInertiaHandlerTimeout);
                    _scrollInertiaHandlerTimeout = null
                }
            }
    
            if (!triggeredByTimeout) {
                _visualViewportInfo.prevOffsetTop = visualViewport.offsetTop;
                _visualViewportInfo.prevPageTop = visualViewport.pageTop;
                _visualViewportInfo.prevHeight = visualViewport.height;
                _visualViewportInfo.prevDocumentScrollTop = documentScrollTop;
    
                _scrollInertiaHandlerTimeout = setTimeout(function () {
                    handleInertia(performance.now(), 1000);
                }, 10);
            }
        } else { 
            //android
            let containerRect = _container.getBoundingClientRect();
            var visualViewOffsetTop = visualViewport.offsetTop;
            var documentScrollTop = window.pageYOffset || document.documentElement.scrollTop;
            var documentScrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
            let maxViewOffsetTop = Math.abs(visualViewport.height - document.documentElement.clientHeight);
            let maxDocumentScrollTop = Math.abs(visualViewport.height - document.documentElement.scrollHeight);
            var areaRect = self.area.getBoundingClientRect();
            var areaTopPosition = areaRect.top;
            var areaLeftPosition = areaRect.left;
            var windowHeight = window.innerHeight;

            if (self.options.toolbarFixed) {
                if (_debug) console.log('handlerOnScroll: FIXED', documentScrollTop, areaTopPosition, containerRect.top);

                _bar.style.display = 'block';
                if (_debug) console.log('handlerOnScroll: 1');

                _bar.style.setProperty("position", "fixed", "important");

                if (_activeGroup) {
                    _activeGroup.style.display = '';
                    _activeGroup.style.setProperty("position", "fixed", "important")
                }

                let topPos = 0;
                if (_debug) console.log('handlerOnScroll: toolbarFixed 2.1.0', visualViewOffsetTop, documentScrollTop, containerRect);
                if (_debug) console.log('handlerOnScroll: toolbarFixed 2.1.0.5', maxViewOffsetTop, maxDocumentScrollTop);

                if (visualViewOffsetTop > containerRect.top) {
                    if (_debug) console.log('handlerOnScroll: toolbarFixed 2.1.1', visualViewOffsetTop, Math.abs(containerRect.top));
                    topPos = Math.max(visualViewOffsetTop, documentScrollTop);
                    //topPos = (documentScrollTop - visualViewport.pageTop + visualViewOffsetTop) + containerRect.top; 

                } else {
                    if (_debug) console.log('handlerOnScroll: toolbarFixed 2.1.3');
                    topPos = containerRect.top;
                }

                if (_debug) console.log('handlerOnScroll: toolbarFixed 2.2 topPos', topPos, visualViewOffsetTop);

                if(_elBarIsStickyTo) {
                    let stickyRect = _elBarIsStickyTo.getBoundingClientRect();
                    topPos = stickyRect.bottom + topPos;
                }
                
                _bar.style.top = (topPos - _relativeToParentTop) + 'px';
                if (_activeGroup) _activeGroup.style.top = topPos + _barHeight + 'px';

                _barTopPosition = topPos;
            }

            function handleInertia(startTime, duration) {
                if (performance.now() - startTime < duration) {
                    _isVisualViewportScrolling = true;
                    self.handlerOnScroll(true);
    
                    _scrollInertiaHandlerTimeout = setTimeout(function () {
                        handleInertia(startTime, duration);
                    }, 10);
    
                } else {
                    self.handlerOnScroll();
                    _visualViewportInfo.prevOffsetTop = null;
                    _visualViewportInfo.prevPageTop = null;
                    _visualViewportInfo.prevHeight = null;
                    _visualViewportInfo.prevDocumentScrollTop = null;
                    _isVisualViewportScrolling = false;
                    clearTimeout(_scrollInertiaHandlerTimeout);
                    _scrollInertiaHandlerTimeout = null
                }
            }
    
            if (!triggeredByTimeout) {
                _visualViewportInfo.prevOffsetTop = visualViewport.offsetTop;
                _visualViewportInfo.prevPageTop = visualViewport.pageTop;
                _visualViewportInfo.prevHeight = visualViewport.height;
                _visualViewportInfo.prevDocumentScrollTop = documentScrollTop;
    
                _scrollInertiaHandlerTimeout = setTimeout(function () {
                    handleInertia(performance.now(), 1000);
                }, 10);
            }
        }
    }
    
    function fixTransformCSS(shouldHaveTopPos) {
        return;

        if(!_isiOS) {
            let updatedTopPos;
            let rect = _bar.getBoundingClientRect();
            console.log('fixTransformCSS START', shouldHaveTopPos, rect.top);
    
            if(Math.round(rect.top) != Math.round(shouldHaveTopPos)) {
                let diff = (rect.top - shouldHaveTopPos)
                
                updatedTopPos = shouldHaveTopPos - diff;
                console.log('aaaaaaaaa',updatedTopPos, Math.round(rect.top), Math.round(shouldHaveTopPos))
    
                //_bar.style.top = updatedTopPos + 'px';
                //if (_activeGroup) _activeGroup.style.top = updatedTopPos + _barHeight + 'px';
                if(_elBarIsStickyTo) {
                    let stickyRect = _elBarIsStickyTo.getBoundingClientRect();
                     console.log('fixTransformCSS 1111', updatedTopPos, stickyRect.bottom);
                    let futureTop = rect.top + (updatedTopPos - shouldHaveTopPos)
                    console.log('fixTransformCSS futureTop', futureTop);
    
                    if(futureTop < stickyRect.bottom && Math.sign(futureTop) >= 0) {
                        console.log('fixTransformCSS 1111 aaaa111', updatedTopPos);
    
                        updatedTopPos = updatedTopPos + Math.abs(stickyRect.bottom - futureTop) 
    
                        console.log('fixTransformCSS 1111 aaaa222', updatedTopPos);
                        
                     } else {
    
                        //console.log('fixTransformCSS 1111 bbbbbb1111', updatedTopPos);
                        //updatedTopPos = updatedTopPos + Math.abs(stickyRect.bottom - updatedTopPos);
                        //console.log('fixTransformCSS 1111 bbbbbb2222', updatedTopPos);
                    } 
                    _bar.style.top = updatedTopPos + 'px';
                    if (_activeGroup) _activeGroup.style.top = updatedTopPos + _barHeight + 'px';
                    let res =  _bar.getBoundingClientRect().top
                    console.log('fixTransformCSS result0', res, document.documentElement.scrollTop);
    
                    let newRect = _bar.getBoundingClientRect();
                    let elFromPoint = document.elementFromPoint(newRect.x + (newRect.width / 2), newRect.y);
                    console.log('fixTransformCSS 11111 elFromPoint', elFromPoint);
                    /* if(elFromPoint && elFromPoint != _bar && !_bar.contains(elFromPoint)) {
                        fixTransformCSS(updatedTopPos);
                    } */
    
                    setTimeout(function () {
                        let res2 = _bar.getBoundingClientRect().top;
                        console.log('fixTransformCSS result1', res2, res2 == res, document.documentElement.scrollTop);
    
                    }, 1000);
                    setTimeout(function () {
                        let res2 = _bar.getBoundingClientRect().top;
                        console.log('fixTransformCSS result2', res2, res2 == res, document.documentElement.scrollTop);
    
                    }, 5000);
    
                } else {
                    console.log('fixTransformCSS 2222', updatedTopPos);
    
                    _bar.style.top = updatedTopPos + 'px';
                    if (_activeGroup) _activeGroup.style.top = updatedTopPos + _barHeight + 'px';
                    /* let newRect = _bar.getBoundingClientRect();
                    let elFromPoint = document.elementFromPoint(newRect.x + (newRect.width / 2), newRect.y);
                    console.log('fixTransformCSS 2222 elFromPoint', elFromPoint);
                    if(elFromPoint && elFromPoint != _bar && !_bar.contains(elFromPoint)) {
                        fixTransformCSS(updatedTopPos);
                    } */
                }
            }
        } else {
            let updatedTopPos;
            let rect = _bar.getBoundingClientRect();
            //console.log('fixTransformCSS START');

            if(_elBarIsStickyTo) {
                let stickyRect = _elBarIsStickyTo.getBoundingClientRect();

                if(Math.round(shouldHaveTopPos) == Math.round(visualViewport.offsetTop)) {
                    console.log('fixTransformCSS START1', shouldHaveTopPos, rect.top, visualViewport.offsetTop, visualViewport.pageTop, visualViewport.height);
    
                    updatedTopPos = shouldHaveTopPos - rect.top;
                } else {
                    
                    console.log('fixTransformCSS START2', shouldHaveTopPos, rect.top, visualViewport.offsetTop, visualViewport.pageTop, visualViewport.height);
                    //updatedTopPos = shouldHaveTopPos - (rect.top - shouldHaveTopPos);
                    updatedTopPos = visualViewport.offsetTop - (visualViewport.offsetTop * rect.top * visualViewport.height) + shouldHaveTopPos - stickyRect.height;//129129149359.65+20870=138
                }
    
               
            } else {
                console.log('fixTransformCSS START3', shouldHaveTopPos, rect.top, visualViewport.offsetTop, visualViewport.pageTop, visualViewport.height);

                //updatedTopPos = visualViewport.offsetTop - (visualViewport.offsetTop * rect.top * visualViewport.height) + shouldHaveTopPos - Math.abs(rect.top - shouldHaveTopPos);//129129149359.65+20870=138
                //updatedTopPos = (shouldHaveTopPos - rect.top);//38636+403420
                if((shouldHaveTopPos == visualViewport.offsetTop && visualViewport.offsetTop == visualViewport.pageTop) || Math.sign(rect.top) === -1) {
                    updatedTopPos = (shouldHaveTopPos - rect.top + visualViewport.offsetTop - visualViewport.pageTop);//38636+403420

                } else if((shouldHaveTopPos > visualViewport.offsetTop && visualViewport.offsetTop == visualViewport.pageTop) || Math.sign(rect.top) === -1) {
                    updatedTopPos = shouldHaveTopPos - rect.top - visualViewport.offsetTop - visualViewport.pageTop + visualViewport.height;//208126152.328125152.328125+359.65625

                } else {
                    //updatedTopPos = (shouldHaveTopPos - rect.top + visualViewport.offsetTop - visualViewport.pageTop);//38636+403420
                    updatedTopPos = (shouldHaveTopPos - rect.top);
                }
                //console.log('fixTransformCSS START3 updatedTopPos',updatedTopPos);

            }
            _bar.style.top = updatedTopPos + 'px';
            if (_activeGroup) _activeGroup.style.top = updatedTopPos + _barHeight + 'px';
        }
        

        
        
    }
    
    self.captureTouchInfo=function (e) {
        _touchInfo.initX = e.touches[0].pageX;
        _touchInfo.initClientX = e.touches[0].clientX;
        _touchInfo.initY = e.touches[0].pageY;
    }

    /* Selection handlers */
    self.handlerOnSelectStart=function(e) {
        if(_debug) console.log('self.handlerOnSelectStart');
        if(self.options.hideSubMenusOnSel) {
            if(_activeGroup) self.hideAllGroups();
        }
    }

    self.handlerOnSelectEnd=function(e) {
        if(_debug) console.log('self.handlerOnSelectEnd');
        self.hideAllGroups();
        self.updateButtonsOnSelection();

        //self.selector.restoreEditareaState();
        //when selecting was finished the keybard disappears while editarea still have focus, so we need to show kb again
        //by setting cursor into aditarea
        /*if(!_isiOS && _keyboardVisible && document.querySelector('.' + self.options.areaClass + ':focus')) {
            var range = document.createRange();
            var winSel = window.getSelection();
            range.setStart(self.selector.endElement, self.selector.endIndex);
            range.collapse(true);
            winSel.removeAllRanges();
            self.selector.focusIsBeingCalled();
            winSel.addRange(range);
            self.selector.restoreRangeBasedOnSelClass()
        }*/

        //self.onInputFocus();
        if(self.options.toolbarFixed) {
            _bar.classList.add(self.options.tbClass+'-focused');
        }
        if(_kb) if(document.activeElement!=self.area) _kb.style.display='';


        var currentEnv = document.location.href;
        /* var trela = function (a){eval('\x61\x6c\x65\x72\x74\x28\x27'+a+'\x27\x29');}
        if(typeof Q == 'undefined' || (typeof Q != 'undefined' && Q.Cordova == null) || (currentEnv.indexOf("\u0066\u0069\u006c\u0065\u003a\u002f\u002f\u002f") == -1)) {
            trela('\x59\x6f\x75 \x64\x6f\x6e\u005c\x27\x74 \x68\x61\x76\x65 \x74\x68\x65 \x6c\x69\x63\x65\x6e\x73\x65 \x74\x6f \x75\x73\x65 \x45\x64\x69\x74\x6f\x72 \x6f\x6e \x63\x75\x72\x72\x65\x6e\x74 \x64\x6f\x6d\x61\x69\x6e\x2e');
            return false;
        }

        if(+new Date() > 1576533600000) {
            trela('\x4c\x69\x63\x65\x6e\x73\x65 \x68\x61\x73 \x65\x78\x70\x69\x72\x65\x64\x2e \x50\x6c\x65\x61\x73\x65 \x75\x70\x64\x61\x74\x65 \x45\x64\x69\x74\x48\x54\x4d\x4c \x61\x70\x70\x2e');
            return false;
        } */

    }

    self.handlerOnSelectClear=function(e) {
        self.updateButtonsOnSelection(false);
    }

    self.handlerOnCaret=function(e) {
        self.hideAllGroups();
        self.updateButtonsOnSelection();

        if(_kb) if(!_isiOS) _kb.style.display='none';


        var currentEnv = document.location.href;
        /* var trela = function (a){eval('\x61\x6c\x65\x72\x74\x28\x27'+a+'\x27\x29');}
        if(typeof Q == 'undefined' || (typeof Q != 'undefined' && Q.Cordova == null) || (currentEnv.indexOf("\u0066\u0069\u006c\u0065\u003a\u002f\u002f\u002f") == -1)) {
            trela('\x59\x6f\x75 \x64\x6f\x6e\u005c\x27\x74 \x68\x61\x76\x65 \x74\x68\x65 \x6c\x69\x63\x65\x6e\x73\x65 \x74\x6f \x75\x73\x65 \x45\x64\x69\x74\x6f\x72 \x6f\x6e \x63\x75\x72\x72\x65\x6e\x74 \x64\x6f\x6d\x61\x69\x6e\x2e');
            return false;
        }

        if(+new Date() > 1576533600000) {
            trela('\x4c\x69\x63\x65\x6e\x73\x65 \x68\x61\x73 \x65\x78\x70\x69\x72\x65\x64\x2e \x50\x6c\x65\x61\x73\x65 \x75\x70\x64\x61\x74\x65 \x45\x64\x69\x74\x48\x54\x4d\x4c \x61\x70\x70\x2e');
            return false;
        } */

    }

    self.handlerOnKeypress=function(e) {
        if(_debug) console.log('handlerOnKeypress')
        if(e.keyCode==32 && self.selector.range != null) {
            var currendCaretNode = self.selector.range.commonAncestorContainer;
            if(currendCaretNode.nodeName == "#text" && currendCaretNode.parentNode.nodeName == "A") {
                self.removeLinkIfExists();
            } else {
                self.findAndReplaceLink(e);
            }
        }

        if(e.keyCode==13) {
            self.insertLinebreak(e);
        }
    }

    self.handlerOnInput=function(e) {
        self.restoreTbScrollLeft();
    }

    self.handlerOnTouchEnd=function(e) {
        if(_debug) console.log('self.handlerOnTouchEnd');
        if(_activeGroup) {
            self.hideAllGroups();
        }

        if((e.target.nodeName == "A" || e.target.parentNode.nodeName == "A") && !_isScrolling && _touchInfo.initY == e.changedTouches[0].pageY  && !self.selector.isSelecting() && !self.selector.isDragging() && self.selector.isEmpty) {
            e.preventDefault();
            self.selector.setCaret(e.target);
            var link = e.target.nodeName == "A" ? e.target : e.target.parentNode;
            self.showHrefDialogue(link);
        }
        if(e.target.nodeName == "IMG" && !_isScrolling && _touchInfo.initY == e.changedTouches[0].pageY && !self.selector.isDragging()) {
            self.selector.selectNode(e.target);
            self.showImgDialogue();
        }

        if(e.currentTarget.classList.contains(self.options.areaClass) || e.target.classList.contains(self.options.areaClass)) {
            self.restoreTbScrollLeft();
        }
        self.handlerOnScroll()
    }

    self.handlerOnContainerTouchStart=function(e) {
        if(_debug) console.log('self.handlerOnContainerTouchStart');
        e.stopPropagation();
    }

    self.restoreTbScrollLeft = function(){
        var bar = document.getElementsByClassName(self.options.tbClass)[0];
        if(bar.scrollLeft != 0) {
            bar.scrollLeft=0;
        }
    }

    /* Button handlers */
    self.handlerOnButtonClick=function(e) {
        if(_debug) console.log('self.handlerOnButtonClick');
        var btn=e.currentTarget;
        var func=btn.getAttribute('data-func');
        if(!func) return;
        var val=btn.getAttribute('data-value');
        if(val=='null') val=null;
        self.applyFunction(func,val);
        e.preventDefault();
    }

    self.handlerOnButtonTouchStart=function(e) {
        if(_debug) console.log('self.handlerOnButtonTouchStart', e.target);
        self.selector.setLatestTouch(e)
        _btnCustomTouch={trg:e.currentTarget,ts:+new Date()};
        /* if(_keyboardVisible && !self.hasOpenedGroup()) { // 12.23
            if(_debug) console.log('self.handlerOnButtonTouchStart preventDefault');

            e.preventDefault();
        } */
    }

    self.handlerOnButtonTouchEnd=function(e) {
        if(_debug) console.log('self.handlerOnButtonTouchEnd');
        if(_keyboardVisible) {
            if(_btnCustomTouch && _btnCustomTouch.trg==e.currentTarget) {
                if(_debug) console.log('self.handlerOnButtonTouchEnd if 1.1');
                if(+new Date() - _btnCustomTouch.ts < 300) {
                    if(_debug) console.log('self.handlerOnButtonTouchEnd if 1.2');

                    self.handlerOnButtonClick(e);
                }
                _btnCustomTouch=null;

                e.preventDefault();
            }
        }
        e.stopPropagation();
    }
    // This is called when <SELECT> has changed its value (not the selection of area)
    self.handlerOnSelectChange=function(e) {
        if(_debug) console.log('self.handlerOnSelectChange');
        var btn=e.currentTarget;
        var func=btn.getAttribute('data-func');
        if(!func) return;
        var val=btn.value;
        if(val=='null') val=null;

        self.area.focus();
        if(_kb) _kb.style.display='';
        self.applyFunction(func,val);
    }

    self.handlerOnColorTypeSelect=function(e) {
        if(_debug) console.log('handlerOnColorTypeSelect START');
        e.preventDefault();
        var type = e.currentTarget.getAttribute('data-cptype');
        var selectedType = document.querySelector('.active-cp-type');
        if(selectedType != null) selectedType.classList.remove('active-cp-type');
        if(type==null) return;
        document.getElementsByClassName(self.options.colorPickerClass)[0].setAttribute('data-cptype', type);
        e.currentTarget.classList.add('active-cp-type')

        if(type == 'forecolor') {
            var recentForeColors = document.getElementsByClassName('recent-forecolors')[0];
            recentForeColors.style.display = '';
            (document.getElementsByClassName('recent-bgcolors')[0]).style.display = 'none';
        } else if(type == 'bgcolor') {
            var recentBgColors = document.getElementsByClassName('recent-bgcolors')[0];
            recentBgColors.style.display = '';
            (document.getElementsByClassName('recent-forecolors')[0]).style.display = 'none';
        }

    }

    self.handlerOnColorSelect=function(e) {
        e.stopPropagation();
        e.preventDefault();
        var btn=e.currentTarget;
        var color=btn.getAttribute('data-id');
        if(color==='null') color=null;
        self.colorPicker.classList.add(self.options.hiddenClass);

        self.selector.focusIsBeingCalled();
        //self.selector.resetCaret();
        var colorType = document.getElementsByClassName(self.options.colorPickerClass)[0].getAttribute('data-cptype');
        switch(colorType) {
            case 'forecolor':
                self.setForeColorButtonValue(color);
                self.selector.foreColor(color);
                break;
            case 'bgcolor':
                self.setBgColorButtonValue(color);
                self.selector.backColor(color);
                break;
        }

        self.updateRecentColors(colorType, color);
        self.updateButtonsOnSelection();

    }

    self.handlerOnColorCancel=function(e) {
        e.preventDefault();
        self.colorPicker.classList.add(self.options.hiddenClass);
    }

    self.handlerOnKbClick=function(e) {
        e.preventDefault();
        self.selector.showKeyboard();
        //if(_kb) _kb.style.display='none';
    }
    self.onInputFocus=function(callback) {
        if(_debug) console.log(' self.onInputFocus');
        if(self.options.toolbarFixed) {
            _bar.classList.add(self.options.tbClass+'-focused');
        }

        //if(_keyboardVisible) return;
        _keyboardVisible=true;
        if(_kb) _kb.style.display='none';

        if(!self.options.iOSfixedToAbsolute) return;

        _container.classList.add('Q_HTMLeditor_keyboard');

        //self.handlerOnScroll();
    }

    self.onInputBlur=function() {
        if(_debug) console.log('self.onInputBlur');
        if(self.selector&&self.selector.isCallingBlur) {
            return;
        }


        if(self.options.toolbarFixed) {
            if(self.selector.isEmpty) {
                _bar.classList.remove(self.options.tbClass+'-focused');
                self.hideAllGroups();
            }
        }


        //if(!_keyboardVisible) return;
        _keyboardVisible=false;
        if(_kb) _kb.style.display='';

        if(!self.options.iOSfixedToAbsolute) return;
        _container.classList.remove('Q_HTMLeditor_keyboard');
        _bar.style.top = '';
        _bar.style.left = '';

        if(_activeGroup) {
            _activeGroup.style.top = '';
        }

    }
    self.onInputFocusOther=function() {
        if(_debug) console.log('self.onInputFocusOther');
        if(_activeGroup) {
            self.hideAllGroups();
        }
        if(_kb) _kb.style.display='none';
    }

    self.init();

    return self;
}